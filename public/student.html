<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì˜¤ëŠ˜ì˜ ì—ì´ìŠ¤ëŠ”? - í•™ìƒ í˜ì´ì§€</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Arial',sans-serif;background-color:#fff8f0;min-height:100vh;display:flex}
    /* ì¢Œì¸¡ ì‚¬ì´ë“œë°” */
    .sidebar{width:200px;background:#fff;border-right:3px solid #ffe0b3;padding:20px;box-shadow:3px 0 10px rgba(255,217,61,.1)}
    .sidebar-header{text-align:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #fff5e6}
    .sidebar-header h2{color:#2d3748;font-size:16px;font-weight:700;margin-bottom:5px}
    .sidebar-header p{color:#4a5568;font-size:11px}
    .menu-item{display:block;width:100%;padding:12px 15px;margin-bottom:8px;background:#fff5e6;border:2px solid #ffe0b3;border-radius:10px;color:#2d3748;text-decoration:none;font-weight:600;text-align:center;font-size:12px;cursor:pointer;transition:.2s}
    .menu-item.active{background:#ffd93d}
    .menu-item:hover{background:#ffd93d;transform:translateY(-1px)}
    .logout-btn{margin-top:20px;padding:8px 12px;background:#ffb3b3;border:2px solid #ff9999;border-radius:8px;color:#2d3748;font-weight:600;cursor:pointer;width:100%;font-size:11px}
    .logout-btn:hover{background:#ff9999}
    /* ë©”ì¸ ì½˜í…ì¸  */
    .main-content{flex:1;padding:25px;overflow-y:auto}
    .page-header{text-align:center;margin-bottom:25px}
    .page-header h1{color:#2d3748;font-size:26px;font-weight:700;margin-bottom:8px}
    .page-header p{color:#4a5568;font-size:15px}
    /* ë™ë£Œí‰ê°€ */
    .peer-section{background:#fffbf5;border:3px solid #ffe0b3;border-radius:15px;padding:25px;margin-bottom:25px}
    .section-title{color:#2d3748;font-size:18px;font-weight:700;text-align:center;margin-bottom:8px}
    .section-description{color:#666;font-size:12px;text-align:center;margin-bottom:20px;line-height:1.4}
    .peer-grid{display:grid;grid-template-columns:1fr 1fr 1fr;grid-template-rows:auto auto;gap:15px;max-width:900px;margin:0 auto}
    .peer-item{background:#fff;border:2px solid #ffd93d;border-radius:10px;padding:15px;height:140px;display:flex;flex-direction:column}
    .peer-label{color:#2d3748;font-size:13px;font-weight:600;margin-bottom:8px;text-align:center;flex-shrink:0}
    .peer-input{width:100%;padding:8px 10px;border:2px solid #ffd93d;border-radius:6px;font-size:13px;margin-bottom:6px;background:#fff;flex-shrink:0}
    .peer-input:focus{outline:none;border-color:#ffb700;box-shadow:0 0 0 2px rgba(255,217,61,.2)}
    .peer-reason{width:100%;padding:8px 10px;border:2px solid #e0e0e0;border-radius:6px;font-size:12px;background:#fafafa;flex:1;resize:none;display:none}
    .peer-reason.visible{display:block}
    .peer-reason:focus{outline:none;border-color:#c77dff;background:#fff}
    /* ìê¸°í‰ê°€ */
    .self-section{background:#faf7ff;border:3px solid #e0c4ff;border-radius:15px;padding:25px}
    .self-title{color:#2d3748;font-size:16px;font-weight:600;text-align:center;margin-bottom:18px}
    .self-options{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;max-width:700px;margin-left:auto;margin-right:auto}
    .self-option{position:relative}
    .self-option input[type=radio]{display:none}
    .self-option label{display:block;padding:12px 8px;background:#f8f0ff;border:2px solid #e0c4ff;border-radius:10px;color:#2d3748;font-weight:500;cursor:pointer;text-align:center;font-size:12px;transition:.2s}
    .self-option input[type=radio]:checked+label{background:#c77dff;color:#fff;transform:scale(1.02)}
    .self-option label:hover{transform:translateY(-1px);box-shadow:0 3px 8px rgba(199,125,255,.2)}
    .self-reason{width:100%;max-width:700px;margin:0 auto;display:block;padding:12px;border:2px solid #c77dff;border-radius:10px;font-size:13px;min-height:60px;resize:vertical;background:#fff}
    .self-reason:focus{outline:none;border-color:#a855f7;box-shadow:0 0 0 2px rgba(199,125,255,.2)}
    /* ì €ì¥ ë²„íŠ¼ */
    .save-section{text-align:center;margin-top:25px}
    .save-button{background:#ffd93d;color:#2d3748;border:none;padding:15px 35px;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;transition:.3s}
    .save-button:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(255,217,61,.4);background:#ffb700}
    /* ë°˜ì‘í˜• */
    @media (max-width:1000px){.peer-grid{grid-template-columns:1fr 1fr;grid-template-rows:auto auto auto}}
    @media (max-width:768px){
      body{flex-direction:column}
      .sidebar{width:100%;padding:15px}
      .main-content{padding:20px}
      .peer-grid{grid-template-columns:1fr;grid-template-rows:auto}
      .self-options{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:480px){.self-options{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>ğŸŒŸ í•™ìƒ ë©”ë‰´</h2>
      <p id="greet">ì•ˆë…•í•˜ì„¸ìš”!</p>
    </div>

    <button class="menu-item active" onclick="showInputPage(this)">ğŸ“ ì…ë ¥ í˜ì´ì§€</button>
    <button class="menu-item" onclick="showStatsPage(this)">ğŸ“Š í†µê³„ í˜ì´ì§€</button>
    <button class="logout-btn" onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <!-- ë©”ì¸ ì½˜í…ì¸  -->
  <div class="main-content">
    <div class="page-header">
      <h1>ğŸŒŸ ì˜¤ëŠ˜ì˜ ì—ì´ìŠ¤ëŠ”?</h1>
      <p>ì¹œêµ¬ë“¤ê³¼ ë‚˜ ìì‹ ì„ ë”°ëœ»í•œ ë§ˆìŒìœ¼ë¡œ í‰ê°€í•´ë³´ì„¸ìš”</p>
    </div>

    <!-- ë™ë£Œí‰ê°€ ì„¹ì…˜ -->
    <div class="peer-section">
      <h3 class="section-title">ğŸ‘¥ ë™ë£Œ í‰ê°€</h3>
      <p class="section-description">ë‹¤ìŒ ì—ì´ìŠ¤ì— ê°€ì¥ ê°€ê¹ë‹¤ê³  ìƒê°í•˜ëŠ” íŒ€ì›ì„ ë½‘ì•„ì£¼ì„¸ìš”.<br>(íŒ€ì› ëª¨ë‘ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤. ê° ì—ì´ìŠ¤ë‹¹ í•œ ëª…ë§Œ ì¶”ì²œí•©ë‹ˆë‹¤, ìê¸°ëŠ” ì œì™¸í•©ë‹ˆë‹¤)</p>

      <div class="peer-grid">
        <div class="peer-item">
          <div class="peer-label">ğŸ¦ ìì‹ ê°ê³¼ ë¦¬ë”ì‹­</div>
          <input type="text" class="peer-input" placeholder="ì¹œêµ¬ ì´ë¦„" oninput="toggleReason(this,'reason1')">
          <textarea class="peer-reason" id="reason1" placeholder="ì–´ë–¤ ë©´ì—ì„œ?"></textarea>
        </div>

        <div class="peer-item">
          <div class="peer-label">ğŸ” ë¶„ì„</div>
          <input type="text" class="peer-input" placeholder="ì¹œêµ¬ ì´ë¦„" oninput="toggleReason(this,'reason2')">
          <textarea class="peer-reason" id="reason2" placeholder="ì–´ë–¤ ë©´ì—ì„œ?"></textarea>
        </div>

        <div class="peer-item">
          <div class="peer-label">ğŸ’¡ ì•„ì´ë””ì–´ ë±…í¬</div>
          <input type="text" class="peer-input" placeholder="ì¹œêµ¬ ì´ë¦„" oninput="toggleReason(this,'reason3')">
          <textarea class="peer-reason" id="reason3" placeholder="ì–´ë–¤ ë©´ì—ì„œ?"></textarea>
        </div>

        <div class="peer-item">
          <div class="peer-label">ğŸ’– ê°ì • ì´í•´</div>
          <input type="text" class="peer-input" placeholder="ì¹œêµ¬ ì´ë¦„" oninput="toggleReason(this,'reason4')">
          <textarea class="peer-reason" id="reason4" placeholder="ì–´ë–¤ ë©´ì—ì„œ?"></textarea>
        </div>

        <div class="peer-item">
          <div class="peer-label">ğŸ’¬ ì˜ì‚¬ì†Œí†µ</div>
          <input type="text" class="peer-input" placeholder="ì¹œêµ¬ ì´ë¦„" oninput="toggleReason(this,'reason5')">
          <textarea class="peer-reason" id="reason5" placeholder="ì–´ë–¤ ë©´ì—ì„œ?"></textarea>
        </div>

        <div class="peer-item">
          <div class="peer-label">ğŸ¤ í˜‘ë™ì‹¬</div>
          <input type="text" class="peer-input" placeholder="ì¹œêµ¬ ì´ë¦„" oninput="toggleReason(this,'reason6')">
          <textarea class="peer-reason" id="reason6" placeholder="ì–´ë–¤ ë©´ì—ì„œ?"></textarea>
        </div>
      </div>
    </div>

    <!-- ìê¸°í‰ê°€ ì„¹ì…˜ -->
    <div class="self-section">
      <h3 class="section-title">ğŸŒŸ ìê¸° í‰ê°€</h3>
      <p class="section-description">ì˜¤ëŠ˜ ë‚˜ëŠ” ì–´ë–¤ ì—ì´ìŠ¤ì˜€ëŠ”ì§€ í´ë¦­ í›„ ê·¸ ì´ìœ ë¥¼ ì ì–´ì£¼ì„¸ìš”.</p>

      <div class="self-title">ë‚˜ëŠ” ì˜¤ëŠ˜ <strong>____</strong> ì—ì´ìŠ¤ë‹¤!</div>

      <div class="self-options">
        <div class="self-option">
          <input type="radio" id="self1" name="self-competency" value="ìì‹ ê°ê³¼ ë¦¬ë”ì‹­">
          <label for="self1">ğŸ¦ ìì‹ ê°ê³¼ ë¦¬ë”ì‹­</label>
        </div>
        <div class="self-option">
          <input type="radio" id="self2" name="self-competency" value="ë¶„ì„">
          <label for="self2">ğŸ” ë¶„ì„</label>
        </div>
        <div class="self-option">
          <input type="radio" id="self3" name="self-competency" value="ì•„ì´ë””ì–´ ë±…í¬">
          <label for="self3">ğŸ’¡ ì•„ì´ë””ì–´ ë±…í¬</label>
        </div>
        <div class="self-option">
          <input type="radio" id="self4" name="self-competency" value="ê°ì • ì´í•´">
          <label for="self4">ğŸ’– ê°ì • ì´í•´</label>
        </div>
        <div class="self-option">
          <input type="radio" id="self5" name="self-competency" value="ì˜ì‚¬ì†Œí†µ">
          <label for="self5">ğŸ’¬ ì˜ì‚¬ì†Œí†µ</label>
        </div>
        <div class="self-option">
          <input type="radio" id="self6" name="self-competency" value="í˜‘ë™ì‹¬">
          <label for="self6">ğŸ¤ í˜‘ë™ì‹¬</label>
        </div>
      </div>

      <textarea class="self-reason" id="self-reason" placeholder="ì™œ ê·¸ë ‡ê²Œ ìƒê°í•˜ëŠ”ì§€ ì´ìœ ë¥¼ ì ì–´ì£¼ì„¸ìš”..."></textarea>
    </div>

    <!-- ì €ì¥ ë²„íŠ¼ -->
    <div class="save-section">
      <button class="save-button" onclick="saveData()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
      <div id="message" style="margin-top:15px;color:#2d3748;font-weight:600;"></div>
    </div>
  </div>

  <script>
    // ====== ë¡œê·¸ì¸ ì •ë³´ ë¡œë“œ & ì¸ì‚¬ ======
    const ss = window.sessionStorage;
    let CURRENT = { username: '', name: '' };

    async function loadStudentIdentity(){
      // 1) ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ íŒíŠ¸ ì‚¬ìš©(ë¡œê·¸ì¸ ì§í›„ ì €ì¥í•´ë‘” ê°’)
      const hintName = ss.getItem('studentName') || '';
      const hintUser = ss.getItem('studentUsername') || ss.getItem('username') || '';
      CURRENT.name = hintName || '';
      CURRENT.username = hintUser || '';

      // 2) ì„œë²„ ì„¸ì…˜ í™•ì¸
      try{
        const r = await fetch('/api/auth/whoami', { credentials:'include', cache:'no-store' });
        if (r.ok) {
          const j = await r.json();
          if (j && j.role === 'student') {
            CURRENT.name = j.name || CURRENT.name || '';
            CURRENT.username = j.username || CURRENT.username || '';
          }
        }
      }catch(_){}

      // 3) UI ì ìš©
      const greet = document.getElementById('greet');
      if (greet) greet.textContent = `${(CURRENT.name || CURRENT.username || 'í•™ìƒ')}ë‹˜, ì•ˆë…•í•˜ì„¸ìš”!`;
    }

    document.addEventListener('DOMContentLoaded', loadStudentIdentity);

    // ===== UI ìœ í‹¸ =====
    function toggleReason(input, reasonId){
      const reason = document.getElementById(reasonId);
      if (input.value.trim() !== '') {
        reason.classList.add('visible');
        reason.style.display = 'block';
      } else {
        reason.classList.remove('visible');
        reason.style.display = 'none';
        reason.value = '';
      }
    }

    function showInputPage(el){
      document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
      if (el) el.classList.add('active');
      document.getElementById('message').textContent = 'ì…ë ¥ í˜ì´ì§€ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.';
    }

    function showStatsPage(el){
      document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
      if (el) el.classList.add('active');
      window.location.href = 'student-stats.html';
    }

    function logout(){
      if (confirm('ì •ë§ë¡œ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        sessionStorage.clear();
        window.location.href = 'index.html';
      }
    }

    // ===== ì €ì¥ ë¡œì§ (ì„œë²„ â†’ ì‹¤íŒ¨ ì‹œ ë¡œì»¬ í´ë°±) =====
    async function saveData(){
      const msg = document.getElementById('message');
      msg.style.color = '#2d3748';
      msg.textContent = 'ì €ì¥ ì¤‘â€¦';

      // 1) ë™ë£Œí‰ê°€ ìˆ˜ì§‘
      const peerData = [];
      for (let i=1;i<=6;i++){
        const item = document.querySelector(`.peer-item:nth-child(${i})`);
        if (!item) continue;
        const label = item.querySelector('.peer-label')?.textContent || '';
        const name  = item.querySelector('.peer-input')?.value.trim() || '';
        const reason= document.getElementById(`reason${i}`)?.value.trim() || '';
        if (name){
          peerData.push({
            competency: label.replace(/[ğŸ¦ğŸ”ğŸ’¡ğŸ’–ğŸ’¬ğŸ¤]/g,'').trim(),
            name, reason
          });
        }
      }

      // 2) ìê¸°í‰ê°€ ìˆ˜ì§‘
      const selfRadio  = document.querySelector('input[name="self-competency"]:checked');
      const selfReason = document.getElementById('self-reason').value.trim();
      let selfEvaluation = null;
      if (selfRadio){
        if (!selfReason){
          msg.style.color = '#c53030';
          msg.textContent = 'ìê¸°í‰ê°€ ì´ìœ ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”!';
          return;
        }
        selfEvaluation = { competency: selfRadio.value, reason: selfReason };
      }

      // 3) ìµœì†Œ ì…ë ¥ ê²€ì¦
      if (peerData.length===0 && !selfEvaluation){
        msg.style.color = '#c53030';
        msg.textContent = 'ë™ë£Œí‰ê°€ë‚˜ ìê¸°í‰ê°€ ì¤‘ í•˜ë‚˜ëŠ” ë°˜ë“œì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”!';
        return;
      }

      // 4) ì„œë²„ ì €ì¥
      const payload = {
        evaluatorUsername: CURRENT.username || ss.getItem('username') || '',
        peerEvaluations: peerData,
        selfEvaluation,
        date: new Date().toISOString().split('T')[0]
      };

      try{
        const res = await fetch('/api/save-evaluation', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        if (!res.ok || !json?.success) throw new Error(json?.error || 'ì €ì¥ ì‹¤íŒ¨');

        msg.style.color = '#22543d';
        msg.textContent = 'í‰ê°€ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰';
        setTimeout(()=>{ resetForm(); msg.textContent=''; }, 2500);

      }catch(e){
        console.warn('API ì €ì¥ ì‹¤íŒ¨, ë¡œì»¬ í´ë°±:', e?.message || e);

        // í´ë°±: localStorage
        const evaluationData = {
          id: Date.now(),
          date: new Date().toISOString().split('T')[0],
          timestamp: new Date().toISOString(),
          student: CURRENT.name || CURRENT.username || 'í•™ìƒ',
          peerEvaluations: peerData,
          selfEvaluation
        };
        try{
          const existing = JSON.parse(localStorage.getItem('evaluationHistory') || '[]');
          existing.push(evaluationData);
          if (existing.length > 200) existing.splice(0, existing.length-200);
          localStorage.setItem('evaluationHistory', JSON.stringify(existing));
          localStorage.setItem('lastEvaluation', JSON.stringify(evaluationData));

          msg.style.color = '#22543d';
          msg.textContent = 'ë„¤íŠ¸ì›Œí¬ ë¬¸ì œë¡œ ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ë¡œì»¬) âœ…';
          setTimeout(()=>{ resetForm(); msg.textContent=''; }, 2500);
        }catch(_){
          msg.style.color = '#c53030';
          msg.textContent = 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        }
      }
    }

    function resetForm(){
      document.querySelectorAll('.peer-input').forEach(i=>i.value='');
      document.querySelectorAll('.peer-reason').forEach(r=>{ r.style.display='none'; r.value=''; });
      document.querySelectorAll('input[name="self-competency"]').forEach(r=>r.checked=false);
      document.getElementById('self-reason').value='';
    }
  </script>
</body>
</html>
