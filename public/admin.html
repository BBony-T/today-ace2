<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>오늘의 에이스는? - 관리자</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* ====== 기존 스타일 유지 ====== */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Arial',sans-serif;background-color:#fff8f0;min-height:100vh;display:flex}
    .sidebar{width:220px;background:#fff;border-right:3px solid #ffe0b3;padding:20px;box-shadow:3px 0 10px rgba(255,217,61,.1)}
    .sidebar-header{text-align:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #fff5e6}
    .sidebar-header h2{color:#2d3748;font-size:16px;font-weight:700;margin-bottom:5px}
    .sidebar-header p{color:#4a5568;font-size:11px}
    .menu-item{display:block;width:100%;padding:12px 15px;margin-bottom:8px;background:#fff5e6;border:2px solid #ffe0b3;border-radius:10px;color:#2d3748;text-decoration:none;font-weight:600;text-align:center;font-size:12px;cursor:pointer;transition:.2s}
    .menu-item.active,.menu-item:hover{background:#ffd93d;transform:translateY(-1px)}
    .logout-btn{margin-top:20px;padding:8px 12px;background:#ffb3b3;border:2px solid #ff9999;border-radius:8px;color:#2d3748;font-weight:600;cursor:pointer;width:100%;font-size:11px}
    .main-content{flex:1;padding:25px;overflow-y:auto}
    .page-header{text-align:center;margin-bottom:25px}
    .page-header h1{color:#2d3748;font-size:26px;font-weight:700;margin-bottom:8px}
    .page-header p{color:#4a5568;font-size:15px}
    .page-content{display:none}.page-content.active{display:block}
    .card{background:#fff;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,.05)}
    .card.orange{border:3px solid #ffe0b3;background:#fffbf5}
    .card.purple{border:3px solid #e0c4ff;background:#faf7ff}
    .card h3{color:#2d3748;margin-bottom:15px;font-size:16px;text-align:center}
    .class-selector{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
    .class-selector select,.class-selector input{padding:8px 12px;border:2px solid #ffd93d;border-radius:8px;font-size:14px;background:#fff}
    .class-selector button{background:#ffd93d;color:#2d3748;border:none;padding:8px 15px;border-radius:8px;font-weight:600;cursor:pointer;transition:.2s}
    .class-selector button:hover{background:#ffb700;transform:translateY(-1px)}
    .student-status-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-bottom:20px}
    .student-card{background:#fff;border:2px solid #e2e8f0;border-radius:10px;padding:15px;text-align:center;transition:.2s}
    .student-card.completed{border-color:#68d391;background:#f0fff4}
    .student-card.pending{border-color:#fed7af;background:#fffaf0}
    .student-card.not-started{border-color:#feb2b2;background:#fef5f5}
    .student-name{font-weight:700;color:#2d3748;margin-bottom:5px}
    .student-status{font-size:12px;padding:4px 8px;border-radius:12px;color:#fff}
    .status-completed{background:#48bb78}.status-pending{background:#ed8936}.status-not-started{background:#e53e3e}
    .roster-management{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
    .file-upload{border:2px dashed #ffd93d;border-radius:10px;padding:20px;text-align:center;cursor:pointer;transition:.2s}
    .file-upload:hover{border-color:#ffb700;background:#fffbf5}
    .file-upload input{display:none}
    .stats-controls{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px}
    .stats-results{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .student-detail{border:1px solid #e2e8f0;border-radius:8px;margin-bottom:10px;overflow:hidden}
    .student-header{background:#f7fafc;padding:10px 15px;font-weight:700;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
    .student-content{padding:15px;display:none}.student-content.expanded{display:block}
    .competency-stat{display:flex;justify-content:space-between;margin-bottom:8px;padding:5px 10px;background:#f8f9fa;border-radius:5px}
    .download-btn{background:#c77dff;color:#fff;border:none;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;transition:.2s}
    .download-btn:hover{background:#a855f7;transform:translateY(-1px)}
    @media (max-width:1000px){.roster-management{grid-template-columns:1fr}.stats-controls{grid-template-columns:repeat(2,1fr)}.stats-results{grid-template-columns:1fr}}
    @media (max-width:768px){body{flex-direction:column}.sidebar{width:100%;padding:15px}.main-content{padding:20px}.class-selector{flex-direction:column;align-items:stretch}.stats-controls{grid-template-columns:1fr}.student-status-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}}
    .success-message{background:#e6fffa;color:#234e52;padding:10px 15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #81e6d9}
    .error-message{background:#ffe6e6;color:#c53030;padding:10px 15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #fc8181}

    /* ====== 저장된 명부 카드 ====== */
    .roster-item{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid #f0f0f0;border-radius:12px;margin:8px 0;background:#fff}
    .roster-main{flex:1}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid #ffe0b3;background:#fff5e6;margin-left:6px}
    .tiny-btn{border:none;border-radius:6px;padding:6px 10px;font-size:12px;cursor:pointer}
    .btn-danger{background:#e53e3e;color:#fff}
    .btn-danger:hover{filter:brightness(0.95)}
    .tiny-check{display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer}
  </style>
</head>
<body>
  <!-- 사이드바 -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>👨‍🏫 관리자 메뉴</h2>
      <p>선생님, 안녕하세요!</p>
    </div>
    <button class="menu-item active" onclick="showPage('status')">📋 현황 페이지</button>
    <button class="menu-item" onclick="showPage('statistics')">📊 통계 페이지</button>
    <button class="logout-btn" onclick="logout()">🚪 로그아웃</button>
  </div>

  <!-- 메인 -->
  <div class="main-content">
    <div class="page-header">
      <h1>🎯 관리자 대시보드</h1>
      <p>학생들의 평가 현황과 통계를 관리하세요</p>
    </div>

    <!-- 현황 페이지 -->
    <div id="statusPage" class="page-content active">
      <div class="card orange">
        <h3>🏫 클래스 관리</h3>
        <div class="class-selector" style="justify-content:center;gap:12px;">
          <button onclick="showRosterModal()" style="background:#c77dff;color:#fff">명부 업로드</button>
          <button onclick="downloadTemplate()">양식 다운로드 (CSV)</button>
        </div>
      </div>

      <div id="classInfo" style="text-align:center;color:#666;margin-bottom:15px;">현재 조회: 전체</div>

      <!-- 저장된 명부 -->
      <div class="card orange" id="rosterListCard">
        <h3>📚 저장된 명부</h3>
        <p id="saved-roster-empty" style="text-align:center;color:#888">저장된 명부가 없습니다. 먼저 업로드 해 주세요.</p>
        <div id="rosterList" style="font-size:13px;color:#2d3748;"></div>
      </div>

      <!-- 학생 현황판 -->
      <div class="card purple">
        <h3>👥 학생 현황판</h3>
        <div id="studentStatusGrid" class="student-status-grid">
          <div style="grid-column:1/-1;text-align:center;color:#666;padding:20px;">
            클래스를 선택하고 조회 버튼을 눌러주세요.
          </div>
        </div>
        <div style="text-align:center;margin-top:15px;">
          <span style="margin-right:20px;">
            <span class="student-status status-completed">완료</span>
            <span id="completedCount" style="margin-left:5px;font-size:14px;">0명</span>
          </span>
          <span style="margin-right:20px;">
            <span class="student-status status-pending">부분완료</span>
            <span id="pendingCount" style="margin-left:5px;font-size:14px;">0명</span>
          </span>
          <span>
            <span class="student-status status-not-started">미시작</span>
            <span id="notStartedCount" style="margin-left:5px;font-size:14px;">0명</span>
          </span>
        </div>
      </div>
    </div>

    <!-- 통계 페이지 (요약만, 나머지는 기존과 동일) -->
    <div id="statisticsPage" class="page-content">
      <div class="card orange">
        <h3>📈 통계 조회</h3>
        <div class="stats-controls">
          <select id="statsYear"><option value="2024">2024년</option><option value="2025" selected>2025년</option></select>
          <select id="statsSubject"><option value="">전체 과목</option><option>국어</option><option>수학</option><option>영어</option></select>
          <select id="statsClub"><option value="">전체 동아리</option><option>코딩클럽</option><option>독서토론</option></select>
          <div style="display:flex;gap:10px;align-items:center;">
            <input type="date" id="startDate" style="padding:8px;border:2px solid #c77dff;border-radius:8px;">
            <span>~</span>
            <input type="date" id="endDate" style="padding:8px;border:2px solid #c77dff;border-radius:8px;">
          </div>
        </div>
        <div style="text-align:center;margin-top:10px;">
          <button onclick="loadStatistics()" style="background:#c77dff;color:#fff;border:none;padding:10px 20px;border-radius:8px;font-weight:600;">통계 조회</button>
        </div>
      </div>

      <div class="stats-results">
        <div class="card purple">
          <h3>📊 개인별 통계</h3>
          <div style="margin-bottom:15px;text-align:right;">
            <button class="download-btn" onclick="downloadExcel()">📥 엑셀 다운로드</button>
          </div>
          <div id="statisticsResults">
            <div style="text-align:center;color:#666;padding:20px;">통계 조회 버튼을 눌러주세요.</div>
          </div>
        </div>

        <div class="card orange">
          <h3>📈 전체 요약</h3>
          <div id="summaryStats">
            <div style="text-align:center;color:#666;padding:20px;">통계 데이터를 불러오는 중...</div>
          </div>

          <!-- 활동 정보 관리 (기존) -->
          <div style="margin-top:20px;padding-top:20px;border-top:2px solid #fff5e6;">
            <h4 style="text-align:center;margin-bottom:15px;color:#2d3748;">📝 활동 정보 관리</h4>
            <div style="display:flex;gap:10px;margin-bottom:15px;">
              <input type="date" id="activityDate" style="flex:1;padding:8px;border:2px solid #ffd93d;border-radius:8px;">
              <input type="text" id="activityName" placeholder="활동명 (예: 모둠 토론)" style="flex:2;padding:8px;border:2px solid #ffd93d;border-radius:8px;">
              <button onclick="addActivityInfo()" style="background:#ffd93d;color:#2d3748;border:none;padding:8px 15px;border-radius:8px;font-weight:600;white-space:nowrap;">추가</button>
            </div>
            <div id="activityList" style="max-height:150px;overflow-y:auto;"></div>
            <div style="text-align:center;margin-top:10px;">
              <button onclick="clearAllActivities()" style="background:#e53e3e;color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:12px;">전체 삭제</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 명부 업로드 모달 -->
  <div id="rosterModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:28px;border-radius:16px;width:min(560px,92%);">
      <h3 style="margin-bottom:16px;text-align:center;">📋 명부 업로드</h3>

      <div style="display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center;margin-bottom:14px;">
        <div style="font-weight:600;">카테고리 종류</div>
        <div>
          <label style="margin-right:12px;"><input type="radio" name="catType" value="subject" checked> 과목</label>
          <label><input type="radio" name="catType" value="club"> 동아리</label>
        </div>
        <div style="font-weight:600;">카테고리 이름</div>
        <div><input id="categoryName" placeholder="예) 국어 / 코딩클럽" style="width:100%;padding:8px 10px;border:2px solid #ffd93d;border-radius:8px;"></div>
      </div>

      <div class="file-upload" onclick="document.getElementById('csvFile').click()">
        <input type="file" id="csvFile" accept=".csv,.xlsx,.xls" onchange="handleFileUpload(event)">
        <div>📁 CSV 또는 Excel 파일을 선택하세요</div>
        <div style="font-size:12px;color:#666;margin-top:5px;">형식: <strong>이름, 학번</strong> (카테고리는 위에서 미리 지정)</div>
        <div style="text-align:center;margin-top:10px;">
          <button type="button" onclick="downloadTemplate()" style="background:#ffd93d;color:#2d3748;border:none;padding:8px 14px;border-radius:8px;font-weight:600;">📥 양식 다운로드</button>
        </div>
      </div>

      <div id="rosterPreview" style="margin-top:12px;max-height:180px;overflow:auto;border:1px dashed #eee;border-radius:8px;padding:8px;font-size:13px;color:#2d3748;">
        파일을 선택하면 미리보기가 여기에 표시됩니다.
      </div>

      <div style="margin-top:12px;text-align:right;">
        <button id="btnSaveRoster" type="button" onclick="saveRoster()" style="background:#5c7cfa;color:#fff;border:none;padding:8px 14px;border-radius:8px;font-weight:600;" disabled>저장</button>
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:18px;">
        <button onclick="clearAllData()" style="background:#e53e3e;color:#fff;border:none;padding:8px 14px;border-radius:8px;">🗑️ 전체 초기화</button>
        <button onclick="closeRosterModal()" style="background:#4a5568;color:#fff;border:none;padding:8px 14px;border-radius:8px;">닫기</button>
      </div>
    </div>
  </div>

  <script>
    // ▼ 전역 선택 상태 (가장 위에 두기)
    let SELECTED_ROSTER_ID = null;
    let SELECTED_ROSTER_TITLE = '';
    /* ───────── 공통 유틸 ───────── */
    async function readJsonSafe(res){
      try{ return await res.clone().json(); }
      catch{ let t=''; try{ t=await res.text(); }catch{}; return {success:false,error:(t && t.slice(0,200))||`HTTP ${res.status}`} }
    }
    async function getJson(url){
      const r = await fetch(url,{credentials:'include'});
      const j = await readJsonSafe(r);
      if(!r.ok || j.success===false) throw new Error(j.error || `HTTP ${r.status}`);
      return j;
    }
    async function postJson(url, body){
      const r = await fetch(url,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body:JSON.stringify(body||{})
      });
      const j = await readJsonSafe(r);
      if(!r.ok || j.success===false) throw new Error(j.error || `HTTP ${r.status}`);
      return j;
    }

    /* ───────── teacherId 확보(세션 → whoami 1회 시도 → 기본값) ───────── */
    let TEACHER_ID =
      sessionStorage.getItem('teacherId') ||
      sessionStorage.getItem('username') || '';

    let _whoamiOnce = null; // 메모이즈(최대 1회만 네트워크 시도)

    async function ensureTeacherId() {
      if (TEACHER_ID) return TEACHER_ID;

      if (!_whoamiOnce) {
        _whoamiOnce = fetch('/api/auth/whoami', {
          credentials: 'include',
          cache: 'no-store'
        })
        .then(async (r) => {
          if (!r.ok) throw new Error('no whoami');
          const j = await r.json();
          TEACHER_ID = j?.teacherId || j?.uid || j?.email || 'T_DEFAULT';
          sessionStorage.setItem('teacherId', TEACHER_ID);
          return TEACHER_ID;
        })
        .catch(() => {
          // 조용히 세션/기본값으로
          TEACHER_ID =
            sessionStorage.getItem('teacherId') ||
            sessionStorage.getItem('username') ||
            'T_DEFAULT';
          return TEACHER_ID;
        });
      }
      return _whoamiOnce;
    }

    function getTeacherId() { return TEACHER_ID || 'T_DEFAULT'; }

    // 초기 로드 순서 보장
    document.addEventListener('DOMContentLoaded', async () => {
      await ensureTeacherId();
      loadSavedRosters();
      loadStudentStatus();
      if (typeof loadActivityList === 'function') loadActivityList();
    });
    
    /* ───────── 페이지 전환 ───────── */
    function showPage(pageType){
      document.querySelectorAll('.menu-item').forEach(b=>b.classList.remove('active'));
      event.target.classList.add('active');
      document.querySelectorAll('.page-content').forEach(x=>x.classList.remove('active'));
      if(pageType==='status'){ document.getElementById('statusPage').classList.add('active'); loadStudentStatus(); }
      else { document.getElementById('statisticsPage').classList.add('active'); loadStatistics(); }
    }

    /* ───────── 저장된 명부 목록 ───────── */
    function rosterTitle(r){ return r.title || r.name || r.categoryName || '명부'; }
    function rosterCount(r){ return (r.itemCount ?? r.count ?? r.studentCount ?? 0); }

    async function loadSavedRosters() {
      const box = document.getElementById('rosterList');
      const empty = document.getElementById('saved-roster-empty');
      if (!box) return;
      box.innerHTML = '<div style="padding:8px;color:#666">저장된 명부를 불러오는 중…</div>';

      try {
        const tid = await ensureTeacherId();
        const { rosters } = await getJson('/api/admin/list-rosters?teacherId=' + encodeURIComponent(tid));

        if (!rosters || rosters.length === 0) {
          box.innerHTML = '';
          empty.style.display = '';
          return;
        }
        empty.style.display = 'none';

        box.innerHTML = rosters.map(r => {
          const title = rosterTitle(r);
          const cnt = rosterCount(r);
          const active = !!(r.active || r.published);
          return `
            <div class="roster-item">
              <div class="roster-main js-view" data-id="${r.id}" data-title="${title}">
                <div style="font-weight:700">${title}
                  <span class="tag">${cnt}명</span>
                  ${active ? '<span class="tag" style="border-color:#c7ffe0;background:#f2fff8">노출중</span>' : ''}
                </div>
                <div style="color:#888;font-size:12px">id: ${r.id}</div>
              </div>
              <label class="tiny-check">
                <input type="checkbox" ${active ? 'checked':''} data-id="${r.id}" class="js-publish"> 현황판 노출
              </label>
              <button class="tiny-btn btn-danger js-del" data-id="${r.id}">삭제</button>
            </div>
          `;
        }).join('');

        // ▶ 명부 본문 클릭 → 해당 명부로 현황판 조회
        box.querySelectorAll('.js-view').forEach(el => {
          el.onclick = async () => {
            SELECTED_ROSTER_ID = el.dataset.id;
            SELECTED_ROSTER_TITLE = el.dataset.title || '';
            await loadStudentStatus({ rosterId: SELECTED_ROSTER_ID });
          };
        });

        // ▶ 노출 토글 (체크하면 그 명부를 바로 보여줌)
        box.querySelectorAll('.js-publish').forEach(el => {
          el.onchange = async () => {
            const publish = el.checked;
            const thisId  = el.dataset.id;
            el.disabled = true;
            try {
              const tid = await ensureTeacherId();
              await postJson('/api/admin/publish-roster?teacherId=' + encodeURIComponent(tid), {
                rosterId: thisId, publish
              });
              await refreshStatsFiltersFromRosters();

              if (publish) {
                // 토글 ON → 방금 토글한 명부를 선택해서 즉시 표시
                SELECTED_ROSTER_ID = thisId;
                const viewEl = box.querySelector(`.js-view[data-id="${thisId}"]`);
                SELECTED_ROSTER_TITLE = viewEl?.dataset.title || '';
                await loadStudentStatus({ rosterId: SELECTED_ROSTER_ID });
              } else {
                // 토글 OFF → 선택 유지(없으면 빈화면)
                if (SELECTED_ROSTER_ID) await loadStudentStatus({ rosterId: SELECTED_ROSTER_ID });
                else await loadStudentStatus({ forceEmpty: true });
              }
            } catch (e) {
              alert('노출 설정 실패: ' + (e.message || 'unknown'));
              el.checked = !publish;
            } finally {
              el.disabled = false;
            }
          };
        });

        // ▶ 삭제
        box.querySelectorAll('.js-del').forEach(btn => {
          btn.onclick = async () => {
            if (!confirm('이 명부를 삭제하시겠습니까?')) return;
            const deletedId = btn.dataset.id;
            btn.disabled = true;
            try {
              const tid = await ensureTeacherId();
              await postJson('/api/admin/delete-roster?teacherId=' + encodeURIComponent(tid), {
               rosterId: deletedId
              });

              // 선택된 걸 삭제했다면 선택 해제 + 빈 화면
              if (SELECTED_ROSTER_ID === deletedId) {
                SELECTED_ROSTER_ID = null;
                SELECTED_ROSTER_TITLE = '';
                await loadStudentStatus({ forceEmpty: true });
              } else if (SELECTED_ROSTER_ID) {
                await loadStudentStatus({ rosterId: SELECTED_ROSTER_ID });
              } else {
                await loadStudentStatus({ forceEmpty: true });
              }

              await loadSavedRosters();
              await refreshStatsFiltersFromRosters();
            } catch (e) {
              alert('삭제 실패: ' + (e.message || 'unknown'));
            } finally {
              btn.disabled = false;
            }
          };
        });

      } catch (e) {
        console.error(e);
        box.innerHTML = '<div style="padding:8px;color:#c53030">목록을 불러오지 못했습니다.</div>';
      }
    }

    /* ───────── 업로드 ───────── */
    const UP = { preview: [] };
    function getUploadMeta(){
      const type = (document.querySelector('input[name="catType"]:checked')?.value)||'subject';
      const name = document.getElementById('categoryName')?.value?.trim()||'';
      return { type, name };
    }
    function renderPreview(){
      const box = document.getElementById('rosterPreview');
      const btn = document.getElementById('btnSaveRoster');
      if(!UP.preview.length){
        box.textContent = '파일을 선택하면 미리보기가 여기에 표시됩니다.';
        btn.disabled = true; return;
      }
      box.innerHTML = `
        <div style="margin-bottom:6px;color:#666;">총 ${UP.preview.length}명</div>
        <ul style="list-style:none;padding:0;margin:0">
          ${UP.preview.map(r=>`<li style="padding:4px 0;border-bottom:1px solid #f2f2f2">${r.studentId} - ${r.name}</li>`).join('')}
        </ul>`;
      btn.disabled = false;
    }
    function showRosterModal(){ UP.preview=[]; renderPreview(); document.getElementById('categoryName').value=''; document.getElementById('rosterModal').style.display='flex'; }
    function closeRosterModal(){ document.getElementById('rosterModal').style.display='none'; }

    function parseCSV(text){ return text.replace(/\r/g,'').split('\n').map(l=>l.split(',').map(c=>(c??'').trim())).filter(c=>c.some(x=>x)); }
    function handleFileUpload(ev){
      const file = ev.target.files?.[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          let rows;
          if(file.name.toLowerCase().endsWith('.csv')){
            const buf = new Uint8Array(e.target.result);
            let txt=''; try{ txt=new TextDecoder('utf-8',{fatal:true}).decode(buf); }
            catch{ try{ txt=new TextDecoder('euc-kr').decode(buf);}catch{ txt=new TextDecoder().decode(buf);} }
            rows = parseCSV(String(txt||''));
          }else{
            const wb = XLSX.read(e.target.result,{type:'binary'});
            rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});
          }
          if(!rows || !rows.length){ UP.preview=[]; renderPreview(); showMessage('파일에 데이터가 없습니다.','error'); return; }
          const first = String(rows[0].join(',')).replace(/\s/g,'');
          if (/(이름|name).*(학번|id)/i.test(first)) rows.shift();
          const seen = new Set();
          UP.preview = rows
            .map(r=>r.map(c=>(c??'').toString().trim()))
            .filter(r=>r[0] && r[1])
            .filter(r=>{ const ok=!seen.has(r[1]); if(ok) seen.add(r[1]); return ok; })
            .map(r=>({name:r[0],studentId:r[1]}));
          renderPreview();
          showMessage('파일을 읽었습니다. 저장을 눌러 업로드하세요.','success');
        }catch(err){
          console.error(err); UP.preview=[]; renderPreview(); showMessage('파일 형식이 올바르지 않습니다.','error');
        }
      };
      if(file.name.toLowerCase().endsWith('.csv')) reader.readAsArrayBuffer(file);
      else reader.readAsBinaryString(file);
    }

    
    // ...위 코드는 그대로...

    async function saveRoster(){
      const { type, name } = getUploadMeta();
      if(!name){ showMessage('카테고리 이름을 입력하세요.','error'); return; }
      if(!UP.preview.length){ showMessage('업로드할 데이터가 없습니다.','error'); return; }

      const roster = UP.preview.map(r=>({
        username:r.studentId, password:r.name, name:r.name, studentId:r.studentId,
        subject:type==='subject'?name:'', club:type==='club'?name:''
      }));

      try{
        const tid = await ensureTeacherId();
        const url = '/api/admin/import-students?teacherId=' + encodeURIComponent(tid);
        await postJson(url, { skipExisting:true, categoryType:type, categoryName:name, roster });

        showMessage(`명부가 저장되었습니다. (총 ${roster.length}명)`, 'success');
        UP.preview=[]; renderPreview(); closeRosterModal();
        await loadSavedRosters();
        await refreshStatsFiltersFromRosters();
        await loadStudentStatus({ forceEmpty:true }); // 업로드 직후 자동표시 금지
      }catch(e){
        try{
          const tid = await ensureTeacherId();
          const url2 = '/api/admin/import-students?teacherId=' + encodeURIComponent(tid);
          await postJson(url2, { skipExisting:true, students: roster });
          showMessage(`명부가 저장되었습니다. (총 ${roster.length}명)`, 'success');
          UP.preview=[]; renderPreview(); closeRosterModal();
          await loadSavedRosters();
          await loadStudentStatus({ forceEmpty:true });
        }catch(e2){
          showMessage(`서버 업로드 실패: ${e2.message}`,'error');
        }
      }
    }


    // ...아래 코드는 그대로...

    /* ───────── 학생 현황 ───────── */
    async function loadStudentStatus(opts = {}) {
      const { rosterId = null, forceEmpty = false } = opts;

      if (forceEmpty && !rosterId) {
        renderStudentStatusEmpty();
        document.getElementById('classInfo').textContent = '현재 조회: (선택 필요)';
        return;
      }

      try {
        const tid = await ensureTeacherId();

        // 1) 요청 URL: 서버 구현 차이를 대비해 파라미터명을 세 가지 모두 붙임
        let url = `/api/admin/list-students?teacherId=${encodeURIComponent(tid)}&_=${Date.now()}`;
        if (rosterId) {
          const rid = encodeURIComponent(rosterId);
          url += `&rosterId=${rid}&rid=${rid}&roster=${rid}`;
        } else {
          // 선택 안 했을 때는 '노출중(공개)'만 보기용으로
          url += `&onlyActive=1`;
        }

        const res = await fetch(url, { cache: 'no-store', credentials: 'include' });
        const j = await res.json();
        if (!res.ok || j.success === false) throw new Error(j.error || '조회 실패');

        // 2) 응답 보정: 혹시 서버가 전체를 돌려줘도 프런트에서 한 번 더 거른다
        let students = Array.isArray(j.students) ? j.students : [];
        if (rosterId) {
          students = students.filter(s => {
            const r = (s.rosterId || s.roster || s.rid);
            const t = (s.teacherId || s.tid || s.ownerId);
            return r === rosterId && (!t || t === tid); // rosterId 일치 + (있다면) 내 teacherId 일치
          });
        }

        document.getElementById('classInfo').textContent =
          rosterId ? `현재 조회: ${SELECTED_ROSTER_TITLE || '선택된 명부'}` : '현재 조회: (선택 필요)';

        if (!students.length) { renderStudentStatusEmpty(); return; }

        const normalized = students.map(s => ({
          name: s.name,
          studentId: s.studentId,
          status: s.status || 'not-started',
          hasPeerEvaluation: !!s.hasPeerEvaluation,
          hasSelfEvaluation: !!s.hasSelfEvaluation,
          lastUpdate: s.lastUpdate || '-'
        }));
        displayStudentStatus(normalized);
      } catch (e) {
        console.error('현황 조회 오류:', e);
        showMessage('현황 조회 중 오류가 발생했습니다.', 'error');
        renderStudentStatusEmpty();
      }
    }


    function renderStudentStatusEmpty(){
      const grid=document.getElementById('studentStatusGrid');
      grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:#666;padding:20px;">
        저장된(활성) 명부가 없습니다. <strong>저장된 명부</strong>에서 현황판 노출을 켜세요.</div>`;
      document.getElementById('completedCount').textContent='0명';
      document.getElementById('pendingCount').textContent='0명';
      document.getElementById('notStartedCount').textContent='0명';
    }
    function displayStudentStatus(students){
      const grid=document.getElementById('studentStatusGrid');
      const statusCounts={completed:0,pending:0,'not-started':0};
      if(!students.length){ renderStudentStatusEmpty(); return; }
      grid.innerHTML = students.map(st=>{
        statusCounts[st.status]++;
        const statusText={completed:'완료',pending:'부분완료','not-started':'미시작'};
        const detailText={
          completed:'동료평가 ✓ 자기평가 ✓',
          pending: st.hasPeerEvaluation&&!st.hasSelfEvaluation?'동료평가 ✓ 자기평가 ✗'
                 :!st.hasPeerEvaluation&&st.hasSelfEvaluation?'동료평가 ✗ 자기평가 ✓'
                 :'동료평가 ✓ 자기평가 ✗',
          'not-started':'동료평가 ✗ 자기평가 ✗'
        };
        return `<div class="student-card ${st.status}" title="${detailText[st.status]}">
          <div class="student-name">${st.name}</div>
          <div class="student-status status-${st.status}">${statusText[st.status]}</div>
          <div style="font-size:10px;color:#666;margin-top:5px;">${st.lastUpdate}</div>
          <div style="font-size:9px;color:#999;margin-top:2px;">${detailText[st.status]}</div>
        </div>`;
      }).join('');
      document.getElementById('completedCount').textContent=statusCounts.completed+'명';
      document.getElementById('pendingCount').textContent=statusCounts.pending+'명';
      document.getElementById('notStartedCount').textContent=statusCounts['not-started']+'명';
    }

    /* ───────── 통계(요약) ───────── */
    const COMPETENCIES=['자신감과 리더십','분석','아이디어 뱅크','감정 이해','의사소통','협동심'];
    let currentStatsData=[];
    function loadStatistics(){ /* 기존 구현 사용 */ }
    function downloadExcel(){ /* 기존 구현 사용 */ }

    /* ───────── 공용 UI ───────── */
    function showMessage(msg,type){
      const old=document.querySelector('.success-message,.error-message'); if(old) old.remove();
      const div=document.createElement('div'); div.className=(type==='success'?'success-message':'error-message'); div.textContent=msg;
      const active=document.querySelector('.page-content.active'); const first=active.querySelector('.card'); active.insertBefore(div,first);
      setTimeout(()=>div.remove(),3000);
    }
    function downloadTemplate(){
      const csv=['이름,학번','홍길동,20250001','김나래,20250002'].join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='명부_양식.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    function clearAllData(){ if(confirm('정말 초기화할까요?')){ localStorage.clear(); showMessage('모든 데이터가 초기화되었습니다.','success'); closeRosterModal(); loadStudentStatus(); } }
    function logout(){ if(confirm('정말로 로그아웃하시겠습니까?')) location.href='login.html'; }

    // 저장된 명부로 통계 드롭다운 채우기
    function setSelectOptions(sel, items){
      if (!sel) return;
      const keep = sel.value;
      sel.innerHTML =
        '<option value="">전체</option>' +
        items.sort((a,b)=>a.localeCompare(b,'ko'))
             .map(v=>`<option value="${v}">${v}</option>`).join('');
      if ([...sel.options].some(o=>o.value===keep)) sel.value = keep;
    }

    async function refreshStatsFiltersFromRosters() {
      try {
        const tid = await ensureTeacherId();
        const { rosters = [] } = await getJson(
          '/api/admin/list-rosters?teacherId=' + encodeURIComponent(tid)
        );

        const subjects = new Set();
        const clubs    = new Set();

        rosters.forEach(r => {
          const type = (r.categoryType || r.type || '').toString().toLowerCase();
          const name = r.categoryName || r.title || r.name || '';
          if (!name || name === '무제 명부') return;
          if (type === 'subject') subjects.add(name);
         else if (type === 'club') clubs.add(name);
        });

        setSelectOptions(document.getElementById('statsSubject'), [...subjects]);
        setSelectOptions(document.getElementById('statsClub'),    [...clubs]);
      } catch (e) {
        console.warn('통계 필터 갱신 실패:', e);
      }
    }
   
    /* ───────── 초기 로드 ───────── */
    document.addEventListener('DOMContentLoaded', async ()=>{
      await ensureTeacherId();   // teacherId 먼저 확보
      await refreshStatsFiltersFromRosters(); // ← 추가!
      await loadSavedRosters();        // 저장된 명부
      await loadStudentStatus();       // 현황판
      loadActivityList();        // 활동목록(기존)
    });

    /* 활동 정보(기존) */
    function addActivityInfo(){ /* 기존 구현 */ }
    function loadActivityList(){ /* 기존 구현 */ }
    function removeActivity(id){ /* 기존 구현 */ }
    function clearAllActivities(){ /* 기존 구현 */ }
    function toggleStudentDetail(h){ const c=h.nextElementSibling,a=h.querySelector('span:last-child'); if(c.classList.contains('expanded')){c.classList.remove('expanded'); a.textContent='▼';}else{c.classList.add('expanded'); a.textContent='▲';} }
    function updateClassInfo(){ /* 필요시 사용 */ }
  </script>
</body>
</html>






