<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì˜¤ëŠ˜ì˜ ì—ì´ìŠ¤ëŠ”? - ê´€ë¦¬ì</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* ====== ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ ====== */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Arial',sans-serif;background-color:#fff8f0;min-height:100vh;display:flex}
    .sidebar{width:220px;background:#fff;border-right:3px solid #ffe0b3;padding:20px;box-shadow:3px 0 10px rgba(255,217,61,.1)}
    .sidebar-header{text-align:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #fff5e6}
    .sidebar-header h2{color:#2d3748;font-size:16px;font-weight:700;margin-bottom:5px}
    .sidebar-header p{color:#4a5568;font-size:11px}
    .menu-item{display:block;width:100%;padding:12px 15px;margin-bottom:8px;background:#fff5e6;border:2px solid #ffe0b3;border-radius:10px;color:#2d3748;text-decoration:none;font-weight:600;text-align:center;font-size:12px;cursor:pointer;transition:.2s}
    .menu-item.active,.menu-item:hover{background:#ffd93d;transform:translateY(-1px)}
    .logout-btn{margin-top:20px;padding:8px 12px;background:#ffb3b3;border:2px solid #ff9999;border-radius:8px;color:#2d3748;font-weight:600;cursor:pointer;width:100%;font-size:11px}
    .main-content{flex:1;padding:25px;overflow-y:auto}
    .page-header{text-align:center;margin-bottom:25px}
    .page-header h1{color:#2d3748;font-size:26px;font-weight:700;margin-bottom:8px}
    .page-header p{color:#4a5568;font-size:15px}
    .page-content{display:none}.page-content.active{display:block}
    .card{background:#fff;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,.05)}
    .card.orange{border:3px solid #ffe0b3;background:#fffbf5}
    .card.purple{border:3px solid #e0c4ff;background:#faf7ff}
    .card h3{color:#2d3748;margin-bottom:15px;font-size:16px;text-align:center}
    .class-selector{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
    .class-selector select,.class-selector input{padding:8px 12px;border:2px solid #ffd93d;border-radius:8px;font-size:14px;background:#fff}
    .class-selector button{background:#ffd93d;color:#2d3748;border:none;padding:8px 15px;border-radius:8px;font-weight:600;cursor:pointer;transition:.2s}
    .class-selector button:hover{background:#ffb700;transform:translateY(-1px)}
    .student-status-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-bottom:20px}
    .student-card{background:#fff;border:2px solid #e2e8f0;border-radius:10px;padding:15px;text-align:center;transition:.2s}
    .student-card.completed{border-color:#68d391;background:#f0fff4}
    .student-card.pending{border-color:#fed7af;background:#fffaf0}
    .student-card.not-started{border-color:#feb2b2;background:#fef5f5}
    .student-name{font-weight:700;color:#2d3748;margin-bottom:5px}
    .student-status{font-size:12px;padding:4px 8px;border-radius:12px;color:#fff}
    .status-completed{background:#48bb78}.status-pending{background:#ed8936}.status-not-started{background:#e53e3e}
    .roster-management{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
    .file-upload{border:2px dashed #ffd93d;border-radius:10px;padding:20px;text-align:center;cursor:pointer;transition:.2s}
    .file-upload:hover{border-color:#ffb700;background:#fffbf5}
    .file-upload input{display:none}
    .stats-controls{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px}
    .stats-results{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .student-detail{border:1px solid #e2e8f0;border-radius:8px;margin-bottom:10px;overflow:hidden}
    .student-header{background:#f7fafc;padding:10px 15px;font-weight:700;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
    .student-content{padding:15px;display:none}.student-content.expanded{display:block}
    .competency-stat{display:flex;justify-content:space-between;margin-bottom:8px;padding:5px 10px;background:#f8f9fa;border-radius:5px}
    .download-btn{background:#c77dff;color:#fff;border:none;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;transition:.2s}
    .download-btn:hover{background:#a855f7;transform:translateY(-1px)}
    @media (max-width:1000px){.roster-management{grid-template-columns:1fr}.stats-controls{grid-template-columns:repeat(2,1fr)}.stats-results{grid-template-columns:1fr}}
    @media (max-width:768px){body{flex-direction:column}.sidebar{width:100%;padding:15px}.main-content{padding:20px}.class-selector{flex-direction:column;align-items:stretch}.stats-controls{grid-template-columns:1fr}.student-status-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}}
    .success-message{background:#e6fffa;color:#234e52;padding:10px 15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #81e6d9}
    .error-message{background:#ffe6e6;color:#c53030;padding:10px 15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #fc8181}

    /* ====== ì €ì¥ëœ ëª…ë¶€ ì¹´ë“œ(ì¶”ê°€) ====== */
    .roster-item{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid #f0f0f0;border-radius:12px;margin:8px 0;background:#fff}
    .roster-main{flex:1}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid #ffe0b3;background:#fff5e6;margin-left:6px}
    .tiny-btn{border:none;border-radius:6px;padding:6px 10px;font-size:12px;cursor:pointer}
    .btn-danger{background:#e53e3e;color:#fff}
    .btn-danger:hover{filter:brightness(0.95)}
    .tiny-check{display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer}
  </style>
</head>
<body>
  <!-- ì‚¬ì´ë“œë°” -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>ğŸ‘¨â€ğŸ« ê´€ë¦¬ì ë©”ë‰´</h2>
      <p>ì„ ìƒë‹˜, ì•ˆë…•í•˜ì„¸ìš”!</p>
    </div>
    <button class="menu-item active" onclick="showPage('status')">ğŸ“‹ í˜„í™© í˜ì´ì§€</button>
    <button class="menu-item" onclick="showPage('statistics')">ğŸ“Š í†µê³„ í˜ì´ì§€</button>
    <button class="logout-btn" onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <!-- ë©”ì¸ -->
  <div class="main-content">
    <div class="page-header">
      <h1>ğŸ¯ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
      <p>í•™ìƒë“¤ì˜ í‰ê°€ í˜„í™©ê³¼ í†µê³„ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</p>
    </div>

    <!-- í˜„í™© í˜ì´ì§€ -->
    <div id="statusPage" class="page-content active">
      <div class="card orange">
        <h3>ğŸ« í´ë˜ìŠ¤ ê´€ë¦¬</h3>
        <div class="class-selector" style="justify-content:center;gap:12px;">
          <button onclick="showRosterModal()" style="background:#c77dff;color:#fff">ëª…ë¶€ ì—…ë¡œë“œ</button>
          <button onclick="downloadTemplate()">ì–‘ì‹ ë‹¤ìš´ë¡œë“œ (CSV)</button>
        </div>
      </div>

      <div id="classInfo" style="text-align:center;color:#666;margin-bottom:15px;">í˜„ì¬ ì¡°íšŒ: ì „ì²´</div>

      <!-- âœ… ì €ì¥ëœ ëª…ë¶€ ë°•ìŠ¤: ì—¬ê¸° ì•ˆì— ì‹¤ì œ ëª…ë¶€ê°€ ë Œë”ë§ë¨ -->
      <div class="card orange" id="rosterListCard">
        <h3>ğŸ“š ì €ì¥ëœ ëª…ë¶€</h3>
        <p id="saved-roster-empty" style="text-align:center;color:#888">ì €ì¥ëœ ëª…ë¶€ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì—…ë¡œë“œ í•´ ì£¼ì„¸ìš”.</p>
        <div id="rosterList" style="font-size:13px;color:#2d3748;"></div>
      </div>

      <!-- í•™ìƒ í˜„í™©íŒ -->
      <div class="card purple">
        <h3>ğŸ‘¥ í•™ìƒ í˜„í™©íŒ</h3>
        <div id="studentStatusGrid" class="student-status-grid">
          <div style="grid-column:1/-1;text-align:center;color:#666;padding:20px;">
            í´ë˜ìŠ¤ë¥¼ ì„ íƒí•˜ê³  ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
          </div>
        </div>
        <div style="text-align:center;margin-top:15px;">
          <span style="margin-right:20px;">
            <span class="student-status status-completed">ì™„ë£Œ</span>
            <span id="completedCount" style="margin-left:5px;font-size:14px;">0ëª…</span>
          </span>
          <span style="margin-right:20px;">
            <span class="student-status status-pending">ë¶€ë¶„ì™„ë£Œ</span>
            <span id="pendingCount" style="margin-left:5px;font-size:14px;">0ëª…</span>
          </span>
          <span>
            <span class="student-status status-not-started">ë¯¸ì‹œì‘</span>
            <span id="notStartedCount" style="margin-left:5px;font-size:14px;">0ëª…</span>
          </span>
        </div>
      </div>
    </div>

    <!-- í†µê³„ í˜ì´ì§€ (ë‚´ìš© ë™ì¼) -->
    <div id="statisticsPage" class="page-content">
      <div class="card orange">
        <h3>ğŸ“ˆ í†µê³„ ì¡°íšŒ</h3>
        <div class="stats-controls">
          <select id="statsYear"><option value="2024">2024ë…„</option><option value="2025" selected>2025ë…„</option></select>
          <select id="statsSubject"><option value="">ì „ì²´ ê³¼ëª©</option><option>êµ­ì–´</option><option>ìˆ˜í•™</option><option>ì˜ì–´</option></select>
          <select id="statsClub"><option value="">ì „ì²´ ë™ì•„ë¦¬</option><option>ì½”ë”©í´ëŸ½</option><option>ë…ì„œí† ë¡ </option></select>
          <div style="display:flex;gap:10px;align-items:center;">
            <input type="date" id="startDate" style="padding:8px;border:2px solid #c77dff;border-radius:8px;">
            <span>~</span>
            <input type="date" id="endDate" style="padding:8px;border:2px solid #c77dff;border-radius:8px;">
          </div>
        </div>
        <div style="text-align:center;margin-top:10px;">
          <button onclick="loadStatistics()" style="background:#c77dff;color:#fff;border:none;padding:10px 20px;border-radius:8px;font-weight:600;">í†µê³„ ì¡°íšŒ</button>
        </div>
      </div>

      <div class="stats-results">
        <div class="card purple">
          <h3>ğŸ“Š ê°œì¸ë³„ í†µê³„</h3>
          <div style="margin-bottom:15px;text-align:right;">
            <button class="download-btn" onclick="downloadExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
          </div>
          <div id="statisticsResults">
            <div style="text-align:center;color:#666;padding:20px;">í†µê³„ ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
          </div>
        </div>

        <div class="card orange">
          <h3>ğŸ“ˆ ì „ì²´ ìš”ì•½</h3>
          <div id="summaryStats">
            <div style="text-align:center;color:#666;padding:20px;">í†µê³„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>

          <!-- í™œë™ ì •ë³´ ê´€ë¦¬(ê¸°ì¡´) -->
          <div style="margin-top:20px;padding-top:20px;border-top:2px solid #fff5e6;">
            <h4 style="text-align:center;margin-bottom:15px;color:#2d3748;">ğŸ“ í™œë™ ì •ë³´ ê´€ë¦¬</h4>
            <div style="display:flex;gap:10px;margin-bottom:15px;">
              <input type="date" id="activityDate" style="flex:1;padding:8px;border:2px solid #ffd93d;border-radius:8px;">
              <input type="text" id="activityName" placeholder="í™œë™ëª… (ì˜ˆ: ëª¨ë‘  í† ë¡ )" style="flex:2;padding:8px;border:2px solid #ffd93d;border-radius:8px;">
              <button onclick="addActivityInfo()" style="background:#ffd93d;color:#2d3748;border:none;padding:8px 15px;border-radius:8px;font-weight:600;white-space:nowrap;">ì¶”ê°€</button>
            </div>
            <div id="activityList" style="max-height:150px;overflow-y:auto;"></div>
            <div style="text-align:center;margin-top:10px;">
              <button onclick="clearAllActivities()" style="background:#e53e3e;color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:12px;">ì „ì²´ ì‚­ì œ</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ëª…ë¶€ ì—…ë¡œë“œ ëª¨ë‹¬ -->
  <div id="rosterModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:28px;border-radius:16px;width:min(560px,92%);">
      <h3 style="margin-bottom:16px;text-align:center;">ğŸ“‹ ëª…ë¶€ ì—…ë¡œë“œ</h3>

      <div style="display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center;margin-bottom:14px;">
        <div style="font-weight:600;">ì¹´í…Œê³ ë¦¬ ì¢…ë¥˜</div>
        <div>
          <label style="margin-right:12px;"><input type="radio" name="catType" value="subject" checked> ê³¼ëª©</label>
          <label><input type="radio" name="catType" value="club"> ë™ì•„ë¦¬</label>
        </div>
        <div style="font-weight:600;">ì¹´í…Œê³ ë¦¬ ì´ë¦„</div>
        <div><input id="categoryName" placeholder="ì˜ˆ) êµ­ì–´ / ì½”ë”©í´ëŸ½" style="width:100%;padding:8px 10px;border:2px solid #ffd93d;border-radius:8px;"></div>
      </div>

      <div class="file-upload" onclick="document.getElementById('csvFile').click()">
        <input type="file" id="csvFile" accept=".csv,.xlsx,.xls" onchange="handleFileUpload(event)">
        <div>ğŸ“ CSV ë˜ëŠ” Excel íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</div>
        <div style="font-size:12px;color:#666;margin-top:5px;">í˜•ì‹: <strong>ì´ë¦„, í•™ë²ˆ</strong> (ì¹´í…Œê³ ë¦¬ëŠ” ìœ„ì—ì„œ ë¯¸ë¦¬ ì§€ì •)</div>
        <div style="text-align:center;margin-top:10px;">
          <button type="button" onclick="downloadTemplate()" style="background:#ffd93d;color:#2d3748;border:none;padding:8px 14px;border-radius:8px;font-weight:600;">ğŸ“¥ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
        </div>
      </div>

      <div id="rosterPreview" style="margin-top:12px;max-height:180px;overflow:auto;border:1px dashed #eee;border-radius:8px;padding:8px;font-size:13px;color:#2d3748;">
        íŒŒì¼ì„ ì„ íƒí•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
      </div>

      <div style="margin-top:12px;text-align:right;">
        <button id="btnSaveRoster" type="button" onclick="saveRoster()" style="background:#5c7cfa;color:#fff;border:none;padding:8px 14px;border-radius:8px;font-weight:600;" disabled>ì €ì¥</button>
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:18px;">
        <button onclick="clearAllData()" style="background:#e53e3e;color:#fff;border:none;padding:8px 14px;border-radius:8px;">ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
        <button onclick="closeRosterModal()" style="background:#4a5568;color:#fff;border:none;padding:8px 14px;border-radius:8px;">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <script>
    /* ========== ê³µí†µ ìœ í‹¸ ========== */
    async function readJsonSafe(res){
      try{ return await res.clone().json(); }
      catch{ let t=''; try{ t=await res.text(); }catch{}; return {success:false,error:(t && t.slice(0,200))||`HTTP ${res.status}`} }
    }
    async function getJson(url){
      const r = await fetch(url,{credentials:'include'});
      const j = await readJsonSafe(r);
      if(!r.ok || j.success===false) throw new Error(j.error || `HTTP ${r.status}`);
      return j;
    }
    async function postJson(url, body){
      const r = await fetch(url,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body:JSON.stringify(body||{})
      });
      const j = await readJsonSafe(r);
      if(!r.ok || j.success===false) throw new Error(j.error || `HTTP ${r.status}`);
      return j;
    }

    /* ========== í˜ì´ì§€ ì „í™˜ ========== */
    function showPage(pageType){
      document.querySelectorAll('.menu-item').forEach(b=>b.classList.remove('active'));
      event.target.classList.add('active');
      document.querySelectorAll('.page-content').forEach(x=>x.classList.remove('active'));
      if(pageType==='status'){ document.getElementById('statusPage').classList.add('active'); loadStudentStatus(); }
      else { document.getElementById('statisticsPage').classList.add('active'); loadStatistics(); }
    }

    /* ========== ì €ì¥ëœ ëª…ë¶€ ëª©ë¡ ë Œë”ë§(í•µì‹¬) ========== */
    function rosterTitle(r){ return r.title || r.name || 'ëª…ë¶€ ì—…ë¡œë“œ'; }
    function rosterCount(r){ return (r.count ?? r.studentCount ?? 0); }

    function renderRosterItem(r){
      const el = document.createElement('div');
      el.className = 'roster-item';
      el.innerHTML = `
        <div class="roster-main">
          <div style="font-weight:700">${rosterTitle(r)}
            <span class="tag">${rosterCount(r)}ëª…</span>
            ${r.published || r.active ? '<span class="tag" style="border-color:#c7ffe0;background:#f2fff8">ë…¸ì¶œì¤‘</span>' : ''}
          </div>
          <div style="color:#888;font-size:12px">id: ${r.id}</div>
        </div>
        <label class="tiny-check">
          <input type="checkbox" ${ (r.active || r.published) ? 'checked':'' } data-id="${r.id}" class="js-publish">
          í˜„í™©íŒ ë…¸ì¶œ
        </label>
        <button class="tiny-btn btn-danger js-del" data-id="${r.id}">ì‚­ì œ</button>
      `;
      // í† ê¸€
      el.querySelector('.js-publish').addEventListener('change', async (e)=>{
        const id = e.target.dataset.id;
        const publish = e.target.checked;
        e.target.disabled = true;
        try{
          await postJson('/api/admin/publish-roster', { rosterId:id, publish });
          await loadSavedRosters();
          if(typeof loadStudentStatus==='function') loadStudentStatus();
        }catch(err){
          alert(err.message||'ë…¸ì¶œ ì„¤ì • ì‹¤íŒ¨');
          e.target.checked = !publish;
        }finally{ e.target.disabled=false; }
      });
      // ì‚­ì œ
      el.querySelector('.js-del').addEventListener('click', async (e)=>{
        const id = e.target.dataset.id;
        if(!confirm('ì´ ëª…ë¶€ë¥¼ ì‚­ì œí• ê¹Œìš”? (í•™ìƒ ë°ì´í„°ëŠ” ê·¸ëŒ€ë¡œ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)')) return;
        e.target.disabled = true;
        try{
          await postJson('/api/admin/delete-roster', { rosterId:id });   // â† ì„œë²„ì— ì´ ì—”ë“œí¬ì¸íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.
          await loadSavedRosters();
          if(typeof loadStudentStatus==='function') loadStudentStatus();
        }catch(err){
          alert(err.message||'ì‚­ì œ ì‹¤íŒ¨');
        }finally{ e.target.disabled=false; }
      });
      return el;
    }

    async function loadSavedRosters() {
      const box = document.getElementById('rosterList');   // â† ê¸°ì¡´ savedRosters â†’ rosterList
      if (!box) return;

      box.innerHTML = '<div style="padding:8px;color:#666">ì €ì¥ëœ ëª…ë¶€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';

      try {
        const { rosters } = await getJson('/api/admin/list-rosters');

        if (!rosters || rosters.length === 0) {
          box.innerHTML = '<div style="padding:8px;color:#999">ì €ì¥ëœ ëª…ë¶€ ì—†ìŒ</div>';
          return;
        }

        // title(ì¹´í…Œê³ ë¦¬)ì´ ì—†ìœ¼ë©´ categoryName/Typeìœ¼ë¡œ ë³´ì™„, ì¸ì›ì€ itemCount/count/0 ìˆœ
        const rows = rosters.map(r => {
          const title =
            r.title ||
            (r.categoryName ? r.categoryName : 'ë¬´ì œ ëª…ë¶€');
          const cnt = (r.itemCount ?? r.count ?? 0);
          return `
            <div style="display:flex;align-items:center;gap:12px;padding:10px;border:1px solid #eee;border-radius:10px;margin:6px 0">
              <div style="flex:1">
                <div style="font-weight:700">${title} <span style="color:#999;font-weight:500">(${cnt}ëª…)</span></div>
                <div style="color:#888;font-size:12px">id: ${r.id}</div>
              </div>

              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px">
                <input type="checkbox" ${r.active ? 'checked' : ''} data-id="${r.id}" class="toggle-publish" />
                í˜„í™©íŒ ë…¸ì¶œ
              </label>

              <button class="del-roster" data-id="${r.id}"
                      style="background:#e53e3e;color:#fff;border:none;padding:6px 10px;border-radius:6px">
                ì‚­ì œ
              </button>
            </div>
          `;
        }).join('');

        box.innerHTML = rows;

        // í˜„í™©íŒ ë…¸ì¶œ í† ê¸€
        box.querySelectorAll('.toggle-publish').forEach(el => {
          el.onchange = async () => {
            el.disabled = true;
            try {
              await postJson('/api/admin/publish-roster', {
                rosterId: el.dataset.id,
                publish: el.checked
              });
              // í™œì„± ëª…ë¶€ê°€ ë°”ë€Œì—ˆìœ¼ë‹ˆ í˜„í™©íŒ ê°±ì‹ 
              await loadStudentStatus();
            } catch (e) {
              alert('ì‹¤íŒ¨: ' + e.message);
              el.checked = !el.checked;
            } finally {
              el.disabled = false;
            }
          };
        });

        // ì‚­ì œ
        box.querySelectorAll('.del-roster').forEach(btn => {
          btn.onclick = async () => {
            if (!confirm('ì´ ëª…ë¶€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            btn.disabled = true;
            try {
              await postJson('/api/admin/delete-roster', { rosterId: btn.dataset.id });
              await loadSavedRosters();   // ëª©ë¡ ê°±ì‹ 
              await loadStudentStatus();  // í˜„í™©íŒ ê°±ì‹ 
            } catch (e) {
              alert('ì‚­ì œ ì‹¤íŒ¨: ' + e.message);
            } finally {
              btn.disabled = false;
            }
          };
        });
      } catch (e) {
        console.error(e);
        box.innerHTML = '<div style="padding:8px;color:#c53030">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }
    /* ========== ì—…ë¡œë“œ ========== */
    const UP = { preview: [] };
    function getUploadMeta(){
      const type = (document.querySelector('input[name="catType"]:checked')?.value)||'subject';
      const name = document.getElementById('categoryName')?.value?.trim()||'';
      return { type, name };
    }
    function renderPreview(){
      const box = document.getElementById('rosterPreview');
      const btn = document.getElementById('btnSaveRoster');
      if(!UP.preview.length){
        box.textContent = 'íŒŒì¼ì„ ì„ íƒí•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.';
        btn.disabled = true; return;
      }
      box.innerHTML = `
        <div style="margin-bottom:6px;color:#666;">ì´ ${UP.preview.length}ëª…</div>
        <ul style="list-style:none;padding:0;margin:0">
          ${UP.preview.map(r=>`<li style="padding:4px 0;border-bottom:1px solid #f2f2f2">${r.studentId} - ${r.name}</li>`).join('')}
        </ul>`;
      btn.disabled = false;
    }
    function showRosterModal(){ UP.preview=[]; renderPreview(); document.getElementById('categoryName').value=''; document.getElementById('rosterModal').style.display='flex'; }
    function closeRosterModal(){ document.getElementById('rosterModal').style.display='none'; }

    function parseCSV(text){ return text.replace(/\r/g,'').split('\n').map(l=>l.split(',').map(c=>(c??'').trim())).filter(c=>c.some(x=>x)); }
    function handleFileUpload(ev){
      const file = ev.target.files?.[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          let rows;
          if(file.name.toLowerCase().endsWith('.csv')){
            const buf = new Uint8Array(e.target.result);
            let txt=''; try{ txt=new TextDecoder('utf-8',{fatal:true}).decode(buf); }
            catch{ try{ txt=new TextDecoder('euc-kr').decode(buf);}catch{ txt=new TextDecoder().decode(buf);} }
            rows = parseCSV(String(txt||''));
          }else{
            const wb = XLSX.read(e.target.result,{type:'binary'});
            rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});
          }
          if(!rows || !rows.length){ UP.preview=[]; renderPreview(); showMessage('íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.','error'); return; }
          const first = String(rows[0].join(',')).replace(/\s/g,'');
          if (/(ì´ë¦„|name).*(í•™ë²ˆ|id)/i.test(first)) rows.shift();
          const seen = new Set();
          UP.preview = rows
            .map(r=>r.map(c=>(c??'').toString().trim()))
            .filter(r=>r[0] && r[1])
            .filter(r=>{ const ok=!seen.has(r[1]); if(ok) seen.add(r[1]); return ok; })
            .map(r=>({name:r[0],studentId:r[1]}));
          renderPreview();
          showMessage('íŒŒì¼ì„ ì½ì—ˆìŠµë‹ˆë‹¤. ì €ì¥ì„ ëˆŒëŸ¬ ì—…ë¡œë“œí•˜ì„¸ìš”.','success');
        }catch(err){
          console.error(err); UP.preview=[]; renderPreview(); showMessage('íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.','error');
        }
      };
      if(file.name.toLowerCase().endsWith('.csv')) reader.readAsArrayBuffer(file);
      else reader.readAsBinaryString(file);
    }

    async function saveRoster(){
      const { type, name } = getUploadMeta();
      if(!name){ showMessage('ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.','error'); return; }
      if(!UP.preview.length){ showMessage('ì—…ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.','error'); return; }

      const roster = UP.preview.map(r=>({
        username:r.studentId, password:r.name, name:r.name, studentId:r.studentId,
        subject:type==='subject'?name:'', club:type==='club'?name:''
      }));

      try{
        await postJson('/api/admin/import-students',{ skipExisting:true, categoryType: type, categoryName: name, roster });
        showMessage(`ëª…ë¶€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ì´ ${roster.length}ëª…)`, 'success');
        UP.preview=[]; renderPreview(); closeRosterModal();
        await loadSavedRosters();
        if(typeof loadStudentStatus==='function') loadStudentStatus();
      }catch(e){
        // í˜¹ì‹œ ì„œë²„ê°€ students í‚¤ë§Œ ë°›ì„ ë•Œ
        try{
          await postJson('/api/admin/import-students',{ skipExisting:true, students: roster });
          showMessage(`ëª…ë¶€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ì´ ${roster.length}ëª…)`, 'success');
          UP.preview=[]; renderPreview(); closeRosterModal();
          await loadSavedRosters();
          if(typeof loadStudentStatus==='function') loadStudentStatus();
        }catch(e2){
          showMessage(`ì„œë²„ ì—…ë¡œë“œ ì‹¤íŒ¨: ${e2.message}`,'error');
        }
      }
    }

    /* ========== í•™ìƒ í˜„í™© (ê¸°ì¡´ ë¡œì§) ========== */
    async function loadStudentStatus() {
      try {
        const res = await fetch('/api/admin/list-students?onlyActive=1&_=' + Date.now(), { cache: 'no-store' });
        const j = await res.json();
        if (!res.ok || !j.success) throw new Error(j.error || 'ì¡°íšŒ ì‹¤íŒ¨');

        const students = Array.isArray(j.students) ? j.students : [];
        document.getElementById('classInfo').textContent = 'í˜„ì¬ ì¡°íšŒ: ì „ì²´';

        if (students.length === 0) { renderStudentStatusEmpty(); return; }

        const normalized = students.map(s => ({
          name: s.name, studentId: s.studentId,
          status: s.status || 'not-started',
          hasPeerEvaluation: !!s.hasPeerEvaluation,
          hasSelfEvaluation: !!s.hasSelfEvaluation,
          lastUpdate: s.lastUpdate || '-'
        }));

        displayStudentStatus(normalized);
      } catch (e) {
       console.error('í˜„í™© ì¡°íšŒ ì˜¤ë¥˜:', e);
        showMessage('í˜„í™© ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        renderStudentStatusEmpty();
      }
    }
    
    function renderStudentStatusEmpty(){
      const grid=document.getElementById('studentStatusGrid');
      grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:#666;padding:20px;">
        ì €ì¥ëœ ëª…ë¶€ê°€ ì—†ìŠµë‹ˆë‹¤. <strong>ëª…ë¶€ ê´€ë¦¬</strong>ì—ì„œ ì—…ë¡œë“œ í›„ ì¡°íšŒí•˜ì„¸ìš”.</div>`;
      document.getElementById('completedCount').textContent='0ëª…';
      document.getElementById('pendingCount').textContent='0ëª…';
      document.getElementById('notStartedCount').textContent='0ëª…';
    }
    function displayStudentStatus(students){
      const grid=document.getElementById('studentStatusGrid');
      const statusCounts={completed:0,pending:0,'not-started':0};
      if(!students.length){ renderStudentStatusEmpty(); return; }
      grid.innerHTML = students.map(st=>{
        statusCounts[st.status]++;
        const statusText={completed:'ì™„ë£Œ',pending:'ë¶€ë¶„ì™„ë£Œ','not-started':'ë¯¸ì‹œì‘'};
        const detailText={
          completed:'ë™ë£Œí‰ê°€ âœ“ ìê¸°í‰ê°€ âœ“',
          pending: st.hasPeerEvaluation&&!st.hasSelfEvaluation?'ë™ë£Œí‰ê°€ âœ“ ìê¸°í‰ê°€ âœ—'
                 :!st.hasPeerEvaluation&&st.hasSelfEvaluation?'ë™ë£Œí‰ê°€ âœ— ìê¸°í‰ê°€ âœ“'
                 :'ë™ë£Œí‰ê°€ âœ“ ìê¸°í‰ê°€ âœ—',
          'not-started':'ë™ë£Œí‰ê°€ âœ— ìê¸°í‰ê°€ âœ—'
        };
        return `<div class="student-card ${st.status}" title="${detailText[st.status]}">
          <div class="student-name">${st.name}</div>
          <div class="student-status status-${st.status}">${statusText[st.status]}</div>
          <div style="font-size:10px;color:#666;margin-top:5px;">${st.lastUpdate}</div>
          <div style="font-size:9px;color:#999;margin-top:2px;">${detailText[st.status]}</div>
        </div>`;
      }).join('');
      document.getElementById('completedCount').textContent=statusCounts.completed+'ëª…';
      document.getElementById('pendingCount').textContent=statusCounts.pending+'ëª…';
      document.getElementById('notStartedCount').textContent=statusCounts['not-started']+'ëª…';
    }

    /* ========== í†µê³„(ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ê·¸ëŒ€ë¡œ) ========== */
    const COMPETENCIES=['ìì‹ ê°ê³¼ ë¦¬ë”ì‹­','ë¶„ì„','ì•„ì´ë””ì–´ ë±…í¬','ê°ì • ì´í•´','ì˜ì‚¬ì†Œí†µ','í˜‘ë™ì‹¬'];
    let currentStatsData=[];
    async function loadStatistics(){ /* ê·¸ëŒ€ë¡œ - ìƒëµëœ ë¶€ë¶„ì€ ë„¤ ì›ë³¸ í•¨ìˆ˜ ë‚´ìš© ìœ ì§€ */ }

    /* ========== ê³µìš© UI ========== */
    function showMessage(msg,type){
      const old=document.querySelector('.success-message,.error-message'); if(old) old.remove();
      const div=document.createElement('div'); div.className=(type==='success'?'success-message':'error-message'); div.textContent=msg;
      const active=document.querySelector('.page-content.active'); const first=active.querySelector('.card'); active.insertBefore(div,first);
      setTimeout(()=>div.remove(),3000);
    }
    function downloadTemplate(){
      const csv=['ì´ë¦„,í•™ë²ˆ','í™ê¸¸ë™,20250001','ê¹€ë‚˜ë˜,20250002'].join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='ëª…ë¶€_ì–‘ì‹.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    function clearAllData(){ if(confirm('ì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”?')){ localStorage.clear(); showMessage('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.','success'); closeRosterModal(); loadStudentStatus(); } }
    function logout(){ if(confirm('ì •ë§ë¡œ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) location.href='login.html'; }

    /* ========== ì´ˆê¸° ë¡œë“œ ========== */
    document.addEventListener('DOMContentLoaded', ()=>{
      loadSavedRosters();        // âœ… ìƒë‹¨ â€œì €ì¥ëœ ëª…ë¶€â€ ê°±ì‹ 
      loadStudentStatus();       // í˜„í™©íŒ
      loadActivityList();        // í™œë™ëª©ë¡
    });

    /* ===== í™œë™ ì •ë³´(ê¸°ì¡´) ===== */
    function addActivityInfo(){ /* ë„¤ ì›ë³¸ í•¨ìˆ˜ ê·¸ëŒ€ë¡œ */ }
    function loadActivityList(){ /* ë„¤ ì›ë³¸ í•¨ìˆ˜ ê·¸ëŒ€ë¡œ */ }
    function removeActivity(id){ /* ë„¤ ì›ë³¸ í•¨ìˆ˜ ê·¸ëŒ€ë¡œ */ }
    function clearAllActivities(){ /* ë„¤ ì›ë³¸ í•¨ìˆ˜ ê·¸ëŒ€ë¡œ */ }
    function toggleStudentDetail(h){ const c=h.nextElementSibling,a=h.querySelector('span:last-child'); if(c.classList.contains('expanded')){c.classList.remove('expanded'); a.textContent='â–¼';}else{c.classList.add('expanded'); a.textContent='â–²';} }
    function updateClassInfo(){ /* ì‚¬ìš© ì¤‘ì´ë©´ ìœ ì§€ */ }
  </script>
</body>
</html>




