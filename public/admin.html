<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì˜¤ëŠ˜ì˜ ì—ì´ìŠ¤ëŠ”? - ê´€ë¦¬ì</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* ====== ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ ====== */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Arial',sans-serif;background-color:#fff8f0;min-height:100vh;display:flex}
    .sidebar{width:220px;background:#fff;border-right:3px solid #ffe0b3;padding:20px;box-shadow:3px 0 10px rgba(255,217,61,.1)}
    .sidebar-header{text-align:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #fff5e6}
    .sidebar-header h2{color:#2d3748;font-size:16px;font-weight:700;margin-bottom:5px}
    .sidebar-header p{color:#4a5568;font-size:11px}
    .menu-item{display:block;width:100%;padding:12px 15px;margin-bottom:8px;background:#fff5e6;border:2px solid #ffe0b3;border-radius:10px;color:#2d3748;text-decoration:none;font-weight:600;text-align:center;font-size:12px;cursor:pointer;transition:.2s}
    .menu-item.active,.menu-item:hover{background:#ffd93d;transform:translateY(-1px)}
    .logout-btn{margin-top:20px;padding:8px 12px;background:#ffb3b3;border:2px solid #ff9999;border-radius:8px;color:#2d3748;font-weight:600;cursor:pointer;width:100%;font-size:11px}
    .main-content{flex:1;padding:25px;overflow-y:auto}
    .page-header{text-align:center;margin-bottom:25px}
    .page-header h1{color:#2d3748;font-size:26px;font-weight:700;margin-bottom:8px}
    .page-header p{color:#4a5568;font-size:15px}
    .page-content{display:none}.page-content.active{display:block}
    .card{background:#fff;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,.05)}
    .card.orange{border:3px solid #ffe0b3;background:#fffbf5}
    .card.purple{border:3px solid #e0c4ff;background:#faf7ff}
    .card h3{color:#2d3748;margin-bottom:15px;font-size:16px;text-align:center}
    .class-selector{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
    .class-selector select,.class-selector input{padding:8px 12px;border:2px solid #ffd93d;border-radius:8px;font-size:14px;background:#fff}
    .class-selector button{background:#ffd93d;color:#2d3748;border:none;padding:8px 15px;border-radius:8px;font-weight:600;cursor:pointer;transition:.2s}
    .class-selector button:hover{background:#ffb700;transform:translateY(-1px)}
    .student-status-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-bottom:20px}
    .student-card{background:#fff;border:2px solid #e2e8f0;border-radius:10px;padding:15px;text-align:center;transition:.2s}
    .student-card.completed{border-color:#68d391;background:#f0fff4}
    .student-card.pending{border-color:#fed7af;background:#fffaf0}
    .student-card.not-started{border-color:#feb2b2;background:#fef5f5}
    .student-name{font-weight:700;color:#2d3748;margin-bottom:5px}
    .student-status{font-size:12px;padding:4px 8px;border-radius:12px;color:#fff}
    .status-completed{background:#48bb78}.status-pending{background:#ed8936}.status-not-started{background:#e53e3e}
    .roster-management{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
    .file-upload{border:2px dashed #ffd93d;border-radius:10px;padding:20px;text-align:center;cursor:pointer;transition:.2s}
    .file-upload:hover{border-color:#ffb700;background:#fffbf5}
    .file-upload input{display:none}
    .stats-controls{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px}
    .stats-results{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .student-detail{border:1px solid #e2e8f0;border-radius:8px;margin-bottom:10px;overflow:hidden}
    .student-header{background:#f7fafc;padding:10px 15px;font-weight:700;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
    .student-content{padding:15px;display:none}.student-content.expanded{display:block}
    .competency-stat{display:flex;justify-content:space-between;margin-bottom:8px;padding:5px 10px;background:#f8f9fa;border-radius:5px}
    .download-btn{background:#c77dff;color:#fff;border:none;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;transition:.2s}
    .download-btn:hover{background:#a855f7;transform:translateY(-1px)}
    @media (max-width:1000px){.roster-management{grid-template-columns:1fr}.stats-controls{grid-template-columns:repeat(2,1fr)}.stats-results{grid-template-columns:1fr}}
    @media (max-width:768px){body{flex-direction:column}.sidebar{width:100%;padding:15px}.main-content{padding:20px}.class-selector{flex-direction:column;align-items:stretch}.stats-controls{grid-template-columns:1fr}.student-status-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}}
    .success-message{background:#e6fffa;color:#234e52;padding:10px 15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #81e6d9}
    .error-message{background:#ffe6e6;color:#c53030;padding:10px 15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #fc8181}

    /* ====== ì €ì¥ëœ ëª…ë¶€ ì¹´ë“œ ====== */
    .roster-item{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid #f0f0f0;border-radius:12px;margin:8px 0;background:#fff}
    .roster-main{flex:1}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid #ffe0b3;background:#fff5e6;margin-left:6px}
    .tiny-btn{border:none;border-radius:6px;padding:6px 10px;font-size:12px;cursor:pointer}
    .btn-danger{background:#e53e3e;color:#fff}
    .btn-danger:hover{filter:brightness(0.95)}
    .tiny-check{display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer}
  </style>
</head>
<body>
  <!-- ì‚¬ì´ë“œë°” -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>ğŸ‘¨â€ğŸ« ê´€ë¦¬ì ë©”ë‰´</h2>
      <p>ì„ ìƒë‹˜, ì•ˆë…•í•˜ì„¸ìš”!</p>
    </div>
    <button class="menu-item active" onclick="showPage('status', this)">ğŸ“‹ í˜„í™© í˜ì´ì§€</button>
    <!-- ğŸ”§ ì˜¤íƒ€ ìˆ˜ì • -->
    <button class="menu-item" onclick="showPage('statistics', this)">ğŸ“Š í†µê³„ í˜ì´ì§€</button>
    <button class="logout-btn" onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <!-- ë©”ì¸ -->
  <div class="main-content">
    <div class="page-header">
      <h1>ğŸ¯ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
      <p>í•™ìƒë“¤ì˜ í‰ê°€ í˜„í™©ê³¼ í†µê³„ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</p>
    </div>

    <!-- í˜„í™© í˜ì´ì§€ -->
    <div id="statusPage" class="page-content active">
      <div class="card orange">
        <h3>ğŸ« í´ë˜ìŠ¤ ê´€ë¦¬</h3>
        <div class="class-selector" style="justify-content:center;gap:12px;">
          <button onclick="showRosterModal()" style="background:#c77dff;color:#fff">ëª…ë¶€ ì—…ë¡œë“œ</button>
          <button onclick="downloadTemplate()">ì–‘ì‹ ë‹¤ìš´ë¡œë“œ (CSV)</button>
        </div>
      </div>

      <div id="classInfo" style="text-align:center;color:#666;margin-bottom:15px;">í˜„ì¬ ì¡°íšŒ: ì „ì²´</div>

      <!-- ì €ì¥ëœ ëª…ë¶€ -->
      <div class="card orange" id="rosterListCard">
        <h3>ğŸ“š ì €ì¥ëœ ëª…ë¶€</h3>
        <p id="saved-roster-empty" style="text-align:center;color:#888">ì €ì¥ëœ ëª…ë¶€ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì—…ë¡œë“œ í•´ ì£¼ì„¸ìš”.</p>
        <div id="rosterList" style="font-size:13px;color:#2d3748;"></div>
      </div>

      <!-- í•™ìƒ í˜„í™©íŒ -->
      <div class="card purple">
        <h3>ğŸ‘¥ í•™ìƒ í˜„í™©íŒ</h3>
        <div id="studentStatusGrid" class="student-status-grid">
          <div style="grid-column:1/-1;text-align:center;color:#666;padding:20px;">
            í´ë˜ìŠ¤ë¥¼ ì„ íƒí•˜ê³  ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
          </div>
        </div>
        <div style="text-align:center;margin-top:15px;">
          <span style="margin-right:20px;">
            <span class="student-status status-completed">ì™„ë£Œ</span>
            <span id="completedCount" style="margin-left:5px;font-size:14px;">0ëª…</span>
          </span>
          <span style="margin-right:20px;">
            <span class="student-status status-pending">ë¶€ë¶„ì™„ë£Œ</span>
            <span id="pendingCount" style="margin-left:5px;font-size:14px;">0ëª…</span>
          </span>
          <span>
            <span class="student-status status-not-started">ë¯¸ì‹œì‘</span>
            <span id="notStartedCount" style="margin-left:5px;font-size:14px;">0ëª…</span>
          </span>
        </div>
      </div>
    </div>

    <!-- í†µê³„ í˜ì´ì§€ -->
    <div id="statisticsPage" class="page-content">
      <div class="card orange">
        <h3>ğŸ“ˆ í†µê³„ ì¡°íšŒ</h3>
        <div class="stats-controls">
          <select id="statsYear"><option value="2024">2024ë…„</option><option value="2025" selected>2025ë…„</option></select>
          <select id="statsRosterSelect" style="min-width:180px"><option value="">ì „ì²´ ëª…ë¶€</option></select>
          <div style="display:flex;gap:10px;align-items:center;">
            <input type="date" id="startDate" style="padding:8px;border:2px solid #c77dff;border-radius:8px;">
            <span>~</span>
            <input type="date" id="endDate" style="padding:8px;border:2px solid #c77dff;border-radius:8px;">
          </div>
        </div>
        <div style="text-align:center;margin-top:10px;">
          <button onclick="loadStatistics()" style="background:#c77dff;color:#fff;border:none;padding:10px 20px;border-radius:8px;font-weight:600;">í†µê³„ ì¡°íšŒ</button>
        </div>
      </div>

      <div class="stats-results">
        <div class="card purple">
          <h3>ğŸ“Š ê°œì¸ë³„ í†µê³„</h3>
          <div style="margin-bottom:15px;text-align:right;">
            <button class="download-btn" onclick="downloadExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
          </div>
          <div id="statisticsResults">
            <div style="text-align:center;color:#666;padding:20px;">í†µê³„ ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
          </div>
        </div>

        <div class="card orange">
          <h3>ğŸ“ˆ ì „ì²´ ìš”ì•½</h3>
          <div id="summaryStats">
            <div style="text-align:center;color:#666;padding:20px;">í†µê³„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>

          <!-- í™œë™ ì •ë³´ ê´€ë¦¬ (ê¸°ì¡´) -->
          <div style="margin-top:20px;padding-top:20px;border-top:2px solid #fff5e6;">
            <h4 style="text-align:center;margin-bottom:15px;color:#2d3748;">ğŸ“ í™œë™ ì •ë³´ ê´€ë¦¬</h4>
            <div style="display:flex;gap:10px;margin-bottom:15px;">
              <input type="date" id="activityDate" style="flex:1;padding:8px;border:2px solid #ffd93d;border-radius:8px;">
              <input type="text" id="activityName" placeholder="í™œë™ëª… (ì˜ˆ: ëª¨ë‘  í† ë¡ )" style="flex:2;padding:8px;border:2px solid #ffd93d;border-radius:8px;">
              <button onclick="addActivityInfo()" style="background:#ffd93d;color:#2d3748;border:none;padding:8px 15px;border-radius:8px;font-weight:600;white-space:nowrap;">ì¶”ê°€</button>
            </div>
            <div id="activityList" style="max-height:150px;overflow-y:auto;"></div>
            <div style="text-align:center;margin-top:10px;">
              <button onclick="clearAllActivities()" style="background:#e53e3e;color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:12px;">ì „ì²´ ì‚­ì œ</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ëª…ë¶€ ì—…ë¡œë“œ ëª¨ë‹¬ (ìƒëµ: ê¸°ì¡´ê³¼ ë™ì¼) -->
  <div id="rosterModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:28px;border-radius:16px;width:min(560px,92%);">
      <h3 style="margin-bottom:16px;text-align:center;">ğŸ“‹ ëª…ë¶€ ì—…ë¡œë“œ</h3>

      <div style="display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center;margin-bottom:14px;">
        <div style="font-weight:600;">ì¹´í…Œê³ ë¦¬ ì¢…ë¥˜</div>
        <div>
          <label style="margin-right:12px;"><input type="radio" name="catType" value="subject" checked> ê³¼ëª©</label>
          <label><input type="radio" name="catType" value="club"> ë™ì•„ë¦¬</label>
        </div>
        <div style="font-weight:600;">ì¹´í…Œê³ ë¦¬ ì´ë¦„</div>
        <div><input id="categoryName" placeholder="ì˜ˆ) êµ­ì–´ / ì½”ë”©í´ëŸ½" style="width:100%;padding:8px 10px;border:2px solid #ffd93d;border-radius:8px;"></div>
      </div>

      <div class="file-upload" onclick="document.getElementById('csvFile').click()">
        <input type="file" id="csvFile" accept=".csv,.xlsx,.xls" onchange="handleFileUpload(event)">
        <div>ğŸ“ CSV ë˜ëŠ” Excel íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</div>
        <div style="font-size:12px;color:#666;margin-top:5px;">í˜•ì‹: <strong>ì´ë¦„, í•™ë²ˆ</strong> (ì¹´í…Œê³ ë¦¬ëŠ” ìœ„ì—ì„œ ë¯¸ë¦¬ ì§€ì •)</div>
        <div style="text-align:center;margin-top:10px;">
          <button type="button" onclick="downloadTemplate()" style="background:#ffd93d;color:#2d3748;border:none;padding:8px 14px;border-radius:8px;font-weight:600;">ğŸ“¥ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
        </div>
      </div>

      <div id="rosterPreview" style="margin-top:12px;max-height:180px;overflow:auto;border:1px dashed #eee;border-radius:8px;padding:8px;font-size:13px;color:#2d3748;">
        íŒŒì¼ì„ ì„ íƒí•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
      </div>

      <div style="margin-top:12px;text-align:right;">
        <button id="btnSaveRoster" type="button" onclick="saveRoster()" style="background:#5c7cfa;color:#fff;border:none;padding:8px 14px;border-radius:8px;font-weight:600;" disabled>ì €ì¥</button>
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:18px;">
        <button onclick="clearAllData()" style="background:#e53e3e;color:#fff;border:none;padding:8px 14px;border-radius:8px;">ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
        <button onclick="closeRosterModal()" style="background:#4a5568;color:#fff;border:none;padding:8px 14px;border-radius:8px;">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <script>
    // â–¼ ì „ì—­ ì„ íƒ ìƒíƒœ (ê°€ì¥ ìœ„ì— ë‘ê¸°)
    let SELECTED_ROSTER_ID = null;
    let SELECTED_ROSTER_TITLE = '';

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ê³µí†µ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function readJsonSafe(res){
      try{ return await res.clone().json(); }
      catch{ let t=''; try{ t=await res.text(); }catch{}; return {success:false,error:(t && t.slice(0,200))||`HTTP ${res.status}`} }
    }
    async function getJson(url){
      const r = await fetch(url,{credentials:'include', cache:'no-store'});
      const j = await readJsonSafe(r);
      if(!r.ok || j.success===false) throw new Error(j.error || `HTTP ${r.status}`);
      return j;
    }
    async function postJson(url, body){
      const r = await fetch(url,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body:JSON.stringify(body||{})
      });
      const j = await readJsonSafe(r);
      if(!r.ok || j.success===false) throw new Error(j.error || `HTTP ${r.status}`);
      return j;
    }
    
    // â–¼ ë‚ ì§œë¥¼ 'YYYY-MM-DD'ë¡œ ì •ê·œí™”
    function dateKey(v){
      if (!v) return '';
      // Firestore Timestamp ëŒ€ì‘
      if (typeof v === 'object') {
        if (typeof v.toDate === 'function') v = v.toDate();
        else if (typeof v.seconds === 'number') v = new Date(v.seconds * 1000);
      }
      const s = String(v);
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return `${m[1]}-${m[2]}-${m[3]}`;
      const d = new Date(s);
      if (isNaN(+d)) return '';
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${mm}-${dd}`;
    }
      
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ teacherId í™•ë³´ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    let TEACHER_ID =
      sessionStorage.getItem('teacherId') ||
      sessionStorage.getItem('username') || '';

    let _whoamiOnce = null;
    async function ensureTeacherId() {
      if (TEACHER_ID) return TEACHER_ID;
      if (!_whoamiOnce) {
        _whoamiOnce = fetch('/api/auth/whoami', { credentials:'include', cache:'no-store' })
        .then(async (r)=>{ if(!r.ok) throw 0; const j=await r.json();
          TEACHER_ID = j?.teacherId || j?.uid || j?.email || 'T_DEFAULT';
          sessionStorage.setItem('teacherId', TEACHER_ID);
          return TEACHER_ID;
        })
        .catch(()=> {
          TEACHER_ID = sessionStorage.getItem('teacherId') || sessionStorage.getItem('username') || 'T_DEFAULT';
          return TEACHER_ID;
        });
      }
      return _whoamiOnce;
    }
    function getTeacherId(){ return TEACHER_ID || 'T_DEFAULT'; }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ í˜ì´ì§€ ì „í™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function showPage(pageType, el){
      document.querySelectorAll('.menu-item').forEach(b=>b.classList.remove('active'));
      if (el) el.classList.add('active');
      document.querySelectorAll('.page-content').forEach(x=>x.classList.remove('active'));
      if(pageType==='status'){
        document.getElementById('statusPage').classList.add('active');
        loadStudentStatus({ forceEmpty: true });
      }else{
        document.getElementById('statisticsPage').classList.add('active');
        loadStatistics();
      }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì €ì¥ëœ ëª…ë¶€ ëª©ë¡ (í˜„í™©) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function rosterTitle(r){ return r.title || r.name || r.categoryName || 'ëª…ë¶€'; }
    function rosterCount(r){ return (r.itemCount ?? r.count ?? r.studentCount ?? 0); }

    async function loadSavedRosters() {
      const box = document.getElementById('rosterList');
      const empty = document.getElementById('saved-roster-empty');
      if (!box) return;
      box.innerHTML = '<div style="padding:8px;color:#666">ì €ì¥ëœ ëª…ë¶€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';

      try {
        const tid = await ensureTeacherId();
        const { rosters } = await getJson('/api/admin/list-rosters?teacherId=' + encodeURIComponent(tid));

        if (!rosters || rosters.length === 0) {
          box.innerHTML = '';
          empty.style.display = '';
          return;
        }
        empty.style.display = 'none';

        box.innerHTML = rosters.map(r => {
          const title = rosterTitle(r);
          const cnt = rosterCount(r);
          const active = !!(r.active || r.published);
          return `
            <div class="roster-item">
              <div class="roster-main js-view" data-id="${r.id}" data-title="${title}">
                <div style="font-weight:700">${title}
                  <span class="tag">${cnt}ëª…</span>
                  ${active ? '<span class="tag" style="border-color:#c7ffe0;background:#f2fff8">ë…¸ì¶œì¤‘</span>' : ''}
                </div>
                <div style="color:#888;font-size:12px">id: ${r.id}</div>
              </div>
              <label class="tiny-check">
                <input type="checkbox" ${active ? 'checked':''} data-id="${r.id}" class="js-publish"> í˜„í™©íŒ ë…¸ì¶œ
              </label>
              <button class="tiny-btn btn-danger js-del" data-id="${r.id}">ì‚­ì œ</button>
            </div>
          `;
        }).join('');

        // â–¶ ëª…ë¶€ ë³¸ë¬¸ í´ë¦­ â†’ í•´ë‹¹ ëª…ë¶€ë¡œ í˜„í™©íŒ ì¡°íšŒ
        box.querySelectorAll('.js-view').forEach(el => {
          el.onclick = async () => {
            SELECTED_ROSTER_ID = el.dataset.id;
            SELECTED_ROSTER_TITLE = el.dataset.title || '';
            await loadStudentStatus({ rosterId: SELECTED_ROSTER_ID });
          };
        });

        // â–¶ ë…¸ì¶œ í† ê¸€
        box.querySelectorAll('.js-publish').forEach(el => {
          el.onchange = async () => {
            const publish = el.checked;
            const thisId  = el.dataset.id;
            el.disabled = true;
            try {
              const tid = await ensureTeacherId();
              await postJson('/api/admin/publish-roster?teacherId=' + encodeURIComponent(tid), {
                rosterId: thisId, publish
              });
              await refreshStatsFiltersFromRosters();

              if (publish) {
                SELECTED_ROSTER_ID = thisId;
                const viewEl = box.querySelector(`.js-view[data-id="${thisId}"]`);
                SELECTED_ROSTER_TITLE = viewEl?.dataset.title || '';
                await loadStudentStatus({ rosterId: SELECTED_ROSTER_ID });
              } else {
                if (SELECTED_ROSTER_ID === thisId) {
                  SELECTED_ROSTER_ID = null;
                  SELECTED_ROSTER_TITLE = '';
                  await loadStudentStatus({ forceEmpty: true });
                } else if (SELECTED_ROSTER_ID) {
                  await loadStudentStatus({ rosterId: SELECTED_ROSTER_ID });
                } else {
                  await loadStudentStatus({ forceEmpty: true });
                }
              }
            } catch (e) {
              alert('ë…¸ì¶œ ì„¤ì • ì‹¤íŒ¨: ' + (e.message || 'unknown'));
              el.checked = !publish;
            } finally {
              el.disabled = false;
            }
          };
        });

        // â–¶ ì‚­ì œ
        box.querySelectorAll('.js-del').forEach(btn => {
          btn.onclick = async () => {
            if (!confirm('ì´ ëª…ë¶€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const deletedId = btn.dataset.id;
            btn.disabled = true;
            try {
              const tid = await ensureTeacherId();
              await postJson('/api/admin/delete-roster?teacherId=' + encodeURIComponent(tid), {
               rosterId: deletedId
              });

              if (SELECTED_ROSTER_ID === deletedId) {
                SELECTED_ROSTER_ID = null;
                SELECTED_ROSTER_TITLE = '';
                await loadStudentStatus({ forceEmpty: true });
              } else if (SELECTED_ROSTER_ID) {
                await loadStudentStatus({ rosterId: SELECTED_ROSTER_ID });
              } else {
                await loadStudentStatus({ forceEmpty: true });
              }

              await loadSavedRosters();
              await refreshStatsFiltersFromRosters();
            } catch (e) {
              alert('ì‚­ì œ ì‹¤íŒ¨: ' + (e.message || 'unknown'));
            } finally {
              btn.disabled = false;
            }
          };
        });

      } catch (e) {
        console.error(e);
        box.innerHTML = '<div style="padding:8px;color:#c53030">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì—…ë¡œë“œ (ê¸°ì¡´) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const UP = { preview: [] };
    function getUploadMeta(){
      const type = (document.querySelector('input[name="catType"]:checked')?.value)||'subject';
      const name = document.getElementById('categoryName')?.value?.trim()||'';
      return { type, name };
    }
    function renderPreview(){
      const box = document.getElementById('rosterPreview');
      const btn = document.getElementById('btnSaveRoster');
      if(!UP.preview.length){
        box.textContent = 'íŒŒì¼ì„ ì„ íƒí•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.';
        btn.disabled = true; return;
      }
      box.innerHTML = `
        <div style="margin-bottom:6px;color:#666;">ì´ ${UP.preview.length}ëª…</div>
        <ul style="list-style:none;padding:0;margin:0">
          ${UP.preview.map(r=>`<li style="padding:4px 0;border-bottom:1px solid #f2f2f2">${r.studentId} - ${r.name}</li>`).join('')}
        </ul>`;
      btn.disabled = false;
    }
    function showRosterModal(){ UP.preview=[]; renderPreview(); document.getElementById('categoryName').value=''; document.getElementById('rosterModal').style.display='flex'; }
    function closeRosterModal(){ document.getElementById('rosterModal').style.display='none'; }

    function parseCSV(text){ return text.replace(/\r/g,'').split('\n').map(l=>l.split(',').map(c=>(c??'').trim())).filter(c=>c.some(x=>x)); }
    function handleFileUpload(ev){
      const file = ev.target.files?.[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          let rows;
          if(file.name.toLowerCase().endsWith('.csv')){
            const buf = new Uint8Array(e.target.result);
            let txt=''; try{ txt=new TextDecoder('utf-8',{fatal:true}).decode(buf); }
            catch{ try{ txt=new TextDecoder('euc-kr').decode(buf);}catch{ txt=new TextDecoder().decode(buf);} }
            rows = parseCSV(String(txt||''));
          }else{
            const wb = XLSX.read(e.target.result,{type:'binary'});
            rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});
          }
          if(!rows || !rows.length){ UP.preview=[]; renderPreview(); showMessage('íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.','error'); return; }
          const first = String(rows[0].join(',')).replace(/\s/g,'');
          if (/(ì´ë¦„|name).*(í•™ë²ˆ|id)/i.test(first)) rows.shift();
          const seen = new Set();
          UP.preview = rows
            .map(r=>r.map(c=>(c??'').toString().trim()))
            .filter(r=>r[0] && r[1])
            .filter(r=>{ const ok=!seen.has(r[1]); if(ok) seen.add(r[1]); return ok; })
            .map(r=>({name:r[0],studentId:r[1]}));
          renderPreview();
          showMessage('íŒŒì¼ì„ ì½ì—ˆìŠµë‹ˆë‹¤. ì €ì¥ì„ ëˆŒëŸ¬ ì—…ë¡œë“œí•˜ì„¸ìš”.','success');
        }catch(err){
          console.error(err); UP.preview=[]; renderPreview(); showMessage('íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.','error');
        }
      };
      if(file.name.toLowerCase().endsWith('.csv')) reader.readAsArrayBuffer(file);
      else reader.readAsBinaryString(file);
    }

    async function saveRoster(){
      const { type, name } = getUploadMeta();
      if(!name){ showMessage('ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.','error'); return; }
      if(!UP.preview.length){ showMessage('ì—…ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.','error'); return; }

      const roster = UP.preview.map(r=>({
        username:r.studentId, password:r.name, name:r.name, studentId:r.studentId,
        subject:type==='subject'?name:'', club:type==='club'?name:''
      }));

      try{
        const tid = await ensureTeacherId();
        const url = '/api/admin/import-students?teacherId=' + encodeURIComponent(tid);
        await postJson(url, { skipExisting:true, categoryType:type, categoryName:name, roster });

        showMessage(`ëª…ë¶€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ì´ ${roster.length}ëª…)`, 'success');
        UP.preview=[]; renderPreview(); closeRosterModal();
        await loadSavedRosters();
        await refreshStatsFiltersFromRosters();
        await loadStudentStatus({ forceEmpty:true }); // ì—…ë¡œë“œ ì§í›„ ìë™í‘œì‹œ ê¸ˆì§€
      }catch(e){
        try{
          const tid = await ensureTeacherId();
          const url2 = '/api/admin/import-students?teacherId=' + encodeURIComponent(tid);
          await postJson(url2, { skipExisting:true, students: roster });
          showMessage(`ëª…ë¶€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ì´ ${roster.length}ëª…)`, 'success');
          UP.preview=[]; renderPreview(); closeRosterModal();
          await loadSavedRosters();
          await loadStudentStatus({ forceEmpty:true });
        }catch(e2){
          showMessage(`ì„œë²„ ì—…ë¡œë“œ ì‹¤íŒ¨: ${e2.message}`,'error');
        }
      }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ í•™ìƒ í˜„í™© â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function loadStudentStatus(opts = {}) {
      const { rosterId = null, forceEmpty = false } = opts;

      if (!rosterId || (forceEmpty && !rosterId)) {
        renderStudentStatusEmpty();
        document.getElementById('classInfo').textContent = 'í˜„ì¬ ì¡°íšŒ: (ì„ íƒ í•„ìš”)';
        return;
      }

      try {
        const tid = await ensureTeacherId();

        const rid = encodeURIComponent(rosterId);
        const url =
          `/api/admin/list-students?teacherId=${encodeURIComponent(tid)}&_=${Date.now()}` +
          `&rosterId=${rid}&rid=${rid}&roster=${rid}`;

        const res = await fetch(url, { cache: 'no-store', credentials: 'include' });
        const j = await res.json();
        if (!res.ok || j.success === false) throw new Error(j.error || 'ì¡°íšŒ ì‹¤íŒ¨');
    
        let students = Array.isArray(j.students) ? j.students : [];
        students = students.filter(s => {
          const r = (s.rosterId || s.roster || s.rid);
          const t = (s.teacherId || s.tid || s.ownerId);
          return r === rosterId && (!t || t === tid);
        });

        document.getElementById('classInfo').textContent =
          `í˜„ì¬ ì¡°íšŒ: ${SELECTED_ROSTER_TITLE || 'ì„ íƒëœ ëª…ë¶€'}`;

        if (!students.length) { renderStudentStatusEmpty(); return; }
    
        const normalized = students.map(s => ({
          name: s.name,
          studentId: s.studentId,
          status: s.status || 'not-started',
          hasPeerEvaluation: !!s.hasPeerEvaluation,
          hasSelfEvaluation: !!s.hasSelfEvaluation,
          lastUpdate: s.lastUpdate || '-'
        }));
        displayStudentStatus(normalized);
      } catch (e) {
        console.error('í˜„í™© ì¡°íšŒ ì˜¤ë¥˜:', e);
        showMessage('í˜„í™© ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        renderStudentStatusEmpty();
      }
    }

    function renderStudentStatusEmpty(){
      const grid=document.getElementById('studentStatusGrid');
      grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:#666;padding:20px;">
        ì €ì¥ëœ(í™œì„±) ëª…ë¶€ê°€ ì—†ìŠµë‹ˆë‹¤. <strong>ì €ì¥ëœ ëª…ë¶€</strong>ì—ì„œ í˜„í™©íŒ ë…¸ì¶œì„ ì¼œì„¸ìš”.</div>`;
      document.getElementById('completedCount').textContent='0ëª…';
      document.getElementById('pendingCount').textContent='0ëª…';
      document.getElementById('notStartedCount').textContent='0ëª…';
    }
    function displayStudentStatus(students){
      const grid=document.getElementById('studentStatusGrid');
      const statusCounts={completed:0,pending:0,'not-started':0};
      if(!students.length){ renderStudentStatusEmpty(); return; }
      grid.innerHTML = students.map(st=>{
        statusCounts[st.status]++;
        const statusText={completed:'ì™„ë£Œ',pending:'ë¶€ë¶„ì™„ë£Œ','not-started':'ë¯¸ì‹œì‘'};
        const detailText={
          completed:'ë™ë£Œí‰ê°€ âœ“ ìê¸°í‰ê°€ âœ“',
          pending: st.hasPeerEvaluation&&!st.hasSelfEvaluation?'ë™ë£Œí‰ê°€ âœ“ ìê¸°í‰ê°€ âœ—'
                 :!st.hasPeerEvaluation&&st.hasSelfEvaluation?'ë™ë£Œí‰ê°€ âœ— ìê¸°í‰ê°€ âœ“'
                 :'ë™ë£Œí‰ê°€ âœ“ ìê¸°í‰ê°€ âœ—',
          'not-started':'ë™ë£Œí‰ê°€ âœ— ìê¸°í‰ê°€ âœ—'
        };
        return `<div class="student-card ${st.status}" title="${detailText[st.status]}">
          <div class="student-name">${st.name}</div>
          <div class="student-status status-${st.status}">${statusText[st.status]}</div>
          <div style="font-size:10px;color:#666;margin-top:5px;">${st.lastUpdate}</div>
          <div style="font-size:9px;color:#999;margin-top:2px;">${detailText[st.status]}</div>
        </div>`;
      }).join('');
      document.getElementById('completedCount').textContent=statusCounts.completed+'ëª…';
      document.getElementById('pendingCount').textContent=statusCounts.pending+'ëª…';
      document.getElementById('notStartedCount').textContent=statusCounts['not-started']+'ëª…';
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ í†µê³„(ìš”ì•½) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const COMPETENCIES=['ìì‹ ê°ê³¼ ë¦¬ë”ì‹­','ë¶„ì„','ì•„ì´ë””ì–´ ë±…í¬','ê°ì • ì´í•´','ì˜ì‚¬ì†Œí†µ','í˜‘ë™ì‹¬'];
    let currentStatsData=[]; // [{studentId,name,counts:{},total}]
    // â–¼ í™œë™ëª…ì„ ë‚ ì§œë¡œ ë¹ ë¥´ê²Œ ì°¾ê¸° ìœ„í•œ ì „ì—­ ë§µ
    let CURRENT_ACTIVITY_MAP = {}; // { 'YYYY-MM-DD': 'í™œë™ëª…' }

    // ì„œë²„ì—ì„œ í™œë™ëª©ë¡ ê°€ì ¸ì™€ ë‚ ì§œâ†’í™œë™ëª… ë§µìœ¼ë¡œ ë³€í™˜
    async function getActivityMapFromServer({ teacherId, rosterId, start, end }) {
      try {
        const qs = new URLSearchParams({
          teacherId,
          rosterId: rosterId || '',
          start: (start || '').toString(),
          end:   (end   || '').toString()
        }).toString();
        const r = await fetch('/api/admin/list-activities?' + qs,
          { credentials:'include', cache:'no-store' });
        const j = await r.json();
        if (!r.ok || j.success === false) throw new Error(j.error || 'í™œë™ ì¡°íšŒ ì‹¤íŒ¨');

        const map = {};
        (j.activities || []).forEach(a => {
          const d = dateKey(a.date);
          const t = a.title || a.name || a.activity || '';
          if (d && t) map[d] = t;
        });
        return map;
      } catch (e) {
       console.warn('[getActivityMapFromServer] fail:', e);
        return {};
      }
    }

    // ëª…ë¶€ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
    async function refreshStatsFiltersFromRosters() {
      const sel = document.getElementById('statsRosterSelect');
      if (!sel) return;
      try {
        const tid = await ensureTeacherId();
        const { rosters = [] } = await getJson('/api/admin/list-rosters?teacherId=' + encodeURIComponent(tid));
        const titleOf = (r) => (r?.categoryName || r?.title || 'ë¬´ì œ ëª…ë¶€') + (r?.categoryType ? ` Â· ${r.categoryType}` : '');
        const countOf = (r) => (r?.itemCount ?? r?.count ?? 0);
        const opts = [
          '<option value="">ì „ì²´ ëª…ë¶€</option>',
          ...rosters.map(r=>`<option value="${r.id}">${titleOf(r)} (${countOf(r)}ëª…)</option>`)
        ];
        sel.innerHTML = opts.join('');
      } catch (e) {
        console.warn('[refreshStatsFiltersFromRosters] fail:', e);
        document.getElementById('statsRosterSelect').innerHTML =
          '<option value="">ì „ì²´ ëª…ë¶€</option>';
      }
    }

    function pickReasonForTarget(p, idx, rawTarget) {
      // 1) ë°°ì—´í˜• ë§¤ì¹­ (nomineesì™€ ë™ì¼ ì¸ë±ìŠ¤)
      if (Array.isArray(p.reasons) && typeof p.reasons[idx] === 'string') {
        return p.reasons[idx];
      }
      // 2) ì´ë¦„/í•™ë²ˆ í‚¤ë¡œ ì˜¤ëŠ” ê²½ìš°(ì˜ˆ: { "í™ê¸¸ë™": "..." })
      if (p.reasonsByName && typeof p.reasonsByName === 'object') {
        const t = (rawTarget||'').toString().trim();
        if (t && typeof p.reasonsByName[t] === 'string') return p.reasonsByName[t];
      }
      // 3) ë‹¨ì¼ reason í•„ë“œ
      if (typeof p.reason === 'string') return p.reason;
      // 4) ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´
      return '';
    }

    // ---- ê´€ë¦¬ììš© í‰ê°€ ì „ì²´ ì¡°íšŒ (ì—¬ëŸ¬ ì¡°í•©ì„ ìˆœì°¨ ì‹œë„; ì ˆëŒ€ throw ì•ˆ í•¨)
    async function fetchAllEvaluationsForAdmin(tid) {
      const cand = [
        `/api/get-evaluations?all=1&teacherId=${encodeURIComponent(tid)}`,
        `/api/get-evaluations?all=1`,
        `/api/get-evaluations?teacherId=${encodeURIComponent(tid)}`,
        `/api/get-evaluations`
      ];

      for (const u of cand) {
        console.log('[fetchAllEvaluationsForAdmin] try:', u);
        const { ok, status, data, raw } = await safeFetchJson(u);
       if (!ok) {
          console.warn('[get-evaluations] HTTP', status, data?.error || raw?.slice(0,120));
          continue;
        }
        // ë‹¤ì–‘í•œ ìŠ¤í‚¤ë§ˆ(evaluations/items/ë£¨íŠ¸ë°°ì—´) ì§€ì›
        const arr =
          (Array.isArray(data?.evaluations) && data.evaluations) ||
          (Array.isArray(data?.items) && data.items) ||
          (Array.isArray(data) && data) ||
          [];
        console.log('[fetchAllEvaluationsForAdmin] got', arr.length, 'items from', u);
        if (arr.length) return arr;  // ì²« ì„±ê³µ ì±„íƒ
        // ì„±ê³µì´ì§€ë§Œ ë¹„ì–´ìˆìœ¼ë©´ ë‹¤ìŒ í›„ë³´ë„ ì‹œë„
      }
      console.warn('[fetchAllEvaluationsForAdmin] no data from all candidates. return []');
      return [];
    }
    
    async function safeFetchJson(url) {
      try {
        const r = await fetch(url, { credentials:'include', cache:'no-store' });
        const raw = await r.clone().text();
        let data = null; try { data = JSON.parse(raw); } catch {}
        return { ok:r.ok, status:r.status, data, raw };
      } catch (e) {
        return { ok:false, status:0, data:null, raw:String(e||'') };
      }
    }
     
    // â˜…â˜…â˜… í†µê³„ ì¡°íšŒ êµ¬í˜„  â€” [ì „ì²´ êµì²´]
    async function loadStatistics(){
      const resultBox = document.getElementById('statisticsResults');
      const summaryBox = document.getElementById('summaryStats');
      resultBox.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
      summaryBox.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
    
      try{
        // 0) teacherId ë¨¼ì € í™•ë³´ (â† ì´ì „ ReferenceError ì›ì¸)
        const tid = await ensureTeacherId();
    
        const rosterId = (document.getElementById('statsRosterSelect')?.value || '').trim();
        const fromStr  = (document.getElementById('startDate')?.value || '').trim();
        const toStr    = (document.getElementById('endDate')?.value || '').trim();
        const from = fromStr ? new Date(fromStr) : null;
        const to   = toStr   ? new Date(toStr)   : null;
    
        // 1) í™œë™ ë§µ(ë‚ ì§œâ†’í™œë™ëª…) ì„ ì¡°íšŒ
        CURRENT_ACTIVITY_MAP = await getActivityMapFromServer({
          teacherId: tid,
          rosterId,
          start: fromStr,
          end: toStr
        });
    
        // 2) (ì„ íƒ) ëª…ë¶€ í•™ìƒ ëª©ë¡ â†’ í•™ë²ˆâ†”ì´ë¦„ ë§¤í•‘
        const idToName = {};
        const nameToId = {};
        if (rosterId){
          try{
            const rid = encodeURIComponent(rosterId);
            const j = await getJson(`/api/admin/list-students?teacherId=${encodeURIComponent(tid)}&rosterId=${rid}&rid=${rid}`);
            const arr = Array.isArray(j.students) ? j.students : [];
            arr.forEach(s=>{
              if (!s) return;
              const id = (s.studentId || s.username || '').toString().trim();
              const nm = (s.name || s.studentName || '').toString().trim();
              if (id)  idToName[id] = nm || id;
              if (nm)  nameToId[nm] = id || nm;
            });
          }catch(e){ /* ì¡°ìš©íˆ ê³„ì† */ }
        }
        const rosterIds   = new Set(Object.keys(idToName));                   // í•™ë²ˆ set
        const rosterNames = new Set(Object.values(idToName).filter(Boolean)); // ì´ë¦„ set

        // âœ… ì¶”ê°€ (ì—¬ê¸°! pickReasonForTarget ì•„ë‹˜)
        const norm = s => (s ?? '').toString().trim().toLowerCase();
        const rosterIdsNorm   = new Set(Object.keys(idToName).map(norm));
        const rosterNamesNorm = new Set(Object.values(idToName).filter(Boolean).map(norm));
    
        // 3) ì „ì²´ í‰ê°€ ê°€ì ¸ì˜¤ê¸°(ê´€ë¦¬ì ë£¨íŠ¸)  â† all=1 ì‚¬ìš©
        const evals = await fetchAllEvaluationsForAdmin(tid);
        // console.log('[loadStatistics] evals length =', Array.isArray(evals)?evals.length:-1);
        const rawCount = Array.isArray(evals) ? evals.length : 0;
        let inRangeCount = 0;
        let rosterPassCount = 0;

        // ë°ì´í„° 0ê±´ì´ë©´ ì¦‰ì‹œ ì¢…ë£Œ
        if (!rawCount) {
          resultBox.innerHTML  = '<div style="text-align:center;color:#666;padding:20px;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (ì›ë³¸ 0ê±´)</div>';
          summaryBox.innerHTML = `
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:14px;">
              <div class="competency-stat"><span>ì´ ì¶”ì²œ ìˆ˜</span><strong>0</strong></div>
              <div class="competency-stat"><span>ê°€ì¥ ë§ì´ ë°›ì€ ì—­ëŸ‰</span><strong>-</strong></div>
              <div class="competency-stat"><span>í•™ìƒ ìˆ˜</span><strong>0</strong></div>
            </div>
            ${COMPETENCIES.map(c=>`<div class="competency-stat"><span>${c}</span><strong>0</strong></div>`).join('')}
          `;
          return;
        }
    
        // 3-1) ë°ì´í„° ì—†ìœ¼ë©´ ì¦‰ì‹œ ì¢…ë£Œ(ìŠ¤í”¼ë„ˆ ì œê±°)
        if (!Array.isArray(evals) || evals.length === 0) {
         resultBox.innerHTML  = '<div style="text-align:center;color:#666;padding:20px;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          summaryBox.innerHTML = `
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:14px;">
              <div class="competency-stat"><span>ì´ ì¶”ì²œ ìˆ˜</span><strong>0</strong></div>
              <div class="competency-stat"><span>ê°€ì¥ ë§ì´ ë°›ì€ ì—­ëŸ‰</span><strong>-</strong></div>
              <div class="competency-stat"><span>í•™ìƒ ìˆ˜</span><strong>0</strong></div>
            </div>
            ${COMPETENCIES.map(c=>`<div class="competency-stat"><span>${c}</span><strong>0</strong></div>`).join('')}
          `;
          return;
        }
    
        // ë‚ ì§œ í•„í„°
        const inRange = (dstr)=>{
          if (!from && !to) return true;
          const d = new Date((dstr||'').toString().slice(0,10)); // YYYY-MM-DD
          if (Number.isNaN(+d)) return true;
          if (from && d < from) return false;
          if (to   && d > to)   return false;
          return true;
        };
    
        // 4) ì§‘ê³„: í•™ìƒë³„ { totals, reasons }
        const map = new Map(); // key: studentId(or ì´ë¦„)
        const ensureRow = (sid, displayName)=>{
          const key = sid || displayName;
          if (!map.has(key)){
            const totals = {}; COMPETENCIES.forEach(c=>totals[c]=0);
            map.set(key, {
              studentId: sid || '',
              name: displayName || sid || 'í•™ìƒ',
              totals,
              reasons: {}
            });
          }
          return map.get(key);
        };
    
        evals.forEach(ev=>{
          const dateStr = dateKey(ev.date || ev.timestamp);
          if (!inRange(dateStr)) return;
          inRangeCount++;
    
          const peer = Array.isArray(ev.peerEvaluations) ? ev.peerEvaluations : [];
          peer.forEach(p=>{
            const comp = p.competency;
            if (!COMPETENCIES.includes(comp)) return;
    
            // nominees(ë°°ì—´) ë˜ëŠ” name(ë‹¨ì¼) ëª¨ë‘ ì§€ì›
            let targets = [];
            if (Array.isArray(p.nominees)) targets = p.nominees;
            else if (p.name) targets = [p.name];
    
            const reasonsArr   = Array.isArray(p.reasons) ? p.reasons : null; // nomineesì™€ index ë§¤ì¹­
            const singleReason = p.reason || null;
    
            targets.forEach((raw, idx)=>{
              // rawê°€ ë¬¸ìì—´ ë˜ëŠ” {name, studentId} ê°™ì€ ê°ì²´ì¼ ìˆ˜ ìˆìŒ â†’ ì •ê·œí™”
              let t  = '', sid = '', nm = '';
              if (typeof raw === 'string') {
                t   = raw.trim();
                sid = t;
                nm  = idToName[t] || '';
              } else if (raw && typeof raw === 'object') {
                sid = (raw.studentId || raw.username || raw.id || '').toString().trim();
                nm  = (raw.name || raw.studentName || '').toString().trim();
                t   = nm || sid;
              } else {
                t = String(raw || '').trim();
                sid = t;
                nm  = idToName[t] || '';
              }
    
              // ëª…ë¶€ ë§¤í•‘ ë³´ì •
              if (!nm && nameToId[t]) {
                sid = nameToId[t];
                nm  = idToName[sid] || t;
              }

              // ëª…ë¶€ í•„í„°
             if (rosterId){
                const tNorm   = norm(t);       // raw ë¬¸ìì—´(ì´ë¦„/ì•„ì´ë”” ë‘˜ ì¤‘ í•˜ë‚˜ì¼ ìˆ˜ ìˆìŒ)
                const sidNorm = norm(sid);     // ìš°ë¦¬ê°€ í•´ì„í•œ id í›„ë³´

                // ë¬¸ìì—´ì´ ì´ë¦„ìœ¼ë¡œë„, ì•„ì´ë””ë¡œë„ ë“¤ì–´ì˜¬ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë‘˜ ë‹¤ í—ˆìš©
                const okById   = rosterIdsNorm.has(sidNorm) || rosterIdsNorm.has(tNorm);
                const okByName = rosterNamesNorm.has(tNorm);

                if (!okById && !okByName) return;
              }
              rosterPassCount++;
    
              // ëŒ€ìƒìë³„ ì´ìœ  ì„ íƒ
              let reasonText = '';
              if (reasonsArr && typeof reasonsArr[idx] === 'string') reasonText = reasonsArr[idx];
              else if (singleReason) reasonText = singleReason;
    
              const row = ensureRow(sid, nm || t);
              row.totals[comp] = (row.totals[comp]||0) + 1;
    
              if (!Array.isArray(row.reasons[comp])) row.reasons[comp] = [];
              row.reasons[comp].push({
                text: reasonText || '',
                date: dateStr || '',
                activity: CURRENT_ACTIVITY_MAP[dateStr] || '',
                from: ev.evaluatorUsername || ev.evaluator || ''
              });
            });
          });
        });
    
        const byStudent = Array.from(map.values()).sort(
          (a,b)=> (Object.values(b.totals||{}).reduce((x,y)=>x+(+y||0),0)) -
                  (Object.values(a.totals||{}).reduce((x,y)=>x+(+y||0),0)) ||
                  a.name.localeCompare(b.name,'ko')
        );
        currentStatsData = byStudent;
    
        // 5) ë Œë”ë§
        const resultBoxHtml = byStudent.length
          ? byStudent.map(st=>{
              const total = Object.values(st.totals||{}).reduce((a,b)=>a+(+b||0),0);
              return `
                <div class="student-detail">
                  <div class="student-header" onclick="toggleStudentDetail(this)">
                    <span>${st.name}${st.studentId?` <small style="color:#888">(${st.studentId})</small>`:''}</span>
                    <span>ì´ ${total} â–¼</span>
                  </div>
                  <div class="student-content">
                    ${renderCompetencyBlocks(st)}
                  </div>
                </div>`;
          }).join('')
          : `<div style="text-align:center;color:#666;padding:20px;">
               ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
               <small>(ì›ë³¸: ${rawCount}ê±´, ê¸°ê°„ í†µê³¼: ${inRangeCount}ê±´, ëª…ë¶€/ì´ë¦„ ë§¤ì¹­: ${rosterId ? rosterPassCount : 'â€”'}ê±´)</small>
             </div>`;
        resultBox.innerHTML = resultBoxHtml;
    
        // ì „ì²´ ìš”ì•½
        const totalByComp = {}; COMPETENCIES.forEach(c=>totalByComp[c]=0);
        let totalAll = 0;
        byStudent.forEach(st=>{
          COMPETENCIES.forEach(c=> totalByComp[c] += (+st.totals[c]||0));
          totalAll += Object.values(st.totals||{}).reduce((a,b)=>a+(+b||0),0);
        });
        const top = COMPETENCIES.slice().sort((a,b)=> totalByComp[b]-totalByComp[a])[0] || '-';
    
        summaryBox.innerHTML = `
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:14px;">
            <div class="competency-stat"><span>ì´ ì¶”ì²œ ìˆ˜</span><strong>${totalAll}</strong></div>
            <div class="competency-stat"><span>ê°€ì¥ ë§ì´ ë°›ì€ ì—­ëŸ‰</span><strong>${top}</strong></div>
            <div class="competency-stat"><span>í•™ìƒ ìˆ˜</span><strong>${byStudent.length}</strong></div>
          </div>
          ${COMPETENCIES.map(c=>`<div class="competency-stat"><span>${c}</span><strong>${totalByComp[c]}</strong></div>`).join('')}
        `;
      }catch(e){
        console.error(e);
        showMessage('í†µê³„ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (e.message||'unknown'), 'error');
        document.getElementById('statisticsResults').innerHTML =
          '<div style="text-align:center;color:#c53030;padding:20px;">í†µê³„ ì¡°íšŒ ì‹¤íŒ¨</div>';
        document.getElementById('summaryStats').innerHTML =
          '<div style="text-align:center;color:#c53030;padding:20px;">í†µê³„ ì¡°íšŒ ì‹¤íŒ¨</div>';
      }
    }

    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    function downloadExcel(){
      if (!currentStatsData || !currentStatsData.length){
        showMessage('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.','error');
        return;
      }

      // ì‹œíŠ¸1: ê°œì¸ë³„ í†µê³„ (í•©ê³„ë§Œ)
      const rows1 = currentStatsData.map(st=>{
        const obj = { í•™ë²ˆ: st.studentId || '', ì´ë¦„: st.name || '' };
        COMPETENCIES.forEach(c => obj[c] = +((st.totals||{})[c] || 0));
        obj['ì´í•©'] = Object.values(st.totals||{}).reduce((a,b)=>a+(+b||0),0);
        return obj;
      });
      const ws1 = XLSX.utils.json_to_sheet(rows1);

      // ì‹œíŠ¸2: ì´ìœ  ìƒì„¸ (ì—­ëŸ‰ë³„ ì´ìœ /ë‚ ì§œ/í™œë™/ì¶”ì²œì)
      const rows2 = [];
      currentStatsData.forEach(st=>{
        COMPETENCIES.forEach(c=>{
          const list = (st.reasons && Array.isArray(st.reasons[c])) ? st.reasons[c] : [];
          if (!list.length){
            // ì´ìœ ê°€ ì „í˜€ ì—†ì„ ë•Œë„ í•œ ì¤„ ë‚¨ê²¨ë‘ê³  ì‹¶ìœ¼ë©´ ì£¼ì„ í•´ì œ
            // rows2.push({í•™ë²ˆ:st.studentId||'',ì´ë¦„:st.name||'',ì—­ëŸ‰:c,íšŸìˆ˜:0,ì´ìœ :'',ë‚ ì§œ:'',í™œë™:'',ì¶”ì²œì:''});
            return;
          }
          list.forEach(r=>{
            rows2.push({
              í•™ë²ˆ: st.studentId || '',
              ì´ë¦„: st.name || '',
              ì—­ëŸ‰: c,
              ì´ìœ : (r.text || '').toString(),
              ë‚ ì§œ: (r.date || '').toString().slice(0,10),
              í™œë™: r.activity || '',
              ì¶”ì²œì: r.from || ''
            });
          });
        });
      });
      const ws2 = XLSX.utils.json_to_sheet(rows2);

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws1, 'ê°œì¸ë³„ í†µê³„');
      XLSX.utils.book_append_sheet(wb, ws2, 'ì´ìœ  ìƒì„¸');
      XLSX.writeFile(wb, 'ì—ì´ìŠ¤_í†µê³„.xlsx');
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ê³µìš© UI â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function showMessage(msg,type){
      const old=document.querySelector('.success-message,.error-message'); if(old) old.remove();
      const div=document.createElement('div'); div.className=(type==='success'?'success-message':'error-message'); div.textContent=msg;
      const active=document.querySelector('.page-content.active'); const first=active.querySelector('.card'); active.insertBefore(div,first);
      setTimeout(()=>div.remove(),3000);
    }
    function downloadTemplate(){
      const csv=['ì´ë¦„,í•™ë²ˆ','í™ê¸¸ë™,20250001','ê¹€ë‚˜ë˜,20250002'].join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='ëª…ë¶€_ì–‘ì‹.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    function clearAllData(){ if(confirm('ì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”?')){ localStorage.clear(); showMessage('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.','success'); closeRosterModal(); loadStudentStatus(); } }
    function logout(){ if(confirm('ì •ë§ë¡œ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) location.href='login.html'; }

    // ì €ì¥ëœ ëª…ë¶€ â†’ í†µê³„ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
    function setSelectOptions(sel, items){
      if (!sel) return;
      const keep = sel.value;
      sel.innerHTML =
        '<option value="">ì „ì²´</option>' +
        items.sort((a,b)=>a.localeCompare(b,'ko'))
             .map(v=>`<option value="${v}">${v}</option>`).join('');
      if ([...sel.options].some(o=>o.value===keep)) sel.value = keep;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì´ˆê¸° ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    document.addEventListener('DOMContentLoaded', async ()=>{
      await ensureTeacherId();
      await refreshStatsFiltersFromRosters();       // ëª…ë¶€ ë“œë¡­ë‹¤ìš´
      await loadSavedRosters();                     // ì €ì¥ëœ ëª…ë¶€ ì¹´ë“œ
      await loadStudentStatus({ forceEmpty: true }); // í˜„í™©ì€ ë¹ˆ í™”ë©´ì—ì„œ ì‹œì‘
      loadActivityList();                           // í™œë™ ëª©ë¡ (ê¸°ì¡´)
      // â–¼ ì´ ì„¸ ê°€ì§€ê°€ ë°”ë€Œë©´ í™œë™ ëª©ë¡ ê°±ì‹ 
      document.getElementById('statsRosterSelect')?.addEventListener('change', loadActivityList);
      document.getElementById('startDate')?.addEventListener('change', loadActivityList);
      document.getElementById('endDate')?.addEventListener('change', loadActivityList);
    });

    /* í™œë™ ì •ë³´(ê¸°ì¡´ ìë¦¬ì±„ì›€) */
    // ì„ íƒëœ ëª…ë¶€ id
    function _selectedRosterId() {
      const sel = document.getElementById('statsRosterSelect');
      return sel && sel.value ? sel.value : '';
    }

    // í™œë™ ëª©ë¡ UI ë Œë”
    function renderActivityList(items) {
      const box = document.getElementById('activityList');
      if (!box) return;
      if (!items.length) {
        box.innerHTML = '<div style="color:#888">ë“±ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      box.innerHTML = items.map(a => `
        <div style="display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed #eee">
          <div><strong>${a.date}</strong> Â· ${a.name}</div>
          <button onclick="removeActivity('${a.id}','${a.rosterId}','${a.date}')" class="tiny-btn btn-danger">ì‚­ì œ</button>
        </div>
      `).join('');
    }

    // í™œë™ ë¶ˆëŸ¬ì˜¤ê¸° (ì„ íƒ ëª…ë¶€ + ë‚ ì§œë²”ìœ„)
    async function loadActivityList() {
      const rosterId = _selectedRosterId();
      const activityBox = document.getElementById('activityList');
      if (activityBox) activityBox.innerHTML = '<div style="color:#666">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
      try {
        const tid   = await ensureTeacherId();
        const start = (document.getElementById('startDate')?.value || '');
        const end   = (document.getElementById('endDate')?.value   || '');
        const qs = new URLSearchParams({ teacherId: tid, rosterId, start, end }).toString();

        const j = await getJson(`/api/admin/list-activities?${qs}`);
        renderActivityList(j.activities || []);
      } catch (e) {
        showMessage('í™œë™ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ' + (e.message||''), 'error');
        if (activityBox) activityBox.innerHTML = '';
      }
    }

    // í™œë™ ì¶”ê°€/ìˆ˜ì • (ë²„íŠ¼ "ì¶”ê°€"ê°€ ì´ í•¨ìˆ˜ë¥¼ í˜¸ì¶œ)
    async function addActivityInfo() {
      const rosterId = _selectedRosterId();
      const date = document.getElementById('activityDate')?.value?.slice(0,10);
      const name = document.getElementById('activityName')?.value?.trim();

      if (!rosterId) return showMessage('ë¨¼ì € í†µê³„ ì¡°íšŒ ìƒë‹¨ì—ì„œ ëª…ë¶€ë¥¼ ì„ íƒí•˜ì„¸ìš”.', 'error');
      if (!date || !name) return showMessage('ë‚ ì§œì™€ í™œë™ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');

      try {
        const tid = await ensureTeacherId();
        await postJson(`/api/admin/upsert-activity?teacherId=${encodeURIComponent(tid)}`, {
          rosterId, date, name
        });
        document.getElementById('activityName').value = '';
        await loadActivityList();
        showMessage('í™œë™ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      } catch (e) {
        showMessage('í™œë™ ì €ì¥ ì‹¤íŒ¨: ' + (e.message||''), 'error');
      }
    }

    // í™œë™ ì‚­ì œ
    async function removeActivity(id, rosterId, date) {
      if (!confirm('ì‚­ì œí• ê¹Œìš”?')) return;
      try {
        const tid = await ensureTeacherId();
        await postJson(`/api/admin/delete-activity?teacherId=${encodeURIComponent(tid)}`, {
          id, rosterId, date
        });
        await loadActivityList();
        showMessage('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      } catch (e) {
        showMessage('ì‚­ì œ ì‹¤íŒ¨: ' + (e.message||''), 'error');
      }
    }

    // (ì˜µì…˜) í˜„ì¬ ëª…ë¶€ì˜ í™œë™ ì „ì²´ ì‚­ì œ
    async function clearAllActivities() {
      if (!confirm('ì´ ëª…ë¶€ì˜ í™œë™ì„ ì „ë¶€ ì‚­ì œí• ê¹Œìš”?')) return;
      const rosterId = _selectedRosterId();
      try {
        const tid = await ensureTeacherId();
        const j = await getJson(`/api/admin/list-activities?teacherId=${encodeURIComponent(tid)}&rosterId=${encodeURIComponent(rosterId)}`);
        for (const a of (j.activities||[])) {
          await postJson(`/api/admin/delete-activity?teacherId=${encodeURIComponent(tid)}`, { id:a.id });
        }
        await loadActivityList();
        showMessage('ì „ì²´ ì‚­ì œ ì™„ë£Œ', 'success');
      } catch (e) {
        showMessage('ì „ì²´ ì‚­ì œ ì‹¤íŒ¨: ' + (e.message||''), 'error');
      }
    }

    function toggleStudentDetail(h){ const c=h.nextElementSibling,a=h.querySelector('span:last-child'); if(c.classList.contains('expanded')){c.classList.remove('expanded'); a.textContent='â–¼';}else{c.classList.add('expanded'); a.textContent='â–²';} }
    function updateClassInfo(){ /* í•„ìš”ì‹œ ì‚¬ìš© */ }

    // í•œ í•™ìƒì˜ ì—­ëŸ‰ë³„ ìƒì„¸(íšŸìˆ˜ + ì´ìœ  ëª©ë¡[í™œë™/ë‚ ì§œ/ì¶”ì²œì]) ë Œë”
    function renderCompetencyBlocks(s){
      const totals  = s.totals || {};
      const reasons = s.reasons || {};

      return COMPETENCIES.map(c => {
        const cnt = +totals[c] || 0;
        const list = Array.isArray(reasons[c]) ? reasons[c] : [];

        const body = list.length
          ? list.map(r=>{
              const d   = (r.date || '').toString().slice(0,10);
              const act = r.activity || (CURRENT_ACTIVITY_MAP[d] || '');
              const by  = r.from ? ` Â· by ${r.from}` : '';
              const actBadge = act ? ` <span style="color:#805ad5; font-size:12px;">[${act}]</span>` : '';
              const dateBadge= d   ? ` <span style="color:#718096; font-size:12px;">${d}</span>` : '';
              const txt = (r.text || r.reason || '').toString().trim() || '(ì´ìœ  ë¯¸ê¸°ì¬)';
              return `<li style="margin:4px 0; line-height:1.5;">
                <span style="color:#1a202c;">${txt}</span>${actBadge}${dateBadge}<span style="color:#a0aec0; font-size:12px;">${by}</span>
              </li>`;
            }).join('')
          : `<li style="color:#a0aec0;">ì´ìœ  ê¸°ë¡ ì—†ìŒ</li>`;

        return `
          <div class="competency-stat" style="flex-direction:column; align-items:stretch;">
            <div style="display:flex; justify-content:space-between; font-weight:600;">
              <span>${c}</span><span>${cnt}íšŒ</span>
            </div>
            <ul style="margin-top:6px; padding-left:18px;">${body}</ul>
          </div>`;
      }).join('');
    }

  </script>
</body>
</html>

























