<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>오늘의 에이스는? - 관리자</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* ====== 기존 스타일 유지 ====== */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Arial',sans-serif;background-color:#fff8f0;min-height:100vh;display:flex}
    .sidebar{width:220px;background:#fff;border-right:3px solid #ffe0b3;padding:20px;box-shadow:3px 0 10px rgba(255,217,61,.1)}
    .sidebar-header{text-align:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #fff5e6}
    .sidebar-header h2{color:#2d3748;font-size:16px;font-weight:700;margin-bottom:5px}
    .sidebar-header p{color:#4a5568;font-size:11px}
    .menu-item{display:block;width:100%;padding:12px 15px;margin-bottom:8px;background:#fff5e6;border:2px solid #ffe0b3;border-radius:10px;color:#2d3748;text-decoration:none;font-weight:600;text-align:center;font-size:12px;cursor:pointer;transition:.2s}
    .menu-item.active,.menu-item:hover{background:#ffd93d;transform:translateY(-1px)}
    .logout-btn{margin-top:20px;padding:8px 12px;background:#ffb3b3;border:2px solid #ff9999;border-radius:8px;color:#2d3748;font-weight:600;cursor:pointer;width:100%;font-size:11px}
    .main-content{flex:1;padding:25px;overflow-y:auto}
    .page-header{text-align:center;margin-bottom:25px}
    .page-header h1{color:#2d3748;font-size:26px;font-weight:700;margin-bottom:8px}
    .page-header p{color:#4a5568;font-size:15px}
    .page-content{display:none}.page-content.active{display:block}
    .card{background:#fff;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,.05)}
    .card.orange{border:3px solid #ffe0b3;background:#fffbf5}
    .card.purple{border:3px solid #e0c4ff;background:#faf7ff}
    .card h3{color:#2d3748;margin-bottom:15px;font-size:16px;text-align:center}
    .class-selector{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
    .class-selector select,.class-selector input{padding:8px 12px;border:2px solid #ffd93d;border-radius:8px;font-size:14px;background:#fff}
    .class-selector button{background:#ffd93d;color:#2d3748;border:none;padding:8px 15px;border-radius:8px;font-weight:600;cursor:pointer;transition:.2s}
    .class-selector button:hover{background:#ffb700;transform:translateY(-1px)}
    .student-status-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-bottom:20px}
    .student-card{background:#fff;border:2px solid #e2e8f0;border-radius:10px;padding:15px;text-align:center;transition:.2s}
    .student-card.completed{border-color:#68d391;background:#f0fff4}
    .student-card.pending{border-color:#fed7af;background:#fffaf0}
    .student-card.not-started{border-color:#feb2b2;background:#fef5f5}
    .student-name{font-weight:700;color:#2d3748;margin-bottom:5px}
    .student-status{font-size:12px;padding:4px 8px;border-radius:12px;color:#fff}
    .status-completed{background:#48bb78}.status-pending{background:#ed8936}.status-not-started{background:#e53e3e}
    .roster-management{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
    .file-upload{border:2px dashed #ffd93d;border-radius:10px;padding:20px;text-align:center;cursor:pointer;transition:.2s}
    .file-upload:hover{border-color:#ffb700;background:#fffbf5}
    .file-upload input{display:none}
    .stats-controls{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px}
    .stats-results{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .student-detail{border:1px solid #e2e8f0;border-radius:8px;margin-bottom:10px;overflow:hidden}
    .student-header{background:#f7fafc;padding:10px 15px;font-weight:700;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
    .student-content{padding:15px;display:none}.student-content.expanded{display:block}
    .competency-stat{display:flex;justify-content:space-between;margin-bottom:8px;padding:5px 10px;background:#f8f9fa;border-radius:5px}
    .download-btn{background:#c77dff;color:#fff;border:none;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;transition:.2s}
    .download-btn:hover{background:#a855f7;transform:translateY(-1px)}
    @media (max-width:1000px){.roster-management{grid-template-columns:1fr}.stats-controls{grid-template-columns:repeat(2,1fr)}.stats-results{grid-template-columns:1fr}}
    @media (max-width:768px){body{flex-direction:column}.sidebar{width:100%;padding:15px}.main-content{padding:20px}.class-selector{flex-direction:column;align-items:stretch}.stats-controls{grid-template-columns:1fr}.student-status-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}}
    .success-message{background:#e6fffa;color:#234e52;padding:10px 15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #81e6d9}
    .error-message{background:#ffe6e6;color:#c53030;padding:10px 15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #fc8181}

    /* ====== 저장된 명부 카드 ====== */
    .roster-item{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid #f0f0f0;border-radius:12px;margin:8px 0;background:#fff}
    .roster-main{flex:1}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid #ffe0b3;background:#fff5e6;margin-left:6px}
    .tiny-btn{border:none;border-radius:6px;padding:6px 10px;font-size:12px;cursor:pointer}
    .btn-danger{background:#e53e3e;color:#fff}
    .btn-danger:hover{filter:brightness(0.95)}
    .tiny-check{display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer}
  </style>
</head>
<body>
  <!-- 사이드바 -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>👨‍🏫 관리자 메뉴</h2>
      <p>선생님, 안녕하세요!</p>
    </div>
    <button class="menu-item active" onclick="showPage('status', this)">📋 현황 페이지</button>
    <!-- 🔧 오타 수정 -->
    <button class="menu-item" onclick="showPage('statistics', this)">📊 통계 페이지</button>
    <button class="logout-btn" onclick="logout()">🚪 로그아웃</button>
  </div>

  <!-- 메인 -->
  <div class="main-content">
    <div class="page-header">
      <h1>🎯 관리자 대시보드</h1>
      <p>학생들의 평가 현황과 통계를 관리하세요</p>
    </div>

    <!-- 현황 페이지 -->
    <div id="statusPage" class="page-content active">
      <div class="card orange">
        <h3>🏫 클래스 관리</h3>
        <div class="class-selector" style="justify-content:center;gap:12px;">
          <button onclick="showRosterModal()" style="background:#c77dff;color:#fff">명부 업로드</button>
          <button onclick="downloadTemplate()">양식 다운로드 (CSV)</button>
        </div>
      </div>

      <div id="classInfo" style="text-align:center;color:#666;margin-bottom:15px;">현재 조회: 전체</div>

      <!-- 저장된 명부 -->
      <div class="card orange" id="rosterListCard">
        <h3>📚 저장된 명부</h3>
        <p id="saved-roster-empty" style="text-align:center;color:#888">저장된 명부가 없습니다. 먼저 업로드 해 주세요.</p>
        <div id="rosterList" style="font-size:13px;color:#2d3748;"></div>
      </div>

      <!-- 학생 현황판 -->
      <div class="card purple">
        <h3>👥 학생 현황판</h3>
        <div id="studentStatusGrid" class="student-status-grid">
          <div style="grid-column:1/-1;text-align:center;color:#666;padding:20px;">
            클래스를 선택하고 조회 버튼을 눌러주세요.
          </div>
        </div>
        <div style="text-align:center;margin-top:15px;">
          <span style="margin-right:20px;">
            <span class="student-status status-completed">완료</span>
            <span id="completedCount" style="margin-left:5px;font-size:14px;">0명</span>
          </span>
          <span style="margin-right:20px;">
            <span class="student-status status-pending">부분완료</span>
            <span id="pendingCount" style="margin-left:5px;font-size:14px;">0명</span>
          </span>
          <span>
            <span class="student-status status-not-started">미시작</span>
            <span id="notStartedCount" style="margin-left:5px;font-size:14px;">0명</span>
          </span>
        </div>
      </div>
    </div>

    <!-- 통계 페이지 -->
    <div id="statisticsPage" class="page-content">
      <div class="card orange">
        <h3>📈 통계 조회</h3>
        <div class="stats-controls">
          <select id="statsYear"><option value="2024">2024년</option><option value="2025" selected>2025년</option></select>
          <select id="statsRosterSelect" style="min-width:180px"><option value="">전체 명부</option></select>
          <div style="display:flex;gap:10px;align-items:center;">
            <input type="date" id="startDate" style="padding:8px;border:2px solid #c77dff;border-radius:8px;">
            <span>~</span>
            <input type="date" id="endDate" style="padding:8px;border:2px solid #c77dff;border-radius:8px;">
          </div>
        </div>
        <div style="text-align:center;margin-top:10px;">
          <button onclick="loadStatistics()" style="background:#c77dff;color:#fff;border:none;padding:10px 20px;border-radius:8px;font-weight:600;">통계 조회</button>
        </div>
      </div>

      <div class="stats-results">
        <div class="card purple">
          <h3>📊 개인별 통계</h3>
          <div style="margin-bottom:15px;text-align:right;">
            <button class="download-btn" onclick="downloadExcel()">📥 엑셀 다운로드</button>
          </div>
          <div id="statisticsResults">
            <div style="text-align:center;color:#666;padding:20px;">통계 조회 버튼을 눌러주세요.</div>
          </div>
        </div>

        <div class="card orange">
          <h3>📈 전체 요약</h3>
          <div id="summaryStats">
            <div style="text-align:center;color:#666;padding:20px;">통계 데이터를 불러오는 중...</div>
          </div>

          <!-- 활동 정보 관리 (기존) -->
          <div style="margin-top:20px;padding-top:20px;border-top:2px solid #fff5e6;">
            <h4 style="text-align:center;margin-bottom:15px;color:#2d3748;">📝 활동 정보 관리</h4>
            <div style="display:flex;gap:10px;margin-bottom:15px;">
              <input type="date" id="activityDate" style="flex:1;padding:8px;border:2px solid #ffd93d;border-radius:8px;">
              <input type="text" id="activityName" placeholder="활동명 (예: 모둠 토론)" style="flex:2;padding:8px;border:2px solid #ffd93d;border-radius:8px;">
              <button onclick="addActivityInfo()" style="background:#ffd93d;color:#2d3748;border:none;padding:8px 15px;border-radius:8px;font-weight:600;white-space:nowrap;">추가</button>
            </div>
            <div id="activityList" style="max-height:150px;overflow-y:auto;"></div>
            <div style="text-align:center;margin-top:10px;">
              <button onclick="clearAllActivities()" style="background:#e53e3e;color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:12px;">전체 삭제</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 명부 업로드 모달 (생략: 기존과 동일) -->
  <div id="rosterModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:28px;border-radius:16px;width:min(560px,92%);">
      <h3 style="margin-bottom:16px;text-align:center;">📋 명부 업로드</h3>

      <div style="display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center;margin-bottom:14px;">
        <div style="font-weight:600;">카테고리 종류</div>
        <div>
          <label style="margin-right:12px;"><input type="radio" name="catType" value="subject" checked> 과목</label>
          <label><input type="radio" name="catType" value="club"> 동아리</label>
        </div>
        <div style="font-weight:600;">카테고리 이름</div>
        <div><input id="categoryName" placeholder="예) 국어 / 코딩클럽" style="width:100%;padding:8px 10px;border:2px solid #ffd93d;border-radius:8px;"></div>
      </div>

      <div class="file-upload" onclick="document.getElementById('csvFile').click()">
        <input type="file" id="csvFile" accept=".csv,.xlsx,.xls" onchange="handleFileUpload(event)">
        <div>📁 CSV 또는 Excel 파일을 선택하세요</div>
        <div style="font-size:12px;color:#666;margin-top:5px;">형식: <strong>이름, 학번</strong> (카테고리는 위에서 미리 지정)</div>
        <div style="text-align:center;margin-top:10px;">
          <button type="button" onclick="downloadTemplate()" style="background:#ffd93d;color:#2d3748;border:none;padding:8px 14px;border-radius:8px;font-weight:600;">📥 양식 다운로드</button>
        </div>
      </div>

      <div id="rosterPreview" style="margin-top:12px;max-height:180px;overflow:auto;border:1px dashed #eee;border-radius:8px;padding:8px;font-size:13px;color:#2d3748;">
        파일을 선택하면 미리보기가 여기에 표시됩니다.
      </div>

      <div style="margin-top:12px;text-align:right;">
        <button id="btnSaveRoster" type="button" onclick="saveRoster()" style="background:#5c7cfa;color:#fff;border:none;padding:8px 14px;border-radius:8px;font-weight:600;" disabled>저장</button>
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:18px;">
        <button onclick="clearAllData()" style="background:#e53e3e;color:#fff;border:none;padding:8px 14px;border-radius:8px;">🗑️ 전체 초기화</button>
        <button onclick="closeRosterModal()" style="background:#4a5568;color:#fff;border:none;padding:8px 14px;border-radius:8px;">닫기</button>
      </div>
    </div>
  </div>

  <script>
    // ▼ 전역 선택 상태 (가장 위에 두기)
    let SELECTED_ROSTER_ID = null;
    let SELECTED_ROSTER_TITLE = '';

    /* ───────── 공통 유틸 ───────── */
    async function readJsonSafe(res){
      try{ return await res.clone().json(); }
      catch{ let t=''; try{ t=await res.text(); }catch{}; return {success:false,error:(t && t.slice(0,200))||`HTTP ${res.status}`} }
    }
    async function getJson(url){
      const r = await fetch(url,{credentials:'include', cache:'no-store'});
      const j = await readJsonSafe(r);
      if(!r.ok || j.success===false) throw new Error(j.error || `HTTP ${r.status}`);
      return j;
    }
    async function postJson(url, body){
      const r = await fetch(url,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body:JSON.stringify(body||{})
      });
      const j = await readJsonSafe(r);
      if(!r.ok || j.success===false) throw new Error(j.error || `HTTP ${r.status}`);
      return j;
    }
    
    // ▼ 날짜를 'YYYY-MM-DD'로 정규화
    function dateKey(v){
      if (!v) return '';
      // Firestore Timestamp 대응
      if (typeof v === 'object') {
        if (typeof v.toDate === 'function') v = v.toDate();
        else if (typeof v.seconds === 'number') v = new Date(v.seconds * 1000);
      }
      const s = String(v);
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return `${m[1]}-${m[2]}-${m[3]}`;
      const d = new Date(s);
      if (isNaN(+d)) return '';
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${mm}-${dd}`;
    }
      
    /* ───────── teacherId 확보 ───────── */
    let TEACHER_ID =
      sessionStorage.getItem('teacherId') ||
      sessionStorage.getItem('username') || '';

    let _whoamiOnce = null;
    async function ensureTeacherId() {
      if (TEACHER_ID) return TEACHER_ID;
      if (!_whoamiOnce) {
        _whoamiOnce = fetch('/api/auth/whoami', { credentials:'include', cache:'no-store' })
        .then(async (r)=>{ if(!r.ok) throw 0; const j=await r.json();
          TEACHER_ID = j?.teacherId || j?.uid || j?.email || 'T_DEFAULT';
          sessionStorage.setItem('teacherId', TEACHER_ID);
          return TEACHER_ID;
        })
        .catch(()=> {
          TEACHER_ID = sessionStorage.getItem('teacherId') || sessionStorage.getItem('username') || 'T_DEFAULT';
          return TEACHER_ID;
        });
      }
      return _whoamiOnce;
    }
    function getTeacherId(){ return TEACHER_ID || 'T_DEFAULT'; }

    /* ───────── 페이지 전환 ───────── */
    function showPage(pageType, el){
      document.querySelectorAll('.menu-item').forEach(b=>b.classList.remove('active'));
      if (el) el.classList.add('active');
      document.querySelectorAll('.page-content').forEach(x=>x.classList.remove('active'));
      if(pageType==='status'){
        document.getElementById('statusPage').classList.add('active');
        loadStudentStatus({ forceEmpty: true });
      }else{
        document.getElementById('statisticsPage').classList.add('active');
        loadStatistics();
      }
    }

    /* ───────── 저장된 명부 목록 (현황) ───────── */
    function rosterTitle(r){ return r.title || r.name || r.categoryName || '명부'; }
    function rosterCount(r){ return (r.itemCount ?? r.count ?? r.studentCount ?? 0); }

    async function loadSavedRosters() {
      const box = document.getElementById('rosterList');
      const empty = document.getElementById('saved-roster-empty');
      if (!box) return;
      box.innerHTML = '<div style="padding:8px;color:#666">저장된 명부를 불러오는 중…</div>';

      try {
        const tid = await ensureTeacherId();
        const { rosters } = await getJson('/api/admin/list-rosters?teacherId=' + encodeURIComponent(tid));

        if (!rosters || rosters.length === 0) {
          box.innerHTML = '';
          empty.style.display = '';
          return;
        }
        empty.style.display = 'none';

        box.innerHTML = rosters.map(r => {
          const title = rosterTitle(r);
          const cnt = rosterCount(r);
          const active = !!(r.active || r.published);
          return `
            <div class="roster-item">
              <div class="roster-main js-view" data-id="${r.id}" data-title="${title}">
                <div style="font-weight:700">${title}
                  <span class="tag">${cnt}명</span>
                  ${active ? '<span class="tag" style="border-color:#c7ffe0;background:#f2fff8">노출중</span>' : ''}
                </div>
                <div style="color:#888;font-size:12px">id: ${r.id}</div>
              </div>
              <label class="tiny-check">
                <input type="checkbox" ${active ? 'checked':''} data-id="${r.id}" class="js-publish"> 현황판 노출
              </label>
              <button class="tiny-btn btn-danger js-del" data-id="${r.id}">삭제</button>
            </div>
          `;
        }).join('');

        // ▶ 명부 본문 클릭 → 해당 명부로 현황판 조회
        box.querySelectorAll('.js-view').forEach(el => {
          el.onclick = async () => {
            SELECTED_ROSTER_ID = el.dataset.id;
            SELECTED_ROSTER_TITLE = el.dataset.title || '';
            await loadStudentStatus({ rosterId: SELECTED_ROSTER_ID });
          };
        });

        // ▶ 노출 토글
        box.querySelectorAll('.js-publish').forEach(el => {
          el.onchange = async () => {
            const publish = el.checked;
            const thisId  = el.dataset.id;
            el.disabled = true;
            try {
              const tid = await ensureTeacherId();
              await postJson('/api/admin/publish-roster?teacherId=' + encodeURIComponent(tid), {
                rosterId: thisId, publish
              });
              await refreshStatsFiltersFromRosters();

              if (publish) {
                SELECTED_ROSTER_ID = thisId;
                const viewEl = box.querySelector(`.js-view[data-id="${thisId}"]`);
                SELECTED_ROSTER_TITLE = viewEl?.dataset.title || '';
                await loadStudentStatus({ rosterId: SELECTED_ROSTER_ID });
              } else {
                if (SELECTED_ROSTER_ID === thisId) {
                  SELECTED_ROSTER_ID = null;
                  SELECTED_ROSTER_TITLE = '';
                  await loadStudentStatus({ forceEmpty: true });
                } else if (SELECTED_ROSTER_ID) {
                  await loadStudentStatus({ rosterId: SELECTED_ROSTER_ID });
                } else {
                  await loadStudentStatus({ forceEmpty: true });
                }
              }
            } catch (e) {
              alert('노출 설정 실패: ' + (e.message || 'unknown'));
              el.checked = !publish;
            } finally {
              el.disabled = false;
            }
          };
        });

        // ▶ 삭제
        box.querySelectorAll('.js-del').forEach(btn => {
          btn.onclick = async () => {
            if (!confirm('이 명부를 삭제하시겠습니까?')) return;
            const deletedId = btn.dataset.id;
            btn.disabled = true;
            try {
              const tid = await ensureTeacherId();
              await postJson('/api/admin/delete-roster?teacherId=' + encodeURIComponent(tid), {
               rosterId: deletedId
              });

              if (SELECTED_ROSTER_ID === deletedId) {
                SELECTED_ROSTER_ID = null;
                SELECTED_ROSTER_TITLE = '';
                await loadStudentStatus({ forceEmpty: true });
              } else if (SELECTED_ROSTER_ID) {
                await loadStudentStatus({ rosterId: SELECTED_ROSTER_ID });
              } else {
                await loadStudentStatus({ forceEmpty: true });
              }

              await loadSavedRosters();
              await refreshStatsFiltersFromRosters();
            } catch (e) {
              alert('삭제 실패: ' + (e.message || 'unknown'));
            } finally {
              btn.disabled = false;
            }
          };
        });

      } catch (e) {
        console.error(e);
        box.innerHTML = '<div style="padding:8px;color:#c53030">목록을 불러오지 못했습니다.</div>';
      }
    }

    /* ───────── 업로드 (기존) ───────── */
    const UP = { preview: [] };
    function getUploadMeta(){
      const type = (document.querySelector('input[name="catType"]:checked')?.value)||'subject';
      const name = document.getElementById('categoryName')?.value?.trim()||'';
      return { type, name };
    }
    function renderPreview(){
      const box = document.getElementById('rosterPreview');
      const btn = document.getElementById('btnSaveRoster');
      if(!UP.preview.length){
        box.textContent = '파일을 선택하면 미리보기가 여기에 표시됩니다.';
        btn.disabled = true; return;
      }
      box.innerHTML = `
        <div style="margin-bottom:6px;color:#666;">총 ${UP.preview.length}명</div>
        <ul style="list-style:none;padding:0;margin:0">
          ${UP.preview.map(r=>`<li style="padding:4px 0;border-bottom:1px solid #f2f2f2">${r.studentId} - ${r.name}</li>`).join('')}
        </ul>`;
      btn.disabled = false;
    }
    function showRosterModal(){ UP.preview=[]; renderPreview(); document.getElementById('categoryName').value=''; document.getElementById('rosterModal').style.display='flex'; }
    function closeRosterModal(){ document.getElementById('rosterModal').style.display='none'; }

    function parseCSV(text){ return text.replace(/\r/g,'').split('\n').map(l=>l.split(',').map(c=>(c??'').trim())).filter(c=>c.some(x=>x)); }
    function handleFileUpload(ev){
      const file = ev.target.files?.[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          let rows;
          if(file.name.toLowerCase().endsWith('.csv')){
            const buf = new Uint8Array(e.target.result);
            let txt=''; try{ txt=new TextDecoder('utf-8',{fatal:true}).decode(buf); }
            catch{ try{ txt=new TextDecoder('euc-kr').decode(buf);}catch{ txt=new TextDecoder().decode(buf);} }
            rows = parseCSV(String(txt||''));
          }else{
            const wb = XLSX.read(e.target.result,{type:'binary'});
            rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});
          }
          if(!rows || !rows.length){ UP.preview=[]; renderPreview(); showMessage('파일에 데이터가 없습니다.','error'); return; }
          const first = String(rows[0].join(',')).replace(/\s/g,'');
          if (/(이름|name).*(학번|id)/i.test(first)) rows.shift();
          const seen = new Set();
          UP.preview = rows
            .map(r=>r.map(c=>(c??'').toString().trim()))
            .filter(r=>r[0] && r[1])
            .filter(r=>{ const ok=!seen.has(r[1]); if(ok) seen.add(r[1]); return ok; })
            .map(r=>({name:r[0],studentId:r[1]}));
          renderPreview();
          showMessage('파일을 읽었습니다. 저장을 눌러 업로드하세요.','success');
        }catch(err){
          console.error(err); UP.preview=[]; renderPreview(); showMessage('파일 형식이 올바르지 않습니다.','error');
        }
      };
      if(file.name.toLowerCase().endsWith('.csv')) reader.readAsArrayBuffer(file);
      else reader.readAsBinaryString(file);
    }

    async function saveRoster(){
      const { type, name } = getUploadMeta();
      if(!name){ showMessage('카테고리 이름을 입력하세요.','error'); return; }
      if(!UP.preview.length){ showMessage('업로드할 데이터가 없습니다.','error'); return; }

      const roster = UP.preview.map(r=>({
        username:r.studentId, password:r.name, name:r.name, studentId:r.studentId,
        subject:type==='subject'?name:'', club:type==='club'?name:''
      }));

      try{
        const tid = await ensureTeacherId();
        const url = '/api/admin/import-students?teacherId=' + encodeURIComponent(tid);
        await postJson(url, { skipExisting:true, categoryType:type, categoryName:name, roster });

        showMessage(`명부가 저장되었습니다. (총 ${roster.length}명)`, 'success');
        UP.preview=[]; renderPreview(); closeRosterModal();
        await loadSavedRosters();
        await refreshStatsFiltersFromRosters();
        await loadStudentStatus({ forceEmpty:true }); // 업로드 직후 자동표시 금지
      }catch(e){
        try{
          const tid = await ensureTeacherId();
          const url2 = '/api/admin/import-students?teacherId=' + encodeURIComponent(tid);
          await postJson(url2, { skipExisting:true, students: roster });
          showMessage(`명부가 저장되었습니다. (총 ${roster.length}명)`, 'success');
          UP.preview=[]; renderPreview(); closeRosterModal();
          await loadSavedRosters();
          await loadStudentStatus({ forceEmpty:true });
        }catch(e2){
          showMessage(`서버 업로드 실패: ${e2.message}`,'error');
        }
      }
    }

    /* ───────── 학생 현황 ───────── */
    async function loadStudentStatus(opts = {}) {
      const { rosterId = null, forceEmpty = false } = opts;

      if (!rosterId || (forceEmpty && !rosterId)) {
        renderStudentStatusEmpty();
        document.getElementById('classInfo').textContent = '현재 조회: (선택 필요)';
        return;
      }

      try {
        const tid = await ensureTeacherId();

        const rid = encodeURIComponent(rosterId);
        const url =
          `/api/admin/list-students?teacherId=${encodeURIComponent(tid)}&_=${Date.now()}` +
          `&rosterId=${rid}&rid=${rid}&roster=${rid}`;

        const res = await fetch(url, { cache: 'no-store', credentials: 'include' });
        const j = await res.json();
        if (!res.ok || j.success === false) throw new Error(j.error || '조회 실패');
    
        let students = Array.isArray(j.students) ? j.students : [];
        students = students.filter(s => {
          const r = (s.rosterId || s.roster || s.rid);
          const t = (s.teacherId || s.tid || s.ownerId);
          return r === rosterId && (!t || t === tid);
        });

        document.getElementById('classInfo').textContent =
          `현재 조회: ${SELECTED_ROSTER_TITLE || '선택된 명부'}`;

        if (!students.length) { renderStudentStatusEmpty(); return; }
    
        const normalized = students.map(s => ({
          name: s.name,
          studentId: s.studentId,
          status: s.status || 'not-started',
          hasPeerEvaluation: !!s.hasPeerEvaluation,
          hasSelfEvaluation: !!s.hasSelfEvaluation,
          lastUpdate: s.lastUpdate || '-'
        }));
        displayStudentStatus(normalized);
      } catch (e) {
        console.error('현황 조회 오류:', e);
        showMessage('현황 조회 중 오류가 발생했습니다.', 'error');
        renderStudentStatusEmpty();
      }
    }

    function renderStudentStatusEmpty(){
      const grid=document.getElementById('studentStatusGrid');
      grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:#666;padding:20px;">
        저장된(활성) 명부가 없습니다. <strong>저장된 명부</strong>에서 현황판 노출을 켜세요.</div>`;
      document.getElementById('completedCount').textContent='0명';
      document.getElementById('pendingCount').textContent='0명';
      document.getElementById('notStartedCount').textContent='0명';
    }
    function displayStudentStatus(students){
      const grid=document.getElementById('studentStatusGrid');
      const statusCounts={completed:0,pending:0,'not-started':0};
      if(!students.length){ renderStudentStatusEmpty(); return; }
      grid.innerHTML = students.map(st=>{
        statusCounts[st.status]++;
        const statusText={completed:'완료',pending:'부분완료','not-started':'미시작'};
        const detailText={
          completed:'동료평가 ✓ 자기평가 ✓',
          pending: st.hasPeerEvaluation&&!st.hasSelfEvaluation?'동료평가 ✓ 자기평가 ✗'
                 :!st.hasPeerEvaluation&&st.hasSelfEvaluation?'동료평가 ✗ 자기평가 ✓'
                 :'동료평가 ✓ 자기평가 ✗',
          'not-started':'동료평가 ✗ 자기평가 ✗'
        };
        return `<div class="student-card ${st.status}" title="${detailText[st.status]}">
          <div class="student-name">${st.name}</div>
          <div class="student-status status-${st.status}">${statusText[st.status]}</div>
          <div style="font-size:10px;color:#666;margin-top:5px;">${st.lastUpdate}</div>
          <div style="font-size:9px;color:#999;margin-top:2px;">${detailText[st.status]}</div>
        </div>`;
      }).join('');
      document.getElementById('completedCount').textContent=statusCounts.completed+'명';
      document.getElementById('pendingCount').textContent=statusCounts.pending+'명';
      document.getElementById('notStartedCount').textContent=statusCounts['not-started']+'명';
    }

    /* ───────── 통계(요약) ───────── */
    const COMPETENCIES=['자신감과 리더십','분석','아이디어 뱅크','감정 이해','의사소통','협동심'];
    let currentStatsData=[]; // [{studentId,name,counts:{},total}]
    // ▼ 활동명을 날짜로 빠르게 찾기 위한 전역 맵
    let CURRENT_ACTIVITY_MAP = {}; // { 'YYYY-MM-DD': '활동명' }

    // 서버에서 활동목록 가져와 날짜→활동명 맵으로 변환
    async function getActivityMapFromServer({ teacherId, rosterId, start, end }) {
      try {
        const qs = new URLSearchParams({
          teacherId,
          rosterId: rosterId || '',
          start: (start || '').toString(),
          end:   (end   || '').toString()
        }).toString();
        const r = await fetch('/api/admin/list-activities?' + qs,
          { credentials:'include', cache:'no-store' });
        const j = await r.json();
        if (!r.ok || j.success === false) throw new Error(j.error || '활동 조회 실패');

        const map = {};
        (j.activities || []).forEach(a => {
          const d = dateKey(a.date);
          const t = a.title || a.name || a.activity || '';
          if (d && t) map[d] = t;
        });
        return map;
      } catch (e) {
       console.warn('[getActivityMapFromServer] fail:', e);
        return {};
      }
    }

    // 명부 드롭다운 채우기
    async function refreshStatsFiltersFromRosters() {
      const sel = document.getElementById('statsRosterSelect');
      if (!sel) return;
      try {
        const tid = await ensureTeacherId();
        const { rosters = [] } = await getJson('/api/admin/list-rosters?teacherId=' + encodeURIComponent(tid));
        const titleOf = (r) => (r?.categoryName || r?.title || '무제 명부') + (r?.categoryType ? ` · ${r.categoryType}` : '');
        const countOf = (r) => (r?.itemCount ?? r?.count ?? 0);
        const opts = [
          '<option value="">전체 명부</option>',
          ...rosters.map(r=>`<option value="${r.id}">${titleOf(r)} (${countOf(r)}명)</option>`)
        ];
        sel.innerHTML = opts.join('');
      } catch (e) {
        console.warn('[refreshStatsFiltersFromRosters] fail:', e);
        document.getElementById('statsRosterSelect').innerHTML =
          '<option value="">전체 명부</option>';
      }
    }

    function pickReasonForTarget(p, idx, rawTarget) {
      // 1) 배열형 매칭 (nominees와 동일 인덱스)
      if (Array.isArray(p.reasons) && typeof p.reasons[idx] === 'string') {
        return p.reasons[idx];
      }
      // 2) 이름/학번 키로 오는 경우(예: { "홍길동": "..." })
      if (p.reasonsByName && typeof p.reasonsByName === 'object') {
        const t = (rawTarget||'').toString().trim();
        if (t && typeof p.reasonsByName[t] === 'string') return p.reasonsByName[t];
      }
      // 3) 단일 reason 필드
      if (typeof p.reason === 'string') return p.reason;
      // 4) 없으면 빈 문자열
      return '';
    }

    // ---- 관리자용 평가 전체 조회 (여러 조합을 순차 시도; 절대 throw 안 함)
    async function fetchAllEvaluationsForAdmin(tid) {
      const cand = [
        `/api/get-evaluations?all=1&teacherId=${encodeURIComponent(tid)}`,
        `/api/get-evaluations?all=1`,
        `/api/get-evaluations?teacherId=${encodeURIComponent(tid)}`,
        `/api/get-evaluations`
      ];

      for (const u of cand) {
        console.log('[fetchAllEvaluationsForAdmin] try:', u);
        const { ok, status, data, raw } = await safeFetchJson(u);
       if (!ok) {
          console.warn('[get-evaluations] HTTP', status, data?.error || raw?.slice(0,120));
          continue;
        }
        // 다양한 스키마(evaluations/items/루트배열) 지원
        const arr =
          (Array.isArray(data?.evaluations) && data.evaluations) ||
          (Array.isArray(data?.items) && data.items) ||
          (Array.isArray(data) && data) ||
          [];
        console.log('[fetchAllEvaluationsForAdmin] got', arr.length, 'items from', u);
        if (arr.length) return arr;  // 첫 성공 채택
        // 성공이지만 비어있으면 다음 후보도 시도
      }
      console.warn('[fetchAllEvaluationsForAdmin] no data from all candidates. return []');
      return [];
    }
    
    async function safeFetchJson(url) {
      try {
        const r = await fetch(url, { credentials:'include', cache:'no-store' });
        const raw = await r.clone().text();
        let data = null; try { data = JSON.parse(raw); } catch {}
        return { ok:r.ok, status:r.status, data, raw };
      } catch (e) {
        return { ok:false, status:0, data:null, raw:String(e||'') };
      }
    }
     
    // ★★★ 통계 조회 구현  — [전체 교체]
    async function loadStatistics(){
      const resultBox = document.getElementById('statisticsResults');
      const summaryBox = document.getElementById('summaryStats');
      resultBox.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">불러오는 중…</div>';
      summaryBox.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">불러오는 중…</div>';
    
      try{
        // 0) teacherId 먼저 확보 (← 이전 ReferenceError 원인)
        const tid = await ensureTeacherId();
    
        const rosterId = (document.getElementById('statsRosterSelect')?.value || '').trim();
        const fromStr  = (document.getElementById('startDate')?.value || '').trim();
        const toStr    = (document.getElementById('endDate')?.value || '').trim();
        const from = fromStr ? new Date(fromStr) : null;
        const to   = toStr   ? new Date(toStr)   : null;
    
        // 1) 활동 맵(날짜→활동명) 선조회
        CURRENT_ACTIVITY_MAP = await getActivityMapFromServer({
          teacherId: tid,
          rosterId,
          start: fromStr,
          end: toStr
        });
    
        // 2) (선택) 명부 학생 목록 → 학번↔이름 매핑
        const idToName = {};
        const nameToId = {};
        if (rosterId){
          try{
            const rid = encodeURIComponent(rosterId);
            const j = await getJson(`/api/admin/list-students?teacherId=${encodeURIComponent(tid)}&rosterId=${rid}&rid=${rid}`);
            const arr = Array.isArray(j.students) ? j.students : [];
            arr.forEach(s=>{
              if (!s) return;
              const id = (s.studentId || s.username || '').toString().trim();
              const nm = (s.name || s.studentName || '').toString().trim();
              if (id)  idToName[id] = nm || id;
              if (nm)  nameToId[nm] = id || nm;
            });
          }catch(e){ /* 조용히 계속 */ }
        }
        const rosterIds   = new Set(Object.keys(idToName));                   // 학번 set
        const rosterNames = new Set(Object.values(idToName).filter(Boolean)); // 이름 set

        // ✅ 추가 (여기! pickReasonForTarget 아님)
        const norm = s => (s ?? '').toString().trim().toLowerCase();
        const rosterIdsNorm   = new Set(Object.keys(idToName).map(norm));
        const rosterNamesNorm = new Set(Object.values(idToName).filter(Boolean).map(norm));
    
        // 3) 전체 평가 가져오기(관리자 루트)  ← all=1 사용
        const evals = await fetchAllEvaluationsForAdmin(tid);
        // console.log('[loadStatistics] evals length =', Array.isArray(evals)?evals.length:-1);
        const rawCount = Array.isArray(evals) ? evals.length : 0;
        let inRangeCount = 0;
        let rosterPassCount = 0;

        // 데이터 0건이면 즉시 종료
        if (!rawCount) {
          resultBox.innerHTML  = '<div style="text-align:center;color:#666;padding:20px;">데이터가 없습니다. (원본 0건)</div>';
          summaryBox.innerHTML = `
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:14px;">
              <div class="competency-stat"><span>총 추천 수</span><strong>0</strong></div>
              <div class="competency-stat"><span>가장 많이 받은 역량</span><strong>-</strong></div>
              <div class="competency-stat"><span>학생 수</span><strong>0</strong></div>
            </div>
            ${COMPETENCIES.map(c=>`<div class="competency-stat"><span>${c}</span><strong>0</strong></div>`).join('')}
          `;
          return;
        }
    
        // 3-1) 데이터 없으면 즉시 종료(스피너 제거)
        if (!Array.isArray(evals) || evals.length === 0) {
         resultBox.innerHTML  = '<div style="text-align:center;color:#666;padding:20px;">데이터가 없습니다.</div>';
          summaryBox.innerHTML = `
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:14px;">
              <div class="competency-stat"><span>총 추천 수</span><strong>0</strong></div>
              <div class="competency-stat"><span>가장 많이 받은 역량</span><strong>-</strong></div>
              <div class="competency-stat"><span>학생 수</span><strong>0</strong></div>
            </div>
            ${COMPETENCIES.map(c=>`<div class="competency-stat"><span>${c}</span><strong>0</strong></div>`).join('')}
          `;
          return;
        }
    
        // 날짜 필터
        const inRange = (dstr)=>{
          if (!from && !to) return true;
          const d = new Date((dstr||'').toString().slice(0,10)); // YYYY-MM-DD
          if (Number.isNaN(+d)) return true;
          if (from && d < from) return false;
          if (to   && d > to)   return false;
          return true;
        };
    
        // 4) 집계: 학생별 { totals, reasons }
        const map = new Map(); // key: studentId(or 이름)
        const ensureRow = (sid, displayName)=>{
          const key = sid || displayName;
          if (!map.has(key)){
            const totals = {}; COMPETENCIES.forEach(c=>totals[c]=0);
            map.set(key, {
              studentId: sid || '',
              name: displayName || sid || '학생',
              totals,
              reasons: {}
            });
          }
          return map.get(key);
        };
    
        evals.forEach(ev=>{
          const dateStr = dateKey(ev.date || ev.timestamp);
          if (!inRange(dateStr)) return;
          inRangeCount++;
    
          const peer = Array.isArray(ev.peerEvaluations) ? ev.peerEvaluations : [];
          peer.forEach(p=>{
            const comp = p.competency;
            if (!COMPETENCIES.includes(comp)) return;
    
            // nominees(배열) 또는 name(단일) 모두 지원
            let targets = [];
            if (Array.isArray(p.nominees)) targets = p.nominees;
            else if (p.name) targets = [p.name];
    
            const reasonsArr   = Array.isArray(p.reasons) ? p.reasons : null; // nominees와 index 매칭
            const singleReason = p.reason || null;
    
            targets.forEach((raw, idx)=>{
              // raw가 문자열 또는 {name, studentId} 같은 객체일 수 있음 → 정규화
              let t  = '', sid = '', nm = '';
              if (typeof raw === 'string') {
                t   = raw.trim();
                sid = t;
                nm  = idToName[t] || '';
              } else if (raw && typeof raw === 'object') {
                sid = (raw.studentId || raw.username || raw.id || '').toString().trim();
                nm  = (raw.name || raw.studentName || '').toString().trim();
                t   = nm || sid;
              } else {
                t = String(raw || '').trim();
                sid = t;
                nm  = idToName[t] || '';
              }
    
              // 명부 매핑 보정
              if (!nm && nameToId[t]) {
                sid = nameToId[t];
                nm  = idToName[sid] || t;
              }

              // 명부 필터
             if (rosterId){
                const tNorm   = norm(t);       // raw 문자열(이름/아이디 둘 중 하나일 수 있음)
                const sidNorm = norm(sid);     // 우리가 해석한 id 후보

                // 문자열이 이름으로도, 아이디로도 들어올 수 있으므로 둘 다 허용
                const okById   = rosterIdsNorm.has(sidNorm) || rosterIdsNorm.has(tNorm);
                const okByName = rosterNamesNorm.has(tNorm);

                if (!okById && !okByName) return;
              }
              rosterPassCount++;
    
              // 대상자별 이유 선택
              let reasonText = '';
              if (reasonsArr && typeof reasonsArr[idx] === 'string') reasonText = reasonsArr[idx];
              else if (singleReason) reasonText = singleReason;
    
              const row = ensureRow(sid, nm || t);
              row.totals[comp] = (row.totals[comp]||0) + 1;
    
              if (!Array.isArray(row.reasons[comp])) row.reasons[comp] = [];
              row.reasons[comp].push({
                text: reasonText || '',
                date: dateStr || '',
                activity: CURRENT_ACTIVITY_MAP[dateStr] || '',
                from: ev.evaluatorUsername || ev.evaluator || ''
              });
            });
          });
        });
    
        const byStudent = Array.from(map.values()).sort(
          (a,b)=> (Object.values(b.totals||{}).reduce((x,y)=>x+(+y||0),0)) -
                  (Object.values(a.totals||{}).reduce((x,y)=>x+(+y||0),0)) ||
                  a.name.localeCompare(b.name,'ko')
        );
        currentStatsData = byStudent;
    
        // 5) 렌더링
        const resultBoxHtml = byStudent.length
          ? byStudent.map(st=>{
              const total = Object.values(st.totals||{}).reduce((a,b)=>a+(+b||0),0);
              return `
                <div class="student-detail">
                  <div class="student-header" onclick="toggleStudentDetail(this)">
                    <span>${st.name}${st.studentId?` <small style="color:#888">(${st.studentId})</small>`:''}</span>
                    <span>총 ${total} ▼</span>
                  </div>
                  <div class="student-content">
                    ${renderCompetencyBlocks(st)}
                  </div>
                </div>`;
          }).join('')
          : `<div style="text-align:center;color:#666;padding:20px;">
               데이터가 없습니다.<br>
               <small>(원본: ${rawCount}건, 기간 통과: ${inRangeCount}건, 명부/이름 매칭: ${rosterId ? rosterPassCount : '—'}건)</small>
             </div>`;
        resultBox.innerHTML = resultBoxHtml;
    
        // 전체 요약
        const totalByComp = {}; COMPETENCIES.forEach(c=>totalByComp[c]=0);
        let totalAll = 0;
        byStudent.forEach(st=>{
          COMPETENCIES.forEach(c=> totalByComp[c] += (+st.totals[c]||0));
          totalAll += Object.values(st.totals||{}).reduce((a,b)=>a+(+b||0),0);
        });
        const top = COMPETENCIES.slice().sort((a,b)=> totalByComp[b]-totalByComp[a])[0] || '-';
    
        summaryBox.innerHTML = `
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:14px;">
            <div class="competency-stat"><span>총 추천 수</span><strong>${totalAll}</strong></div>
            <div class="competency-stat"><span>가장 많이 받은 역량</span><strong>${top}</strong></div>
            <div class="competency-stat"><span>학생 수</span><strong>${byStudent.length}</strong></div>
          </div>
          ${COMPETENCIES.map(c=>`<div class="competency-stat"><span>${c}</span><strong>${totalByComp[c]}</strong></div>`).join('')}
        `;
      }catch(e){
        console.error(e);
        showMessage('통계 조회에 실패했습니다: ' + (e.message||'unknown'), 'error');
        document.getElementById('statisticsResults').innerHTML =
          '<div style="text-align:center;color:#c53030;padding:20px;">통계 조회 실패</div>';
        document.getElementById('summaryStats').innerHTML =
          '<div style="text-align:center;color:#c53030;padding:20px;">통계 조회 실패</div>';
      }
    }

    // 엑셀 다운로드
    function downloadExcel(){
      if (!currentStatsData || !currentStatsData.length){
        showMessage('다운로드할 데이터가 없습니다.','error');
        return;
      }

      // 시트1: 개인별 통계 (합계만)
      const rows1 = currentStatsData.map(st=>{
        const obj = { 학번: st.studentId || '', 이름: st.name || '' };
        COMPETENCIES.forEach(c => obj[c] = +((st.totals||{})[c] || 0));
        obj['총합'] = Object.values(st.totals||{}).reduce((a,b)=>a+(+b||0),0);
        return obj;
      });
      const ws1 = XLSX.utils.json_to_sheet(rows1);

      // 시트2: 이유 상세 (역량별 이유/날짜/활동/추천자)
      const rows2 = [];
      currentStatsData.forEach(st=>{
        COMPETENCIES.forEach(c=>{
          const list = (st.reasons && Array.isArray(st.reasons[c])) ? st.reasons[c] : [];
          if (!list.length){
            // 이유가 전혀 없을 때도 한 줄 남겨두고 싶으면 주석 해제
            // rows2.push({학번:st.studentId||'',이름:st.name||'',역량:c,횟수:0,이유:'',날짜:'',활동:'',추천자:''});
            return;
          }
          list.forEach(r=>{
            rows2.push({
              학번: st.studentId || '',
              이름: st.name || '',
              역량: c,
              이유: (r.text || '').toString(),
              날짜: (r.date || '').toString().slice(0,10),
              활동: r.activity || '',
              추천자: r.from || ''
            });
          });
        });
      });
      const ws2 = XLSX.utils.json_to_sheet(rows2);

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws1, '개인별 통계');
      XLSX.utils.book_append_sheet(wb, ws2, '이유 상세');
      XLSX.writeFile(wb, '에이스_통계.xlsx');
    }

    /* ───────── 공용 UI ───────── */
    function showMessage(msg,type){
      const old=document.querySelector('.success-message,.error-message'); if(old) old.remove();
      const div=document.createElement('div'); div.className=(type==='success'?'success-message':'error-message'); div.textContent=msg;
      const active=document.querySelector('.page-content.active'); const first=active.querySelector('.card'); active.insertBefore(div,first);
      setTimeout(()=>div.remove(),3000);
    }
    function downloadTemplate(){
      const csv=['이름,학번','홍길동,20250001','김나래,20250002'].join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='명부_양식.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    function clearAllData(){ if(confirm('정말 초기화할까요?')){ localStorage.clear(); showMessage('모든 데이터가 초기화되었습니다.','success'); closeRosterModal(); loadStudentStatus(); } }
    function logout(){ if(confirm('정말로 로그아웃하시겠습니까?')) location.href='login.html'; }

    // 저장된 명부 → 통계 드롭다운 채우기
    function setSelectOptions(sel, items){
      if (!sel) return;
      const keep = sel.value;
      sel.innerHTML =
        '<option value="">전체</option>' +
        items.sort((a,b)=>a.localeCompare(b,'ko'))
             .map(v=>`<option value="${v}">${v}</option>`).join('');
      if ([...sel.options].some(o=>o.value===keep)) sel.value = keep;
    }

    /* ───────── 초기 로드 ───────── */
    document.addEventListener('DOMContentLoaded', async ()=>{
      await ensureTeacherId();
      await refreshStatsFiltersFromRosters();       // 명부 드롭다운
      await loadSavedRosters();                     // 저장된 명부 카드
      await loadStudentStatus({ forceEmpty: true }); // 현황은 빈 화면에서 시작
      loadActivityList();                           // 활동 목록 (기존)
      // ▼ 이 세 가지가 바뀌면 활동 목록 갱신
      document.getElementById('statsRosterSelect')?.addEventListener('change', loadActivityList);
      document.getElementById('startDate')?.addEventListener('change', loadActivityList);
      document.getElementById('endDate')?.addEventListener('change', loadActivityList);
    });

    /* 활동 정보(기존 자리채움) */
    // 선택된 명부 id
    function _selectedRosterId() {
      const sel = document.getElementById('statsRosterSelect');
      return sel && sel.value ? sel.value : '';
    }

    // 활동 목록 UI 렌더
    function renderActivityList(items) {
      const box = document.getElementById('activityList');
      if (!box) return;
      if (!items.length) {
        box.innerHTML = '<div style="color:#888">등록된 활동이 없습니다.</div>';
        return;
      }
      box.innerHTML = items.map(a => `
        <div style="display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed #eee">
          <div><strong>${a.date}</strong> · ${a.name}</div>
          <button onclick="removeActivity('${a.id}','${a.rosterId}','${a.date}')" class="tiny-btn btn-danger">삭제</button>
        </div>
      `).join('');
    }

    // 활동 불러오기 (선택 명부 + 날짜범위)
    async function loadActivityList() {
      const rosterId = _selectedRosterId();
      const activityBox = document.getElementById('activityList');
      if (activityBox) activityBox.innerHTML = '<div style="color:#666">불러오는 중…</div>';
      try {
        const tid   = await ensureTeacherId();
        const start = (document.getElementById('startDate')?.value || '');
        const end   = (document.getElementById('endDate')?.value   || '');
        const qs = new URLSearchParams({ teacherId: tid, rosterId, start, end }).toString();

        const j = await getJson(`/api/admin/list-activities?${qs}`);
        renderActivityList(j.activities || []);
      } catch (e) {
        showMessage('활동 목록 조회 실패: ' + (e.message||''), 'error');
        if (activityBox) activityBox.innerHTML = '';
      }
    }

    // 활동 추가/수정 (버튼 "추가"가 이 함수를 호출)
    async function addActivityInfo() {
      const rosterId = _selectedRosterId();
      const date = document.getElementById('activityDate')?.value?.slice(0,10);
      const name = document.getElementById('activityName')?.value?.trim();

      if (!rosterId) return showMessage('먼저 통계 조회 상단에서 명부를 선택하세요.', 'error');
      if (!date || !name) return showMessage('날짜와 활동명을 입력하세요.', 'error');

      try {
        const tid = await ensureTeacherId();
        await postJson(`/api/admin/upsert-activity?teacherId=${encodeURIComponent(tid)}`, {
          rosterId, date, name
        });
        document.getElementById('activityName').value = '';
        await loadActivityList();
        showMessage('활동이 저장되었습니다.', 'success');
      } catch (e) {
        showMessage('활동 저장 실패: ' + (e.message||''), 'error');
      }
    }

    // 활동 삭제
    async function removeActivity(id, rosterId, date) {
      if (!confirm('삭제할까요?')) return;
      try {
        const tid = await ensureTeacherId();
        await postJson(`/api/admin/delete-activity?teacherId=${encodeURIComponent(tid)}`, {
          id, rosterId, date
        });
        await loadActivityList();
        showMessage('삭제되었습니다.', 'success');
      } catch (e) {
        showMessage('삭제 실패: ' + (e.message||''), 'error');
      }
    }

    // (옵션) 현재 명부의 활동 전체 삭제
    async function clearAllActivities() {
      if (!confirm('이 명부의 활동을 전부 삭제할까요?')) return;
      const rosterId = _selectedRosterId();
      try {
        const tid = await ensureTeacherId();
        const j = await getJson(`/api/admin/list-activities?teacherId=${encodeURIComponent(tid)}&rosterId=${encodeURIComponent(rosterId)}`);
        for (const a of (j.activities||[])) {
          await postJson(`/api/admin/delete-activity?teacherId=${encodeURIComponent(tid)}`, { id:a.id });
        }
        await loadActivityList();
        showMessage('전체 삭제 완료', 'success');
      } catch (e) {
        showMessage('전체 삭제 실패: ' + (e.message||''), 'error');
      }
    }

    function toggleStudentDetail(h){ const c=h.nextElementSibling,a=h.querySelector('span:last-child'); if(c.classList.contains('expanded')){c.classList.remove('expanded'); a.textContent='▼';}else{c.classList.add('expanded'); a.textContent='▲';} }
    function updateClassInfo(){ /* 필요시 사용 */ }

    // 한 학생의 역량별 상세(횟수 + 이유 목록[활동/날짜/추천자]) 렌더
    function renderCompetencyBlocks(s){
      const totals  = s.totals || {};
      const reasons = s.reasons || {};

      return COMPETENCIES.map(c => {
        const cnt = +totals[c] || 0;
        const list = Array.isArray(reasons[c]) ? reasons[c] : [];

        const body = list.length
          ? list.map(r=>{
              const d   = (r.date || '').toString().slice(0,10);
              const act = r.activity || (CURRENT_ACTIVITY_MAP[d] || '');
              const by  = r.from ? ` · by ${r.from}` : '';
              const actBadge = act ? ` <span style="color:#805ad5; font-size:12px;">[${act}]</span>` : '';
              const dateBadge= d   ? ` <span style="color:#718096; font-size:12px;">${d}</span>` : '';
              const txt = (r.text || r.reason || '').toString().trim() || '(이유 미기재)';
              return `<li style="margin:4px 0; line-height:1.5;">
                <span style="color:#1a202c;">${txt}</span>${actBadge}${dateBadge}<span style="color:#a0aec0; font-size:12px;">${by}</span>
              </li>`;
            }).join('')
          : `<li style="color:#a0aec0;">이유 기록 없음</li>`;

        return `
          <div class="competency-stat" style="flex-direction:column; align-items:stretch;">
            <div style="display:flex; justify-content:space-between; font-weight:600;">
              <span>${c}</span><span>${cnt}회</span>
            </div>
            <ul style="margin-top:6px; padding-left:18px;">${body}</ul>
          </div>`;
      }).join('');
    }

  </script>
</body>
</html>

























