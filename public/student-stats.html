<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>오늘의 에이스는? - 통계</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Arial',sans-serif;background-color:#fff8f0;min-height:100vh;display:flex}

    /* 좌측 사이드바 */
    .sidebar{width:200px;background:#fff;border-right:3px solid #ffe0b3;padding:20px;box-shadow:3px 0 10px rgba(255,217,61,.1)}
    .sidebar-header{text-align:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #fff5e6}
    .sidebar-header h2{color:#2d3748;font-size:16px;font-weight:700;margin-bottom:5px}
    .sidebar-header p{color:#4a5568;font-size:11px}
    .menu-item{display:block;width:100%;padding:12px 15px;margin-bottom:8px;background:#fff5e6;border:2px solid #ffe0b3;border-radius:10px;color:#2d3748;text-decoration:none;font-weight:600;text-align:center;font-size:12px;cursor:pointer;transition:.2s}
    .menu-item.active,.menu-item:hover{background:#ffd93d}
    .logout-btn{margin-top:20px;padding:8px 12px;background:#ffb3b3;border:2px solid #ff9999;border-radius:8px;color:#2d3748;font-weight:600;cursor:pointer;width:100%;font-size:11px}

    /* 메인 */
    .main-content{flex:1;padding:25px;overflow-y:auto}
    .page-header{text-align:center;margin-bottom:25px}
    .page-header h1{color:#2d3748;font-size:26px;font-weight:700;margin-bottom:8px}
    .page-header p{color:#4a5568;font-size:15px}

    /* 조회 컨트롤 */
    .controls-container{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:25px}
    .control-box{background:#fff;border-radius:15px;padding:20px}
    .period-control{border:3px solid #ffe0b3;background:#fffbf5}
    .career-control{border:3px solid #e0c4ff;background:#faf7ff}
    .control-box h3{color:#2d3748;margin-bottom:15px;font-size:16px;text-align:center}
    .control-group{display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap}
    .control-group select,.control-group input{padding:8px 12px;border:2px solid #c77dff;border-radius:8px;font-size:14px;background:#fff}
    .period-control .control-group select{border-color:#ffd93d}
    .control-group input[type="text"]{width:200px;max-width:100%}
    .search-btn{color:#fff;border:none;padding:8px 18px;border-radius:8px;font-weight:600;cursor:pointer;transition:.2s;font-size:13px}
    .period-control .search-btn{background:#ffd93d;color:#2d3748}
    .period-control .search-btn:hover{background:#ffb700;transform:translateY(-1px)}
    .career-control .search-btn{background:#c77dff}
    .career-control .search-btn:hover{background:#a855f7;transform:translateY(-1px)}
    .control-message{text-align:center;margin-top:10px;font-size:12px;min-height:16px}

    /* 대시보드 */
    .stats-dashboard{display:grid;grid-template-columns:1fr 1fr;gap:25px;margin-bottom:25px}
    .chart-container{background:#fff;border:3px solid #ffe0b3;border-radius:15px;padding:20px;background:#fffbf5}
    .chart-container h3{color:#2d3748;margin-bottom:15px;font-size:16px;text-align:center}
    .chart-wrapper{position:relative;height:300px;margin-bottom:10px}

    /* 요약 */
    .summary-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:25px}
    .stat-card{background:#fff;border:2px solid #ffd93d;border-radius:12px;padding:15px;text-align:center}
    .stat-number{font-size:24px;font-weight:700;color:#2d3748;margin-bottom:5px}
    .stat-label{font-size:12px;color:#4a5568;font-weight:500}

    /* AI 조언 */
    .ai-advice{background:#fff;border:3px solid #c77dff;border-radius:15px;padding:25px;background:#faf7ff}
    .ai-advice h3{color:#2d3748;margin-bottom:15px;font-size:18px;text-align:center}
    .advice-content{color:#4a5568;line-height:1.6;font-size:14px; white-space: pre-line;}

    .no-data{text-align:center;color:#666;font-size:16px;padding:40px}

    /* 반응형 */
    @media (max-width:1000px){
      .stats-dashboard{grid-template-columns:1fr}
      .summary-stats{grid-template-columns:1fr 1fr}
      .controls-container{grid-template-columns:1fr;gap:15px}
    }
    @media (max-width:768px){
      body{flex-direction:column}
      .sidebar{width:100%;padding:15px}
      .main-content{padding:20px}
      .summary-stats{grid-template-columns:1fr}
      .controls-container{grid-template-columns:1fr;gap:12px}
      .control-group{flex-direction:column;gap:8px}
      .control-group input[type="text"]{width:180px}
    }
  </style>
</head>
<body>
  <!-- 좌측 사이드바 -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>🌟 학생 메뉴</h2>
      <p id="greet">안녕하세요!</p>
    </div>
    <button class="menu-item" onclick="goToInputPage()">📝 입력 페이지</button>
    <button class="menu-item active">📊 통계 페이지</button>
    <button class="logout-btn" onclick="logout()">🚪 로그아웃</button>
  </div>

  <!-- 메인 콘텐츠 -->
  <div class="main-content">
    <div class="page-header">
      <h1>📊 나의 에이스 통계</h1>
      <p>친구들이 나를 어떤 에이스로 평가했는지 확인해보세요</p>
    </div>

    <!-- 조회 컨트롤 -->
    <div class="controls-container">
      <!-- 왼쪽: 기간 + 명부 선택 -->
      <div class="control-box period-control">
        <h3>📅 기간 / 명부 선택</h3>
        <div class="control-group">
          <!-- ★ 내 명부 드롭다운 -->
          <select id="myRosterSelect">
            <option value="">내 명부를 불러오는 중…</option>
          </select>

          <select id="periodType">
            <option value="1month">최근 1달</option>
            <option value="2month">최근 2달</option>
            <option value="3month">최근 3달</option>
            <option value="6month">최근 6달</option>
            <option value="all">전체 기간</option>
          </select>
          <button class="search-btn" onclick="loadMyStats()">조회하기</button>
        </div>
      </div>

      <!-- 오른쪽: 진로/관심분야 -->
      <div class="control-box career-control">
        <h3>🎯 진로/관심분야</h3>
        <div class="control-group">
          <input type="text" id="careerInterest" placeholder="예: 개발자, 디자이너, 교사">
          <button class="search-btn" onclick="saveCareerInterest()">저장</button>
        </div>
        <div id="careerMessage" class="control-message"></div>
      </div>
    </div>

    <!-- 요약 통계 -->
    <div class="summary-stats">
      <div class="stat-card">
        <div class="stat-number" id="totalEvaluations">0</div>
        <div class="stat-label">총 평가 받은 횟수</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="topCompetency">-</div>
        <div class="stat-label">가장 많이 받은 에이스</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="evaluationDays">0</div>
        <div class="stat-label">평가 참여 일수</div>
      </div>
    </div>

    <!-- 통계 차트 -->
    <div class="stats-dashboard">
      <div class="chart-container">
        <h3>🏆 역량별 에이스 추천 횟수</h3>
        <div class="chart-wrapper"><canvas id="competencyChart"></canvas></div>
      </div>
      <div class="chart-container">
        <h3>📈 월별 평가 추이</h3>
        <div class="chart-wrapper"><canvas id="trendChart"></canvas></div>
      </div>
    </div>

    <!-- AI 조언 -->
    <div class="ai-advice">
      <h3>🤖 AI 성장 조언</h3>
      <div class="advice-content" id="aiAdvice">
        통계 데이터를 분석해서 맞춤형 조언을 제공합니다. 조회하기 버튼을 눌러주세요!
      </div>
    </div>
  </div>

  <script>
    /* ===== 세션 인사 ===== */

    
    /* ===== 이름/아이디 결정(3단 폴백) ===== */
    let lastStats = null;

    const ss = window.sessionStorage;
    let username = ss.getItem('username') || 'student1';
    let studentDisplayName = username;

    async function resolveIdentity() {
      // 1) 세션 캐시 우선
      try {
        const raw = ss.getItem('studentInfo');
        if (raw) {
          const info = typeof raw === 'string' ? JSON.parse(raw) : raw;
          if (info?.studentId) username = info.studentId;
          if (info?.name)      studentDisplayName = info.name;
        }
      } catch {}

      // 2) whoami로 보완  (⭐ name 과 studentName 둘 다 확인)
      try {
        const r  = await fetch('/api/auth/whoami', { credentials:'include', cache:'no-store' });
        const me = await r.json();
        if (me?.role === 'student') {
          username = me.username || me.uid || username;

          const nm = me.name || me.studentName; // ← 여기 추가!
          if (nm) studentDisplayName = nm;

          // 다음 페이지에서도 쓰도록 캐싱
          ss.setItem('username', username);
          ss.setItem('studentInfo', JSON.stringify({ name: studentDisplayName, studentId: username }));
        }
      } catch {}

      // 3) 그래도 이름이 없으면 프로필로 1회 보루
      if (!studentDisplayName || studentDisplayName === username) {
        try {
          const pr = await fetch('/api/student/profile?username=' + encodeURIComponent(username), {
            credentials:'include', cache:'no-store'
          });
          const pj = await pr.json();
          if (pr.ok && pj?.success && pj?.student) {
           const nm = pj.student.name || pj.student.studentName || '';
            if (nm) {
              studentDisplayName = nm;
              ss.setItem('studentInfo', JSON.stringify({ name: nm, studentId: username }));
            }
          }
        } catch {}
      }

      if (!studentDisplayName) studentDisplayName = username; // 최종 안전망
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await resolveIdentity();

      const greet = document.getElementById('greet');
      if (greet) greet.textContent = `${studentDisplayName}님, 안녕하세요!`;

      loadCareerInterest();
      await fillMyRosters();
      await loadMyStats();
    });


    /* ===== 라우팅/로그아웃 ===== */
    function goToInputPage(){ location.href='student.html'; }
    function logout(){ if(confirm('정말로 로그아웃하시겠습니까?')){ sessionStorage.clear(); location.href='index.html'; } }

    /* ===== 진로 메모(로컬) ===== */
    function saveCareerInterest(){
      const v = document.getElementById('careerInterest').value.trim();
      localStorage.setItem(`career:${username}`, v);
      const msg = document.getElementById('careerMessage');
      msg.textContent = '저장되었어요.'; setTimeout(()=>msg.textContent='',2000);
      if (lastStats) updateAIAdvice(lastStats);
    }
    function loadCareerInterest(){
      const v = localStorage.getItem(`career:${username}`) || '';
      const el = document.getElementById('careerInterest'); if (el) el.value = v;
    }

    /* ===== 명부 목록 로드 ===== */
    async function fillMyRosters(){
      const sel = document.getElementById('myRosterSelect');
      sel.innerHTML = '<option value="">내 명부를 불러오는 중…</option>';
      try{
        const r = await fetch('/api/student/list-my-rosters',{credentials:'include'});
        const j = await r.json();
        const rosters = j.rosters || [];
        if (!rosters.length){
          sel.innerHTML = '<option value="">소속 명부가 없습니다</option>'; return;
        }
        sel.innerHTML = rosters.map(r=>{
          const title=(r.title||r.categoryName||'무제 명부');
          const cnt=(r.itemCount ?? r.studentCount ?? r.count ?? 0);
          return `<option value="${r.id}">${title} (${cnt}명)</option>`;
        }).join('');
      }catch(e){
        console.warn('list-my-rosters 실패', e);
        sel.innerHTML = '<option value="">목록 로드 실패</option>';
      }
    }

    /* ===== 기간 계산 ===== */
    function getPeriodRange(){
      const type = document.getElementById('periodType').value;
      const now = new Date();
      const shift = m => { const d = new Date(now); d.setMonth(d.getMonth()-m); return d; };
      switch(type){
        case '1month': return { from: shift(1), to: now };
        case '2month': return { from: shift(2), to: now };
        case '3month': return { from: shift(3), to: now };
        case '6month': return { from: shift(6), to: now };
        case 'all':
        default:       return { from: null, to: now };
      }
    }
    const toDateStr = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

    /* ===== 통계 로드 (명부별) ===== */
    let competencyChart=null, trendChart=null;

    async function loadMyStats(){
      const sel = document.getElementById('myRosterSelect');
      const rosterId = sel.value;
      if (!rosterId){ showNoDataMessage('명부를 먼저 선택하세요.'); return; }

      const {from, to} = getPeriodRange();
      const url = new URL('/api/student/get-statistics', location.origin);
      url.searchParams.set('rosterId', rosterId);
      if (from) url.searchParams.set('startDate', toDateStr(from));
      if (to)   url.searchParams.set('endDate', toDateStr(to));

      try{
        const r = await fetch(url.toString(), { credentials:'include' });
        const j = await r.json();
        if (!r.ok || j.success===false) throw new Error(j.error || '통계 조회 실패');

        // j.received: { 역량:횟수 } – 차트는 받은 추천 기준으로 표시
        const competencyCounts = normalizeCompetencyCounts(j.received||{});
        const totalEvaluations = Object.values(competencyCounts).reduce((a,b)=>a+b,0);
        const topCompetency = Object.entries(competencyCounts).sort((a,b)=>b[1]-a[1])[0]?.[1] ? Object.entries(competencyCounts).sort((a,b)=>b[1]-a[1])[0][0] : '-';

        // 월별: recent(최대 20) 기준으로 간단 추이
        const monthlyData = {};
        (j.recent||[]).forEach(x=>{
          const m = (x.date||'').slice(0,7) || '기타';
          const inc = (monthlyData[m]||0) + (Array.isArray(x.received)?x.received.length:0);
          monthlyData[m] = inc;
        });

        const evaluationDays = new Set((j.recent||[]).map(x=>x.date)).size;

        const stats = { competencyCounts, monthlyData, totalEvaluations, topCompetency, evaluationDays };
        renderStats(stats);
      }catch(e){
        console.warn('student/get-statistics 실패:', e);
        showNoDataMessage('통계 로드 실패: ' + (e.message||''));
      }
    }

    function normalizeCompetencyCounts(obj){
      const keys=['자신감과 리더십','분석','아이디어 뱅크','감정 이해','의사소통','협동심'];
      const out={}; keys.forEach(k=>out[k]=Number(obj[k]||0)); return out;
    }

    /* ===== UI 렌더링 ===== */
    function renderStats(stats){
      lastStats = stats;
      updateSummaryStats(stats);
      updateCharts(stats);
      updateAIAdvice(stats);
    }
    function updateSummaryStats(stats){
      document.getElementById('totalEvaluations').textContent = stats.totalEvaluations;
      document.getElementById('topCompetency').textContent   = stats.topCompetency;
      document.getElementById('evaluationDays').textContent  = stats.evaluationDays;
    }
    function updateCharts(stats){
      updateCompetencyChart(stats.competencyCounts);
      updateTrendChart(stats.monthlyData);
    }
    function updateCompetencyChart(competencyCounts){
      const ctx = document.getElementById('competencyChart').getContext('2d');
      if (competencyChart) competencyChart.destroy();
      const labels=Object.keys(competencyCounts);
      const data=Object.values(competencyCounts);
      const colors=['#ff6b6b','#4ecdc4','#45b7d1','#f7b731','#5f27cd','#00d2d3'];
      competencyChart = new Chart(ctx,{
        type:'doughnut',
        data:{ labels, datasets:[{ data, backgroundColor:colors, borderWidth:2, borderColor:'#fff' }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom', labels:{ font:{ size:11 }}}}}
      });
    }
    function updateTrendChart(monthlyData){
      const ctx = document.getElementById('trendChart').getContext('2d');
      if (trendChart) trendChart.destroy();
      const months = Object.keys(monthlyData).sort();
      const values = months.map(m=>monthlyData[m]);
      trendChart = new Chart(ctx,{
        type:'line',
        data:{ labels: months.map(m=>m.substring(5)), datasets:[{ label:'월별 추천 횟수', data:values, borderColor:'#c77dff', backgroundColor:'rgba(199,125,255,0.1)', borderWidth:3, fill:true, tension:.4 }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false }}, scales:{ y:{ beginAtZero:true }}}
      });
    }

    /* ===== AI 조언 ===== */
    function buildStatsSummary(stats){
      const lines=[]; const cc=stats.competencyCounts||{};
      const pairs=Object.entries(cc).sort((a,b)=>b[1]-a[1]);
      const top=stats.topCompetency||'-', total=stats.totalEvaluations||0, days=stats.evaluationDays||0;
      lines.push(`가장 많은 추천 역량: ${top}`);
      lines.push(`총 추천 수: ${total}, 참여 일수: ${days}`);
      if (pairs.length){
        const top3 = pairs.slice(0,3).map(([k,v])=>`${k} ${v}회`).join(', ');
        lines.push(`상위 역량: ${top3}`);
      }
      const months=Object.keys(stats.monthlyData||{}).sort();
      if (months.length>=2){
        const first=months[0], last=months.at(-1);
        const diff=(stats.monthlyData[last]||0)-(stats.monthlyData[first]||0);
        lines.push(`첫달(${first})→마지막달(${last}) 변화: ${diff>=0?'+':''}${diff}`);
      }
      return lines.join('\n');
    }

    async function updateAIAdvice(stats){
      const career = (localStorage.getItem(`career:${username}`) || '').trim();
      const summary = buildStatsSummary(stats);
      const box = document.getElementById('aiAdvice');
      box.textContent = 'AI 조언 생성 중...';

      // whoami에서 username/rosterId 보조 확보(없으면 기존 값 사용)
      let me = {};
      try {
        const r = await fetch('/api/auth/whoami', { credentials:'include', cache:'no-store' });
        me = await r.json();
      } catch {}
      const myUsername = (me && (me.username || me.uid)) || username;
      const rosterIdSel = document.getElementById('myRosterSelect');
      const selectedRosterId =
        (rosterIdSel && rosterIdSel.value) ? rosterIdSel.value : (me && me.rosterId) || null;
    
      try{
        const r = await fetch('/api/ai-advice', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            career,
            statsSummary: summary, // 사람이 읽기 쉬운 요약
            stats,                 // 원본 숫자 데이터(모델이 표 참고 가능)
            username: myUsername,  // 내 학번/아이디
            rosterId: selectedRosterId,
            studentName: studentDisplayName
            // 필요 시 reasons/activities도 여기에 추가해서 보낼 수 있어요.
          })
        });
        const j = await r.json();

        if (!r.ok || !j?.success) {
          console.warn('[ai-advice] server error:', j?.error || r.status);
          throw new Error(j?.error || 'AI 실패');
        }

        // ✅ 더 이상 5줄로 자르지 않음. 그대로 노출
        box.textContent = (j.advice || '').trim();

      } catch (e) {
        console.warn('AI 조언 실패, 로컬 규칙으로 대체:', e?.message || e);

        // ✅ 폴백도 다정한 톤으로
        let advice = '';
        if ((stats.totalEvaluations || 0) === 0) {
          advice = [
            '아직 받은 평가가 많지 않아요. 그래도 지금까지의 시도, 정말 잘하고 있어요! 😊',
            '이번 주에는 수업/활동에 한 번 더 참여해 보며 작은 경험을 하나 더 쌓아볼까요?',
            '하루가 끝날 때 “잘한 점 1가지, 다음에 더 해보고 싶은 점 1가지”를 간단히 적어보면 좋아요.',
          ].join('\n');
        } else {
          const top = stats.topCompetency || '-';
          advice = [
            `요약을 보니 "${top}" 강점이 특히 잘 드러나고 있어요. 멋져요!`,
            career
              ? `관심 분야인 ${career}와 연결해 강점을 조금씩 확장해 보면 좋겠어요.`
              : '관심 진로를 입력해 주면 더 딱 맞는 제안을 드릴 수 있어요.',
            '이번 주에는 강점이 드러나는 활동을 하나 정해 가볍게 시도해보면 어떨까요?',
            '그리고 활동 후에는 1문장으로 짧게 회고를 남겨 보세요. 작은 기록이 큰 변화를 만듭니다.',
          ].join('\n');
        }

        // ✅ 폴백도 자르지 않음
        box.textContent = advice.trim();
      }
    }

    /* ===== 데이터 없음 ===== */
    function showNoDataMessage(msg){
      document.getElementById('totalEvaluations').textContent='0';
      document.getElementById('topCompetency').textContent='-';
      document.getElementById('evaluationDays').textContent='0';
      document.getElementById('aiAdvice').textContent= msg || '아직 평가 데이터가 없습니다. 입력 페이지에서 평가를 작성해주세요!';
      if (competencyChart){ competencyChart.destroy(); competencyChart=null; }
      if (trendChart){ trendChart.destroy(); trendChart=null; }
    }
  </script>
</body>
</html>







