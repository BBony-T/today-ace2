<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì˜¤ëŠ˜ì˜ ì—ì´ìŠ¤ëŠ”? - í†µê³„</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Arial',sans-serif;background-color:#fff8f0;min-height:100vh;display:flex}

    /* ì¢Œì¸¡ ì‚¬ì´ë“œë°” */
    .sidebar{width:200px;background:#fff;border-right:3px solid #ffe0b3;padding:20px;box-shadow:3px 0 10px rgba(255,217,61,.1)}
    .sidebar-header{text-align:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #fff5e6}
    .sidebar-header h2{color:#2d3748;font-size:16px;font-weight:700;margin-bottom:5px}
    .sidebar-header p{color:#4a5568;font-size:11px}
    .menu-item{display:block;width:100%;padding:12px 15px;margin-bottom:8px;background:#fff5e6;border:2px solid #ffe0b3;border-radius:10px;color:#2d3748;text-decoration:none;font-weight:600;text-align:center;font-size:12px;cursor:pointer;transition:.2s}
    .menu-item.active,.menu-item:hover{background:#ffd93d}
    .logout-btn{margin-top:20px;padding:8px 12px;background:#ffb3b3;border:2px solid #ff9999;border-radius:8px;color:#2d3748;font-weight:600;cursor:pointer;width:100%;font-size:11px}

    /* ë©”ì¸ */
    .main-content{flex:1;padding:25px;overflow-y:auto}
    .page-header{text-align:center;margin-bottom:25px}
    .page-header h1{color:#2d3748;font-size:26px;font-weight:700;margin-bottom:8px}
    .page-header p{color:#4a5568;font-size:15px}

    /* ì¡°íšŒ ì»¨íŠ¸ë¡¤ */
    .controls-container{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:25px}
    .control-box{background:#fff;border-radius:15px;padding:20px}
    .period-control{border:3px solid #ffe0b3;background:#fffbf5}
    .career-control{border:3px solid #e0c4ff;background:#faf7ff}
    .control-box h3{color:#2d3748;margin-bottom:15px;font-size:16px;text-align:center}
    .control-group{display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap}
    .control-group select,.control-group input{padding:8px 12px;border:2px solid #c77dff;border-radius:8px;font-size:14px;background:#fff}
    .period-control .control-group select{border-color:#ffd93d}
    .control-group input[type="text"]{width:200px;max-width:100%}
    .search-btn{color:#fff;border:none;padding:8px 18px;border-radius:8px;font-weight:600;cursor:pointer;transition:.2s;font-size:13px}
    .period-control .search-btn{background:#ffd93d;color:#2d3748}
    .period-control .search-btn:hover{background:#ffb700;transform:translateY(-1px)}
    .career-control .search-btn{background:#c77dff}
    .career-control .search-btn:hover{background:#a855f7;transform:translateY(-1px)}
    .control-message{text-align:center;margin-top:10px;font-size:12px;min-height:16px}

    /* ëŒ€ì‹œë³´ë“œ */
    .stats-dashboard{display:grid;grid-template-columns:1fr 1fr;gap:25px;margin-bottom:25px}
    .chart-container{background:#fff;border:3px solid #ffe0b3;border-radius:15px;padding:20px;background:#fffbf5}
    .chart-container h3{color:#2d3748;margin-bottom:15px;font-size:16px;text-align:center}
    .chart-wrapper{position:relative;height:300px;margin-bottom:10px}

    /* ìš”ì•½ */
    .summary-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:25px}
    .stat-card{background:#fff;border:2px solid #ffd93d;border-radius:12px;padding:15px;text-align:center}
    .stat-number{font-size:24px;font-weight:700;color:#2d3748;margin-bottom:5px}
    .stat-label{font-size:12px;color:#4a5568;font-weight:500}

    /* AI ì¡°ì–¸ */
    .ai-advice{background:#fff;border:3px solid #c77dff;border-radius:15px;padding:25px;background:#faf7ff}
    .ai-advice h3{color:#2d3748;margin-bottom:15px;font-size:18px;text-align:center}
    .advice-content{color:#4a5568;line-height:1.6;font-size:14px; white-space: pre-line;}

    .no-data{text-align:center;color:#666;font-size:16px;padding:40px}

    /* ë°˜ì‘í˜• */
    @media (max-width:1000px){
      .stats-dashboard{grid-template-columns:1fr}
      .summary-stats{grid-template-columns:1fr 1fr}
      .controls-container{grid-template-columns:1fr;gap:15px}
    }
    @media (max-width:768px){
      body{flex-direction:column}
      .sidebar{width:100%;padding:15px}
      .main-content{padding:20px}
      .summary-stats{grid-template-columns:1fr}
      .controls-container{grid-template-columns:1fr;gap:12px}
      .control-group{flex-direction:column;gap:8px}
      .control-group input[type="text"]{width:180px}
    }
  </style>
</head>
<body>
  <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>ğŸŒŸ í•™ìƒ ë©”ë‰´</h2>
      <p id="greet">ì•ˆë…•í•˜ì„¸ìš”!</p>
    </div>
    <button class="menu-item" onclick="goToInputPage()">ğŸ“ ì…ë ¥ í˜ì´ì§€</button>
    <button class="menu-item active">ğŸ“Š í†µê³„ í˜ì´ì§€</button>
    <button class="logout-btn" onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <!-- ë©”ì¸ ì½˜í…ì¸  -->
  <div class="main-content">
    <div class="page-header">
      <h1>ğŸ“Š ë‚˜ì˜ ì—ì´ìŠ¤ í†µê³„</h1>
      <p>ì¹œêµ¬ë“¤ì´ ë‚˜ë¥¼ ì–´ë–¤ ì—ì´ìŠ¤ë¡œ í‰ê°€í–ˆëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”</p>
    </div>

    <!-- ì¡°íšŒ ì»¨íŠ¸ë¡¤ -->
    <div class="controls-container">
      <!-- ì™¼ìª½: ê¸°ê°„ + ëª…ë¶€ ì„ íƒ -->
      <div class="control-box period-control">
        <h3>ğŸ“… ê¸°ê°„ / ëª…ë¶€ ì„ íƒ</h3>
        <div class="control-group">
          <!-- â˜… ë‚´ ëª…ë¶€ ë“œë¡­ë‹¤ìš´ -->
          <select id="myRosterSelect">
            <option value="">ë‚´ ëª…ë¶€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</option>
          </select>

          <select id="periodType">
            <option value="1month">ìµœê·¼ 1ë‹¬</option>
            <option value="2month">ìµœê·¼ 2ë‹¬</option>
            <option value="3month">ìµœê·¼ 3ë‹¬</option>
            <option value="6month">ìµœê·¼ 6ë‹¬</option>
            <option value="all">ì „ì²´ ê¸°ê°„</option>
          </select>
          <button class="search-btn" onclick="loadMyStats()">ì¡°íšŒí•˜ê¸°</button>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½: ì§„ë¡œ/ê´€ì‹¬ë¶„ì•¼ -->
      <div class="control-box career-control">
        <h3>ğŸ¯ ì§„ë¡œ/ê´€ì‹¬ë¶„ì•¼</h3>
        <div class="control-group">
          <input type="text" id="careerInterest" placeholder="ì˜ˆ: ê°œë°œì, ë””ìì´ë„ˆ, êµì‚¬">
          <button class="search-btn" onclick="saveCareerInterest()">ì €ì¥</button>
        </div>
        <div id="careerMessage" class="control-message"></div>
      </div>
    </div>

    <!-- ìš”ì•½ í†µê³„ -->
    <div class="summary-stats">
      <div class="stat-card">
        <div class="stat-number" id="totalEvaluations">0</div>
        <div class="stat-label">ì´ í‰ê°€ ë°›ì€ íšŸìˆ˜</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="topCompetency">-</div>
        <div class="stat-label">ê°€ì¥ ë§ì´ ë°›ì€ ì—ì´ìŠ¤</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="evaluationDays">0</div>
        <div class="stat-label">í‰ê°€ ì°¸ì—¬ ì¼ìˆ˜</div>
      </div>
    </div>

    <!-- í†µê³„ ì°¨íŠ¸ -->
    <div class="stats-dashboard">
      <div class="chart-container">
        <h3>ğŸ† ì—­ëŸ‰ë³„ ì—ì´ìŠ¤ ì¶”ì²œ íšŸìˆ˜</h3>
        <div class="chart-wrapper"><canvas id="competencyChart"></canvas></div>
      </div>
      <div class="chart-container">
        <h3>ğŸ“ˆ ì›”ë³„ í‰ê°€ ì¶”ì´</h3>
        <div class="chart-wrapper"><canvas id="trendChart"></canvas></div>
      </div>
    </div>

    <!-- AI ì¡°ì–¸ -->
    <div class="ai-advice">
      <h3>ğŸ¤– AI ì„±ì¥ ì¡°ì–¸</h3>
      <div class="advice-content" id="aiAdvice">
        í†µê³„ ë°ì´í„°ë¥¼ ë¶„ì„í•´ì„œ ë§ì¶¤í˜• ì¡°ì–¸ì„ ì œê³µí•©ë‹ˆë‹¤. ì¡°íšŒí•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!
      </div>
    </div>
  </div>

  <script>
    /* ===== ì„¸ì…˜ ì¸ì‚¬ ===== */

    
    /* ===== ì´ë¦„/ì•„ì´ë”” ê²°ì •(3ë‹¨ í´ë°±) ===== */
    let lastStats = null;

    const ss = window.sessionStorage;
    let username = ss.getItem('username') || 'student1';
    let studentDisplayName = username;

    async function resolveIdentity() {
      // 1) ì„¸ì…˜ ìºì‹œ ìš°ì„ 
      try {
        const raw = ss.getItem('studentInfo');
        if (raw) {
          const info = typeof raw === 'string' ? JSON.parse(raw) : raw;
          if (info?.studentId) username = info.studentId;
          if (info?.name)      studentDisplayName = info.name;
        }
      } catch {}

      // 2) whoamië¡œ ë³´ì™„  (â­ name ê³¼ studentName ë‘˜ ë‹¤ í™•ì¸)
      try {
        const r  = await fetch('/api/auth/whoami', { credentials:'include', cache:'no-store' });
        const me = await r.json();
        if (me?.role === 'student') {
          username = me.username || me.uid || username;

          const nm = me.name || me.studentName; // â† ì—¬ê¸° ì¶”ê°€!
          if (nm) studentDisplayName = nm;

          // ë‹¤ìŒ í˜ì´ì§€ì—ì„œë„ ì“°ë„ë¡ ìºì‹±
          ss.setItem('username', username);
          ss.setItem('studentInfo', JSON.stringify({ name: studentDisplayName, studentId: username }));
        }
      } catch {}

      // 3) ê·¸ë˜ë„ ì´ë¦„ì´ ì—†ìœ¼ë©´ í”„ë¡œí•„ë¡œ 1íšŒ ë³´ë£¨
      if (!studentDisplayName || studentDisplayName === username) {
        try {
          const pr = await fetch('/api/student/profile?username=' + encodeURIComponent(username), {
            credentials:'include', cache:'no-store'
          });
          const pj = await pr.json();
          if (pr.ok && pj?.success && pj?.student) {
           const nm = pj.student.name || pj.student.studentName || '';
            if (nm) {
              studentDisplayName = nm;
              ss.setItem('studentInfo', JSON.stringify({ name: nm, studentId: username }));
            }
          }
        } catch {}
      }

      if (!studentDisplayName) studentDisplayName = username; // ìµœì¢… ì•ˆì „ë§
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await resolveIdentity();

      const greet = document.getElementById('greet');
      if (greet) greet.textContent = `${studentDisplayName}ë‹˜, ì•ˆë…•í•˜ì„¸ìš”!`;

      loadCareerInterest();
      await fillMyRosters();
      await loadMyStats();
    });


    /* ===== ë¼ìš°íŒ…/ë¡œê·¸ì•„ì›ƒ ===== */
    function goToInputPage(){ location.href='student.html'; }
    function logout(){ if(confirm('ì •ë§ë¡œ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){ sessionStorage.clear(); location.href='index.html'; } }

    /* ===== ì§„ë¡œ ë©”ëª¨(ë¡œì»¬) ===== */
    function saveCareerInterest(){
      const v = document.getElementById('careerInterest').value.trim();
      localStorage.setItem(`career:${username}`, v);
      const msg = document.getElementById('careerMessage');
      msg.textContent = 'ì €ì¥ë˜ì—ˆì–´ìš”.'; setTimeout(()=>msg.textContent='',2000);
      if (lastStats) updateAIAdvice(lastStats);
    }
    function loadCareerInterest(){
      const v = localStorage.getItem(`career:${username}`) || '';
      const el = document.getElementById('careerInterest'); if (el) el.value = v;
    }

    /* ===== ëª…ë¶€ ëª©ë¡ ë¡œë“œ ===== */
    async function fillMyRosters(){
      const sel = document.getElementById('myRosterSelect');
      sel.innerHTML = '<option value="">ë‚´ ëª…ë¶€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</option>';
      try{
        const r = await fetch('/api/student/list-my-rosters',{credentials:'include'});
        const j = await r.json();
        const rosters = j.rosters || [];
        if (!rosters.length){
          sel.innerHTML = '<option value="">ì†Œì† ëª…ë¶€ê°€ ì—†ìŠµë‹ˆë‹¤</option>'; return;
        }
        sel.innerHTML = rosters.map(r=>{
          const title=(r.title||r.categoryName||'ë¬´ì œ ëª…ë¶€');
          const cnt=(r.itemCount ?? r.studentCount ?? r.count ?? 0);
          return `<option value="${r.id}">${title} (${cnt}ëª…)</option>`;
        }).join('');
      }catch(e){
        console.warn('list-my-rosters ì‹¤íŒ¨', e);
        sel.innerHTML = '<option value="">ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨</option>';
      }
    }

    /* ===== ê¸°ê°„ ê³„ì‚° ===== */
    function getPeriodRange(){
      const type = document.getElementById('periodType').value;
      const now = new Date();
      const shift = m => { const d = new Date(now); d.setMonth(d.getMonth()-m); return d; };
      switch(type){
        case '1month': return { from: shift(1), to: now };
        case '2month': return { from: shift(2), to: now };
        case '3month': return { from: shift(3), to: now };
        case '6month': return { from: shift(6), to: now };
        case 'all':
        default:       return { from: null, to: now };
      }
    }
    const toDateStr = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

    /* ===== í†µê³„ ë¡œë“œ (ëª…ë¶€ë³„) ===== */
    let competencyChart=null, trendChart=null;

    async function loadMyStats(){
      const sel = document.getElementById('myRosterSelect');
      const rosterId = sel.value;
      if (!rosterId){ showNoDataMessage('ëª…ë¶€ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.'); return; }

      const {from, to} = getPeriodRange();
      const url = new URL('/api/student/get-statistics', location.origin);
      url.searchParams.set('rosterId', rosterId);
      if (from) url.searchParams.set('startDate', toDateStr(from));
      if (to)   url.searchParams.set('endDate', toDateStr(to));

      try{
        const r = await fetch(url.toString(), { credentials:'include' });
        const j = await r.json();
        if (!r.ok || j.success===false) throw new Error(j.error || 'í†µê³„ ì¡°íšŒ ì‹¤íŒ¨');

        // j.received: { ì—­ëŸ‰:íšŸìˆ˜ } â€“ ì°¨íŠ¸ëŠ” ë°›ì€ ì¶”ì²œ ê¸°ì¤€ìœ¼ë¡œ í‘œì‹œ
        const competencyCounts = normalizeCompetencyCounts(j.received||{});
        const totalEvaluations = Object.values(competencyCounts).reduce((a,b)=>a+b,0);
        const topCompetency = Object.entries(competencyCounts).sort((a,b)=>b[1]-a[1])[0]?.[1] ? Object.entries(competencyCounts).sort((a,b)=>b[1]-a[1])[0][0] : '-';

        // ì›”ë³„: recent(ìµœëŒ€ 20) ê¸°ì¤€ìœ¼ë¡œ ê°„ë‹¨ ì¶”ì´
        const monthlyData = {};
        (j.recent||[]).forEach(x=>{
          const m = (x.date||'').slice(0,7) || 'ê¸°íƒ€';
          const inc = (monthlyData[m]||0) + (Array.isArray(x.received)?x.received.length:0);
          monthlyData[m] = inc;
        });

        const evaluationDays = new Set((j.recent||[]).map(x=>x.date)).size;

        const stats = { competencyCounts, monthlyData, totalEvaluations, topCompetency, evaluationDays };
        renderStats(stats);
      }catch(e){
        console.warn('student/get-statistics ì‹¤íŒ¨:', e);
        showNoDataMessage('í†µê³„ ë¡œë“œ ì‹¤íŒ¨: ' + (e.message||''));
      }
    }

    function normalizeCompetencyCounts(obj){
      const keys=['ìì‹ ê°ê³¼ ë¦¬ë”ì‹­','ë¶„ì„','ì•„ì´ë””ì–´ ë±…í¬','ê°ì • ì´í•´','ì˜ì‚¬ì†Œí†µ','í˜‘ë™ì‹¬'];
      const out={}; keys.forEach(k=>out[k]=Number(obj[k]||0)); return out;
    }

    /* ===== UI ë Œë”ë§ ===== */
    function renderStats(stats){
      lastStats = stats;
      updateSummaryStats(stats);
      updateCharts(stats);
      updateAIAdvice(stats);
    }
    function updateSummaryStats(stats){
      document.getElementById('totalEvaluations').textContent = stats.totalEvaluations;
      document.getElementById('topCompetency').textContent   = stats.topCompetency;
      document.getElementById('evaluationDays').textContent  = stats.evaluationDays;
    }
    function updateCharts(stats){
      updateCompetencyChart(stats.competencyCounts);
      updateTrendChart(stats.monthlyData);
    }
    function updateCompetencyChart(competencyCounts){
      const ctx = document.getElementById('competencyChart').getContext('2d');
      if (competencyChart) competencyChart.destroy();
      const labels=Object.keys(competencyCounts);
      const data=Object.values(competencyCounts);
      const colors=['#ff6b6b','#4ecdc4','#45b7d1','#f7b731','#5f27cd','#00d2d3'];
      competencyChart = new Chart(ctx,{
        type:'doughnut',
        data:{ labels, datasets:[{ data, backgroundColor:colors, borderWidth:2, borderColor:'#fff' }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom', labels:{ font:{ size:11 }}}}}
      });
    }
    function updateTrendChart(monthlyData){
      const ctx = document.getElementById('trendChart').getContext('2d');
      if (trendChart) trendChart.destroy();
      const months = Object.keys(monthlyData).sort();
      const values = months.map(m=>monthlyData[m]);
      trendChart = new Chart(ctx,{
        type:'line',
        data:{ labels: months.map(m=>m.substring(5)), datasets:[{ label:'ì›”ë³„ ì¶”ì²œ íšŸìˆ˜', data:values, borderColor:'#c77dff', backgroundColor:'rgba(199,125,255,0.1)', borderWidth:3, fill:true, tension:.4 }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false }}, scales:{ y:{ beginAtZero:true }}}
      });
    }

    /* ===== AI ì¡°ì–¸ ===== */
    function buildStatsSummary(stats){
      const lines=[]; const cc=stats.competencyCounts||{};
      const pairs=Object.entries(cc).sort((a,b)=>b[1]-a[1]);
      const top=stats.topCompetency||'-', total=stats.totalEvaluations||0, days=stats.evaluationDays||0;
      lines.push(`ê°€ì¥ ë§ì€ ì¶”ì²œ ì—­ëŸ‰: ${top}`);
      lines.push(`ì´ ì¶”ì²œ ìˆ˜: ${total}, ì°¸ì—¬ ì¼ìˆ˜: ${days}`);
      if (pairs.length){
        const top3 = pairs.slice(0,3).map(([k,v])=>`${k} ${v}íšŒ`).join(', ');
        lines.push(`ìƒìœ„ ì—­ëŸ‰: ${top3}`);
      }
      const months=Object.keys(stats.monthlyData||{}).sort();
      if (months.length>=2){
        const first=months[0], last=months.at(-1);
        const diff=(stats.monthlyData[last]||0)-(stats.monthlyData[first]||0);
        lines.push(`ì²«ë‹¬(${first})â†’ë§ˆì§€ë§‰ë‹¬(${last}) ë³€í™”: ${diff>=0?'+':''}${diff}`);
      }
      return lines.join('\n');
    }

    async function updateAIAdvice(stats){
      const career = (localStorage.getItem(`career:${username}`) || '').trim();
      const summary = buildStatsSummary(stats);
      const box = document.getElementById('aiAdvice');
      box.textContent = 'AI ì¡°ì–¸ ìƒì„± ì¤‘...';

      // whoamiì—ì„œ username/rosterId ë³´ì¡° í™•ë³´(ì—†ìœ¼ë©´ ê¸°ì¡´ ê°’ ì‚¬ìš©)
      let me = {};
      try {
        const r = await fetch('/api/auth/whoami', { credentials:'include', cache:'no-store' });
        me = await r.json();
      } catch {}
      const myUsername = (me && (me.username || me.uid)) || username;
      const rosterIdSel = document.getElementById('myRosterSelect');
      const selectedRosterId =
        (rosterIdSel && rosterIdSel.value) ? rosterIdSel.value : (me && me.rosterId) || null;
    
      try{
        const r = await fetch('/api/ai-advice', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            career,
            statsSummary: summary, // ì‚¬ëŒì´ ì½ê¸° ì‰¬ìš´ ìš”ì•½
            stats,                 // ì›ë³¸ ìˆ«ì ë°ì´í„°(ëª¨ë¸ì´ í‘œ ì°¸ê³  ê°€ëŠ¥)
            username: myUsername,  // ë‚´ í•™ë²ˆ/ì•„ì´ë””
            rosterId: selectedRosterId,
            studentName: studentDisplayName
            // í•„ìš” ì‹œ reasons/activitiesë„ ì—¬ê¸°ì— ì¶”ê°€í•´ì„œ ë³´ë‚¼ ìˆ˜ ìˆì–´ìš”.
          })
        });
        const j = await r.json();

        if (!r.ok || !j?.success) {
          console.warn('[ai-advice] server error:', j?.error || r.status);
          throw new Error(j?.error || 'AI ì‹¤íŒ¨');
        }

        // âœ… ë” ì´ìƒ 5ì¤„ë¡œ ìë¥´ì§€ ì•ŠìŒ. ê·¸ëŒ€ë¡œ ë…¸ì¶œ
        box.textContent = (j.advice || '').trim();

      } catch (e) {
        console.warn('AI ì¡°ì–¸ ì‹¤íŒ¨, ë¡œì»¬ ê·œì¹™ìœ¼ë¡œ ëŒ€ì²´:', e?.message || e);

        // âœ… í´ë°±ë„ ë‹¤ì •í•œ í†¤ìœ¼ë¡œ
        let advice = '';
        if ((stats.totalEvaluations || 0) === 0) {
          advice = [
            'ì•„ì§ ë°›ì€ í‰ê°€ê°€ ë§ì§€ ì•Šì•„ìš”. ê·¸ë˜ë„ ì§€ê¸ˆê¹Œì§€ì˜ ì‹œë„, ì •ë§ ì˜í•˜ê³  ìˆì–´ìš”! ğŸ˜Š',
            'ì´ë²ˆ ì£¼ì—ëŠ” ìˆ˜ì—…/í™œë™ì— í•œ ë²ˆ ë” ì°¸ì—¬í•´ ë³´ë©° ì‘ì€ ê²½í—˜ì„ í•˜ë‚˜ ë” ìŒ“ì•„ë³¼ê¹Œìš”?',
            'í•˜ë£¨ê°€ ëë‚  ë•Œ â€œì˜í•œ ì  1ê°€ì§€, ë‹¤ìŒì— ë” í•´ë³´ê³  ì‹¶ì€ ì  1ê°€ì§€â€ë¥¼ ê°„ë‹¨íˆ ì ì–´ë³´ë©´ ì¢‹ì•„ìš”.',
          ].join('\n');
        } else {
          const top = stats.topCompetency || '-';
          advice = [
            `ìš”ì•½ì„ ë³´ë‹ˆ "${top}" ê°•ì ì´ íŠ¹íˆ ì˜ ë“œëŸ¬ë‚˜ê³  ìˆì–´ìš”. ë©‹ì ¸ìš”!`,
            career
              ? `ê´€ì‹¬ ë¶„ì•¼ì¸ ${career}ì™€ ì—°ê²°í•´ ê°•ì ì„ ì¡°ê¸ˆì”© í™•ì¥í•´ ë³´ë©´ ì¢‹ê² ì–´ìš”.`
              : 'ê´€ì‹¬ ì§„ë¡œë¥¼ ì…ë ¥í•´ ì£¼ë©´ ë” ë”± ë§ëŠ” ì œì•ˆì„ ë“œë¦´ ìˆ˜ ìˆì–´ìš”.',
            'ì´ë²ˆ ì£¼ì—ëŠ” ê°•ì ì´ ë“œëŸ¬ë‚˜ëŠ” í™œë™ì„ í•˜ë‚˜ ì •í•´ ê°€ë³ê²Œ ì‹œë„í•´ë³´ë©´ ì–´ë–¨ê¹Œìš”?',
            'ê·¸ë¦¬ê³  í™œë™ í›„ì—ëŠ” 1ë¬¸ì¥ìœ¼ë¡œ ì§§ê²Œ íšŒê³ ë¥¼ ë‚¨ê²¨ ë³´ì„¸ìš”. ì‘ì€ ê¸°ë¡ì´ í° ë³€í™”ë¥¼ ë§Œë“­ë‹ˆë‹¤.',
          ].join('\n');
        }

        // âœ… í´ë°±ë„ ìë¥´ì§€ ì•ŠìŒ
        box.textContent = advice.trim();
      }
    }

    /* ===== ë°ì´í„° ì—†ìŒ ===== */
    function showNoDataMessage(msg){
      document.getElementById('totalEvaluations').textContent='0';
      document.getElementById('topCompetency').textContent='-';
      document.getElementById('evaluationDays').textContent='0';
      document.getElementById('aiAdvice').textContent= msg || 'ì•„ì§ í‰ê°€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì…ë ¥ í˜ì´ì§€ì—ì„œ í‰ê°€ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”!';
      if (competencyChart){ competencyChart.destroy(); competencyChart=null; }
      if (trendChart){ trendChart.destroy(); trendChart=null; }
    }
  </script>
</body>
</html>







